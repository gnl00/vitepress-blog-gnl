<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JUC | Gnl</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/assets/style.192b8fa9.css" as="style">
    
    <script type="module" src="/assets/app.ba26e238.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.834b76fb.js">
    <link rel="modulepreload" href="/assets/chunks/theme.759f3966.js">
    <link rel="modulepreload" href="/assets/posts_be_java_java-juc_Java-JUC.md.13e136cd.lean.js">
    <link rel="icon" href="./img/logo.jpeg">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="./logo.jpeg" alt data-v-8426fc1a><!--]--><!--[-->Gnl<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/recently" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Recently</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="posts/al/index/" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>算法</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>前端</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/javascript/JavaScript" data-v-43f1e123><!--[-->JavaScript<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/vuejs/Vuejs" data-v-43f1e123><!--[-->Vue.js<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/react/React" data-v-43f1e123><!--[-->React<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/typescript/TypeScript" data-v-43f1e123><!--[-->TypeScript<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>后端</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/java/index/Java" data-v-43f1e123><!--[-->Java<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/spring/Spring5" data-v-43f1e123><!--[-->Spring5<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springmvc/SpringMVC" data-v-43f1e123><!--[-->Spring MVC<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springboot/SpringBoot" data-v-43f1e123><!--[-->Spring Boot<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springsecurity/SpringSecurity" data-v-43f1e123><!--[-->Spring Security<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springcloud/SpringCloud" data-v-43f1e123><!--[-->Spring Cloud<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/mybatis/MyBatis" data-v-43f1e123><!--[-->MyBatis<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>数据库</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/db/mysql/MySQL" data-v-43f1e123><!--[-->MySQL<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/db/redis/Redis" data-v-43f1e123><!--[-->Redis<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>中间件</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/rocketmq/RocketMQ" data-v-43f1e123><!--[-->RocketMQ<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/elasticsearch/Elasticsearch" data-v-43f1e123><!--[-->Elasticsearch<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/kafka/Kafka" data-v-43f1e123><!--[-->Kafka<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/nginx/Nginx" data-v-43f1e123><!--[-->Nginx<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>算法</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/%E4%BD%8D%E8%BF%90%E7%AE%97" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>位运算</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>常见算法</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>设计模式</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/dp/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/dp/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>设计模式</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>前端</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/javascript/JavaScript" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JavaScript</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/vuejs/Vuejs" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Vue.js</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/react/React" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>React</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/typescript/TypeScript" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>TypeScript</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>后端</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible is-link has-active" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/index/Java" data-v-e31bd47b><!--[--><h3 class="text" data-v-e31bd47b>Java</h3><!--]--></a><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-basic/Java-%E5%9F%BA%E7%A1%80" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-collection/Java-%E9%9B%86%E5%90%88" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 集合</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-thread/Java-%E5%A4%9A%E7%BA%BF%E7%A8%8B" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 多线程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-threadpool/Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 线程池</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-juc/Java-JUC" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java JUC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/io/Java-IO" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java IO</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-advance/Java-%E8%BF%9B%E9%98%B6" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 进阶</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/jvm/JVM" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JVM</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/spring/Spring5" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring5</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springmvc/SpringMVC" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring MVC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springboot/SpringBoot" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Boot</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springsecurity/SpringSecurity" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Security</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springcloud/SpringCloud" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Cloud</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/mybatis/MyBatis" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MyBatis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>数据库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/mysql/MySQL" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySQL</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/redis/Redis" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Redis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>中间件</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/rocketmq/RocketMQ" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>RocketMQ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/elasticsearch/Elasticsearch" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Elasticsearch</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/kafka/Kafka" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Kafka</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/nginx/Nginx" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Nginx</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _posts_be_java_java-juc_Java-JUC" data-v-6b87e69f><div><h1 id="juc" tabindex="-1">JUC <a class="header-anchor" href="#juc" aria-label="Permalink to &quot;JUC&quot;">​</a></h1><blockquote><p>JUC 指的是 <code>java.util.concurrent</code> 包及其子包下用于并发场景的类</p></blockquote><h2 id="locks" tabindex="-1">Locks <a class="header-anchor" href="#locks" aria-label="Permalink to &quot;Locks&quot;">​</a></h2><h3 id="abstractownablesynchronizer" tabindex="-1">AbstractOwnableSynchronizer <a class="header-anchor" href="#abstractownablesynchronizer" aria-label="Permalink to &quot;AbstractOwnableSynchronizer&quot;">​</a></h3><blockquote><p>一个可以让线程独占的同步器，为锁和相关同步器的创建提供了一个基础的概念</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AbstractOwnableSynchronizer</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AbstractOwnableSynchronizer</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>内部属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// The current owner of exclusive mode synchronization.</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transient</span><span style="color:#E1E4E8;"> Thread exclusiveOwnerThread;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * A null argument indicates that no thread owns access. This method does not otherwise </span></span>
<span class="line"><span style="color:#6A737D;"> * impose any synchronization or volatile field accesses.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(Thread thread) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    exclusiveOwnerThread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> thread; </span><span style="color:#6A737D;">// 设置 null 值表示当前没有线程有访问权</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// The current owner of exclusive mode synchronization.</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transient</span><span style="color:#24292E;"> Thread exclusiveOwnerThread;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * A null argument indicates that no thread owns access. This method does not otherwise </span></span>
<span class="line"><span style="color:#6A737D;"> * impose any synchronization or volatile field accesses.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(Thread thread) {</span></span>
<span class="line"><span style="color:#24292E;">    exclusiveOwnerThread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> thread; </span><span style="color:#6A737D;">// 设置 null 值表示当前没有线程有访问权</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><br><h3 id="abstractqueuedsynchronizer" tabindex="-1">AbstractQueuedSynchronizer <a class="header-anchor" href="#abstractqueuedsynchronizer" aria-label="Permalink to &quot;AbstractQueuedSynchronizer&quot;">​</a></h3><blockquote><p>提供一个基本框架，用于实现阻塞锁（依靠 FIFO 等待队列）和相关同步器（信号量、事件等）。此类是大多数依靠单一原子 int 值来表示状态的同步器的基础，它定义了一些实现同步机制需要使用的方法，提供给具体的锁和相关的同步器使用。</p></blockquote><blockquote><p><strong>子类与实现类</strong></p><ul><li>子类必须定义用来修改同步机制状态 state 的 protected 方法，如同步锁资源被获取和释放时修改 state 的 acquire 和 release 方法。同时也要定义获取不到锁资源时用于排队的方法和实现阻塞机制的方法</li><li>子类还可以维护除了 state 之外的其他变量，但是只有使用 getState/setState 和 compareAndSetState 方法更新 state 值才会被当作同步机制的实现逻辑，进行同步状态跟踪</li><li>子类应该定义为非公开的内部辅助类，用于实现其封闭父类类的同步属性</li></ul></blockquote><blockquote><p><strong>锁的两种模式</strong></p><p>AbstractQueuedSynchronizer 同时支持独占和共享模式，在不同模式下排队的线程使用的都是同一个 FIFO 队列。通常来说子类可以只实现两种模式中的一种，这种情况下，未实现的模式的方法不需要实现；子类也可以同时支持两种模式，如 ReadWriteLock。</p><p>可以使用 isHeldExclusively 方法来检查当前线程是否独占有锁资源</p></blockquote><blockquote><p><strong>Condition</strong></p><p>ConditionObject 是 AbstractQueuedSynchronizer 的内部类，ConditionObject 实现了 Condition 接口，可以作为独占模式下锁资源获取与释放的条件来使用。</p><p>可以使用 getState 获取到的 state 作为参数，根据 Condition 条件调用 release/acquire 方法释放或者重入锁资源</p></blockquote><blockquote><p><strong>序列化与反序列化</strong></p><p>对 AbstractQueuedSynchronizer 进行序列化操作会把 state 设置为 0，即无锁模式，线程等待队列不会进行序列化。需要自定义 readObject 方法，反序列化时将 state 和 等待队列恢复</p></blockquote><blockquote><p><strong>自定义同步器</strong></p><p>如果想要实现自定义同步机制，需使用 getState/setState/compareAndSetState 方法来重新定义以下几个方法的逻辑</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><p>这几个方法是 AbstractQueuedSynchronizer 中的模版方法，默认抛出 UnsupportedOperationException 异常。</p><p>自定义实现时要求必须是内部线程安全的，并且调用流程应该是短暂，不阻塞的。重写这几个方法是使用 AbstractQueuedSynchronizer 的唯一方法，因为除此之外的其他方法基本上都是 final 声明的，不可被重写。</p></blockquote><blockquote><p><strong>公平与非公平</strong></p><ul><li>虽然 AbstractQueuedSynchronizer 同步机制的实现依赖于内部的 FIFO 队列，但它并不强制使用 FIFO 来获取锁资源</li><li>子类的实现为公平锁时，需要严格按照 FIFO 队列的要求来实现同步机制；子类的实现为非公平锁时，不需要按照 FIFO 要求实现同步机制。因为在获取锁资源时会先进行检查，所以非公平模式下， 新获取的线程可能会在其他被阻塞和排队的线程之前获取到锁</li><li>默认情况下（非公平模式），允许线程之间进行锁资源的争夺，此时吞吐量和可扩展性比较高。因为没获取到锁的线程会先进行自旋，并在自旋中尝试获取锁，自旋获取失败才会进入阻塞队列等待</li></ul></blockquote><h4 id="内部类" tabindex="-1">内部类 <a class="header-anchor" href="#内部类" aria-label="Permalink to &quot;内部类&quot;">​</a></h4><h5 id="node" tabindex="-1">Node <a class="header-anchor" href="#node" aria-label="Permalink to &quot;Node&quot;">​</a></h5><blockquote><p>等待队列的 Node 结点，等待队列是 CLH（(Craig, Landin, and Hagersten) ） 锁队列的一个变种。CLH 队列通常用于实现自旋锁，在 AQS 中使用 CLH 队列来实现阻塞同步器，将线程的控制信息保存在其前驱结点中。</p><p>每个线程中都有一个 status 字段，用来记录该线程是否应该阻塞（仅用作记录，不用做控制锁状态）。当前驱结点释放锁资源时，等待队列中阻塞的结点就会收到信号。等待队列中的第一个线程不能保证一定会获取到锁资源，只能保证它具有竞争锁的权利，如果获取失败会继续等待。</p></blockquote><blockquote><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">        +------+  prev +-----+       +-----+</span></span>
<span class="line"><span style="color:#e1e4e8;">  head |      | &lt;---- |     | &lt;---- |     |  tail</span></span>
<span class="line"><span style="color:#e1e4e8;">        +------+       +-----+       +-----+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">        +------+  prev +-----+       +-----+</span></span>
<span class="line"><span style="color:#24292e;">  head |      | &lt;---- |     | &lt;---- |     |  tail</span></span>
<span class="line"><span style="color:#24292e;">        +------+       +-----+       +-----+</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p>线程入队阻塞队列仅需要使用原子操作将线程结点插入等待队列的尾部，线程出队只需要将获取到锁资源的线程设置为头结点即可。耗时的操作是确定后继结点，可能会出现超时或者中断的情况</p></li><li><p>CHL 队列中的 prev 指针主要用作取消操作，如果一个线程结点被取消了，它的后继会重新指向前驱结点没被取消的前驱</p></li><li><p>除了 prev 还有一个 next 指针指向后继结点，获取到资源的线程释放时，会通过 next 通知后继的结点进行争夺</p></li></ul></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Node</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Node</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部属性</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Marker to indicate a node is waiting in shared mode</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Node SHARED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Node</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#6A737D;">// Marker to indicate a node is waiting in exclusive mode</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Node EXCLUSIVE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * statue 字段，有以下几种取值 </span></span>
<span class="line"><span style="color:#6A737D;"> * SIGNAL</span></span>
<span class="line"><span style="color:#6A737D;"> * CANCELLED</span></span>
<span class="line"><span style="color:#6A737D;"> * CONDITION</span></span>
<span class="line"><span style="color:#6A737D;"> * PROPAGATE</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 普通同步机制下默认值是 0，如果使用 condition 则默认值是 CONDITION = -2</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> waitStatus; </span><span style="color:#6A737D;">// </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// waitStatus 属性的取值有以下情况 waitStatus value to indicate that</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> CANCELLED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// thread has cancelled due to timeout or interrupt, a thread with cancelled node never again blocks</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> SIGNAL    </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// successor&#39;s thread needs unparking</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> CONDITION </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// thread is waiting on condition</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// the next acquireShared should unconditionally propagate</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Marker to indicate a node is waiting in shared mode</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Node SHARED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Node</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#6A737D;">// Marker to indicate a node is waiting in exclusive mode</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Node EXCLUSIVE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * statue 字段，有以下几种取值 </span></span>
<span class="line"><span style="color:#6A737D;"> * SIGNAL</span></span>
<span class="line"><span style="color:#6A737D;"> * CANCELLED</span></span>
<span class="line"><span style="color:#6A737D;"> * CONDITION</span></span>
<span class="line"><span style="color:#6A737D;"> * PROPAGATE</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 普通同步机制下默认值是 0，如果使用 condition 则默认值是 CONDITION = -2</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> waitStatus; </span><span style="color:#6A737D;">// </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// waitStatus 属性的取值有以下情况 waitStatus value to indicate that</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> CANCELLED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// thread has cancelled due to timeout or interrupt, a thread with cancelled node never again blocks</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> SIGNAL    </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// successor&#39;s thread needs unparking</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> CONDITION </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// thread is waiting on condition</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// the next acquireShared should unconditionally propagate</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><br><h5 id="conditionobject" tabindex="-1">ConditionObject <a class="header-anchor" href="#conditionobject" aria-label="Permalink to &quot;ConditionObject&quot;">​</a></h5><blockquote><p>Condition implementation for a AbstractQueuedSynchronizer serving as the basis of a Lock implementation.</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConditionObject</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Condition</span><span style="color:#E1E4E8;">, java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConditionObject</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Condition</span><span style="color:#24292E;">, java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ConditionObject 内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 实现条件中断等待</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、阻塞当前线程，如果当前线程已中断，抛出 InterruptedException</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、保存 getState 获取到的 state</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、将保存的 state 传入 release 方法并执行</span></span>
<span class="line"><span style="color:#6A737D;"> * 4、阻塞直到被唤醒或者中断</span></span>
<span class="line"><span style="color:#6A737D;"> * 5、使用保存的调用指定的 acquire 方法重新获取锁资源</span></span>
<span class="line"><span style="color:#6A737D;"> * 6、如果在第四步时已中断，抛出 InterruptedException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">() throws InterruptedException {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 将等待时间最长的线程（如果存在的话）从这个条件的等待队列移到拥有锁的等待队列中</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">signal</span><span style="color:#E1E4E8;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 将所有线程从这个条件的等待队列移到拥有锁的等待队列中</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">signalAll</span><span style="color:#E1E4E8;">() {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 实现条件中断等待</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、阻塞当前线程，如果当前线程已中断，抛出 InterruptedException</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、保存 getState 获取到的 state</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、将保存的 state 传入 release 方法并执行</span></span>
<span class="line"><span style="color:#6A737D;"> * 4、阻塞直到被唤醒或者中断</span></span>
<span class="line"><span style="color:#6A737D;"> * 5、使用保存的调用指定的 acquire 方法重新获取锁资源</span></span>
<span class="line"><span style="color:#6A737D;"> * 6、如果在第四步时已中断，抛出 InterruptedException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">() throws InterruptedException {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 将等待时间最长的线程（如果存在的话）从这个条件的等待队列移到拥有锁的等待队列中</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">signal</span><span style="color:#24292E;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 将所有线程从这个条件的等待队列移到拥有锁的等待队列中</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">signalAll</span><span style="color:#24292E;">() {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><br><h4 id="内部属性" tabindex="-1">内部属性 <a class="header-anchor" href="#内部属性" aria-label="Permalink to &quot;内部属性&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> state; </span><span style="color:#6A737D;">// 同步机制的状态</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 等待队列的头结点，懒加载。除了初始化方法，只有 setHead 方法可以修改头结点。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果头结点存在，waitStatus 保证不会被设置为 CANCELLED</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> Node head;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 等待队列的尾结点，懒加载</span></span>
<span class="line"><span style="color:#6A737D;">// 仅可以通过 enq 方法将新结点追加到尾结点后</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> Node tail;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 自旋和 park 判定的阈值</span></span>
<span class="line"><span style="color:#6A737D;">// The number of times a thread will spin before it gives up and waits for a timeout</span></span>
<span class="line"><span style="color:#6A737D;">// This is useful for avoiding deadlocks, as it ensures that threads will eventually give up and allow other threads to progress.</span></span>
<span class="line"><span style="color:#6A737D;">// This means that a thread will spin 1000 times before it gives up and waits for a timeout. If the thread is still unable to acquire the lock after 1000 spins, it will throw a TimeoutException.</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> spinForTimeoutThreshold </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 作为 CAS 操作的支持，虽然使用 AtomicInteger 原子类能获得同样的效果并且可能会达到更好的效果，但是</span></span>
<span class="line"><span style="color:#6A737D;"> * 为了未来的延展性，使用 Unsafe 即可。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Unsafe unsafe </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Unsafe.</span><span style="color:#B392F0;">getUnsafe</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stateOffset;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> headOffset;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> tailOffset;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> waitStatusOffset;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> nextOffset;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 与多线程相关属性的获取通常会使用 unsafe.objectFieldOffset 方法，因为多线程环境下，想要访问或者修</span></span>
<span class="line"><span style="color:#6A737D;"> * 改对象的属性值通常需要加锁来保证线程安全，而 unsafe.objectFieldOffset 方法可以直接获取某个属性值</span></span>
<span class="line"><span style="color:#6A737D;"> * 在内存上的偏移量，避免了对对象的加锁操作，可以提高程序的性能。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stateOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        headOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;head&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        tailOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;tail&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        waitStatusOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (Node.class.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;waitStatus&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        nextOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (Node.class.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;next&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Exception </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) { </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(ex); }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> state; </span><span style="color:#6A737D;">// 同步机制的状态</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 等待队列的头结点，懒加载。除了初始化方法，只有 setHead 方法可以修改头结点。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果头结点存在，waitStatus 保证不会被设置为 CANCELLED</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> Node head;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 等待队列的尾结点，懒加载</span></span>
<span class="line"><span style="color:#6A737D;">// 仅可以通过 enq 方法将新结点追加到尾结点后</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> Node tail;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 自旋和 park 判定的阈值</span></span>
<span class="line"><span style="color:#6A737D;">// The number of times a thread will spin before it gives up and waits for a timeout</span></span>
<span class="line"><span style="color:#6A737D;">// This is useful for avoiding deadlocks, as it ensures that threads will eventually give up and allow other threads to progress.</span></span>
<span class="line"><span style="color:#6A737D;">// This means that a thread will spin 1000 times before it gives up and waits for a timeout. If the thread is still unable to acquire the lock after 1000 spins, it will throw a TimeoutException.</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> spinForTimeoutThreshold </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000L</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 作为 CAS 操作的支持，虽然使用 AtomicInteger 原子类能获得同样的效果并且可能会达到更好的效果，但是</span></span>
<span class="line"><span style="color:#6A737D;"> * 为了未来的延展性，使用 Unsafe 即可。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Unsafe unsafe </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Unsafe.</span><span style="color:#6F42C1;">getUnsafe</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stateOffset;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> headOffset;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> tailOffset;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> waitStatusOffset;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> nextOffset;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 与多线程相关属性的获取通常会使用 unsafe.objectFieldOffset 方法，因为多线程环境下，想要访问或者修</span></span>
<span class="line"><span style="color:#6A737D;"> * 改对象的属性值通常需要加锁来保证线程安全，而 unsafe.objectFieldOffset 方法可以直接获取某个属性值</span></span>
<span class="line"><span style="color:#6A737D;"> * 在内存上的偏移量，避免了对对象的加锁操作，可以提高程序的性能。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        stateOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        headOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;head&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        tailOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (AbstractQueuedSynchronizer.class.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;tail&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        waitStatusOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (Node.class.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;waitStatus&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        nextOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (Node.class.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;next&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) { </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(ex); }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="内部方法" tabindex="-1">内部方法 <a class="header-anchor" href="#内部方法" aria-label="Permalink to &quot;内部方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 如果当前 state 的值和期望值相等，使用原子操作更新 state</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> expect, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> update) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> unsafe.</span><span style="color:#B392F0;">compareAndSwapInt</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, stateOffset, expect, update);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Inserts node into queue, initializing if necessary</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> Node </span><span style="color:#B392F0;">enq</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Node node) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Creates and enqueues node for current thread and given mode.</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> Node </span><span style="color:#B392F0;">addWaiter</span><span style="color:#E1E4E8;">(Node mode) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取独占锁</span></span>
<span class="line"><span style="color:#6A737D;">// 实现中至少调用一次 tryRelease 方法</span></span>
<span class="line"><span style="color:#6A737D;">// This method can be used to implement method Lock.lock.</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(arg) </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 尝试获取</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acquireQueued</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">addWaiter</span><span style="color:#E1E4E8;">(Node.EXCLUSIVE), arg)) </span><span style="color:#6A737D;">// 获取失败则入队自旋执行 tryAcquire</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">selfInterrupt</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 在队列中自旋获取失败则将线程中断</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 释放独占锁，会忽视线程是否已中断</span></span>
<span class="line"><span style="color:#6A737D;">// This method can be used to implement method Lock.unlock.</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(arg)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Node h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> head;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.waitStatus </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">unparkSuccessor</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires in shared mode, ignoring interrupts.</span></span>
<span class="line"><span style="color:#6A737D;">// 逻辑和 acquire 相似</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(arg) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">doAcquireShared</span><span style="color:#E1E4E8;">(arg);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 如果当前 state 的值和期望值相等，使用原子操作更新 state</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> expect, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> update) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> unsafe.</span><span style="color:#6F42C1;">compareAndSwapInt</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, stateOffset, expect, update);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Inserts node into queue, initializing if necessary</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> Node </span><span style="color:#6F42C1;">enq</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Node node) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Creates and enqueues node for current thread and given mode.</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> Node </span><span style="color:#6F42C1;">addWaiter</span><span style="color:#24292E;">(Node mode) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取独占锁</span></span>
<span class="line"><span style="color:#6A737D;">// 实现中至少调用一次 tryRelease 方法</span></span>
<span class="line"><span style="color:#6A737D;">// This method can be used to implement method Lock.lock.</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(arg) </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 尝试获取</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acquireQueued</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">addWaiter</span><span style="color:#24292E;">(Node.EXCLUSIVE), arg)) </span><span style="color:#6A737D;">// 获取失败则入队自旋执行 tryAcquire</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">selfInterrupt</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 在队列中自旋获取失败则将线程中断</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 释放独占锁，会忽视线程是否已中断</span></span>
<span class="line"><span style="color:#6A737D;">// This method can be used to implement method Lock.unlock.</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(arg)) {</span></span>
<span class="line"><span style="color:#24292E;">        Node h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> head;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.waitStatus </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">unparkSuccessor</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires in shared mode, ignoring interrupts.</span></span>
<span class="line"><span style="color:#6A737D;">// 逻辑和 acquire 相似</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(arg) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">doAcquireShared</span><span style="color:#24292E;">(arg);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="模版方法" tabindex="-1">模版方法 <a class="header-anchor" href="#模版方法" aria-label="Permalink to &quot;模版方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取独占锁，会查询当前 state 是否支持独占模式，如果支持则尝试获取</span></span>
<span class="line"><span style="color:#6A737D;"> * 始终会被当前执行的线程调用，如果获取失败，当前线程可能会进入等待队列。如果未入队，会一直阻塞知道有其</span></span>
<span class="line"><span style="color:#6A737D;"> * 他线程唤醒</span></span>
<span class="line"><span style="color:#6A737D;"> * 可以用来实现 Lock.tryLock() 方法，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放独占锁，始终会被当前执行的线程调用，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取共享锁，会查询当前 state 是否支持共享模式，如果支持则尝试获取</span></span>
<span class="line"><span style="color:#6A737D;"> * 始终会被当前执行的线程调用，如果获取失败，当前线程可能会进入等待队列。如果未入队，会一直阻塞知道有其</span></span>
<span class="line"><span style="color:#6A737D;"> * 他线程唤醒</span></span>
<span class="line"><span style="color:#6A737D;"> * 默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放共享锁，始终会被当前执行的线程调用，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReleaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查当前是独占还是共享模式</span></span>
<span class="line"><span style="color:#6A737D;">// 仅被 AbstractQueuedSynchronizer.ConditionObject 中的方法调用，如果不用 Condition 则无需实现</span></span>
<span class="line"><span style="color:#6A737D;">// 默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isHeldExclusively</span><span style="color:#E1E4E8;">() {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取独占锁，会查询当前 state 是否支持独占模式，如果支持则尝试获取</span></span>
<span class="line"><span style="color:#6A737D;"> * 始终会被当前执行的线程调用，如果获取失败，当前线程可能会进入等待队列。如果未入队，会一直阻塞知道有其</span></span>
<span class="line"><span style="color:#6A737D;"> * 他线程唤醒</span></span>
<span class="line"><span style="color:#6A737D;"> * 可以用来实现 Lock.tryLock() 方法，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放独占锁，始终会被当前执行的线程调用，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取共享锁，会查询当前 state 是否支持共享模式，如果支持则尝试获取</span></span>
<span class="line"><span style="color:#6A737D;"> * 始终会被当前执行的线程调用，如果获取失败，当前线程可能会进入等待队列。如果未入队，会一直阻塞知道有其</span></span>
<span class="line"><span style="color:#6A737D;"> * 他线程唤醒</span></span>
<span class="line"><span style="color:#6A737D;"> * 默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放共享锁，始终会被当前执行的线程调用，默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReleaseShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查当前是独占还是共享模式</span></span>
<span class="line"><span style="color:#6A737D;">// 仅被 AbstractQueuedSynchronizer.ConditionObject 中的方法调用，如果不用 Condition 则无需实现</span></span>
<span class="line"><span style="color:#6A737D;">// 默认实现抛出 UnsupportedOperationException</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isHeldExclusively</span><span style="color:#24292E;">() {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><br><h3 id="condition" tabindex="-1">Condition <a class="header-anchor" href="#condition" aria-label="Permalink to &quot;Condition&quot;">​</a></h3><blockquote><p>一个 Condition 实例与一个锁绑定，要为一个特定的锁实例获得 Condition 实例，使用对应的 newCondition方法</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Condition</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Condition</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内置方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Causes the current thread to wait until it is signalled or interrupted.</span></span>
<span class="line"><span style="color:#6A737D;"> * The lock associated with this Condition is atomically released.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread invokes the signal method for this Condition and the current thread happens to be chosen as the thread to be awakened</span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread invokes the signalAll method for this Condition</span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread interrupts the current thread, and interruption of thread suspension is supported</span></span>
<span class="line"><span style="color:#6A737D;"> * A &quot;spurious wakeup&quot; occurs</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">() throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Wakes up one waiting thread.</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">signal</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Wakes up all waiting threads.</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">signalAll</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Causes the current thread to wait until it is signalled or interrupted.</span></span>
<span class="line"><span style="color:#6A737D;"> * The lock associated with this Condition is atomically released.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread invokes the signal method for this Condition and the current thread happens to be chosen as the thread to be awakened</span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread invokes the signalAll method for this Condition</span></span>
<span class="line"><span style="color:#6A737D;"> * Some other thread interrupts the current thread, and interruption of thread suspension is supported</span></span>
<span class="line"><span style="color:#6A737D;"> * A &quot;spurious wakeup&quot; occurs</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">() throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Wakes up one waiting thread.</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">signal</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Wakes up all waiting threads.</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">signalAll</span><span style="color:#24292E;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><br><h3 id="lock" tabindex="-1">Lock <a class="header-anchor" href="#lock" aria-label="Permalink to &quot;Lock&quot;">​</a></h3><blockquote><p>Lock 的实现类提供了比 synchronized 方法和 synchronized 块更具扩展性的锁操作。允许更灵活的结构，可能有不同的属性，可能支持多个相关的 Condition 对象。</p><p>锁是一种用于控制多个线程对共享资源的访问的工具。通常，锁提供对共享资源的排他性访问：一次只有一个线程可以获得锁，对共享资源的访问需要先获得锁。但也有些锁允许对共享资源的并发访问，例如 ReadWriteLock 的读锁。</p></blockquote><blockquote><p>使用 synchronized 方法或 synchronized 代码块可以获取与每个对象相关的隐式监控锁，但锁的获取和释放操作都必须在 synchronized 块内进行。当获取多个锁时，它们必须以相反的顺序释放，并且所有锁必须在获取它们的同一词法范围内释放。</p><p>虽然 synchronized 方法和语句的范围机制使得监控锁编程的使用变得更加容易，并有助于避免许多涉及锁的常见编程错误，但在某些场合，需要以更灵活的方式使用锁。Lock 接口的实现允许在不同的范围内获取和释放一个锁，并允许以任何顺序获取和释放多个锁。</p><p>灵活性的增加，也带来了额外的负担。没有 synchronized 块状结构的约束，就没有 synchronized 方法和 synchronized 块自动释放锁的情况。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> Lock l </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ...;  </span></span>
<span class="line"><span style="color:#E1E4E8;"> l.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">// access the resource protected by this lock  </span></span>
<span class="line"><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;"> 	l.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();  </span><span style="color:#6A737D;">// 因此需要注意手动释放锁资源</span></span>
<span class="line"><span style="color:#E1E4E8;"> }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> Lock l </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ...;  </span></span>
<span class="line"><span style="color:#24292E;"> l.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">// access the resource protected by this lock  </span></span>
<span class="line"><span style="color:#24292E;"> } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;"> 	l.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();  </span><span style="color:#6A737D;">// 因此需要注意手动释放锁资源</span></span>
<span class="line"><span style="color:#24292E;"> }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Lock 的实现提供了比使用同步方法和语句更多的功能，它提供了获取锁的非阻塞尝试 tryLock，获取可以中断的锁的尝试 lockInterruptibly，以及获取可以超时的锁的尝试 tryLock(long, TimeUnit)</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内置方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Acquires the lock. 如果未获取成功则阻塞直到获取到锁</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock unless the current thread is interrupted.</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lockInterruptibly</span><span style="color:#E1E4E8;">() throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock only if it is free at the time of invocation.</span></span>
<span class="line"><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock if it is free within the given waiting time and the current thread </span></span>
<span class="line"><span style="color:#6A737D;">// has not been interrupted.</span></span>
<span class="line"><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> time, TimeUnit unit) throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Releases the lock.</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns a new Condition instance that is bound to this Lock instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Acquires the lock. 如果未获取成功则阻塞直到获取到锁</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock unless the current thread is interrupted.</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lockInterruptibly</span><span style="color:#24292E;">() throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock only if it is free at the time of invocation.</span></span>
<span class="line"><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock if it is free within the given waiting time and the current thread </span></span>
<span class="line"><span style="color:#6A737D;">// has not been interrupted.</span></span>
<span class="line"><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> time, TimeUnit unit) throws InterruptedException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Releases the lock.</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns a new Condition instance that is bound to this Lock instance.</span></span>
<span class="line"><span style="color:#24292E;">Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><br><h3 id="locksupport" tabindex="-1">LockSupport <a class="header-anchor" href="#locksupport" aria-label="Permalink to &quot;LockSupport&quot;">​</a></h3><blockquote><p>用于创建锁和其他同步类的基本线程阻塞原语，底层基于 sun.misc.Unsafe 类的 park 和 unpark 方法。 该类与使用它的每个线程相关联，调用 park 方法会阻塞线程；调用 unpark 方法会让线程恢复。</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">LockSupport</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">LockSupport</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><br><p><strong>内部属性</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Unsafe 类辅助实现 park 和 unpark</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> sun.misc.Unsafe UNSAFE;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Unsafe 类辅助实现 park 和 unpark</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> sun.misc.Unsafe UNSAFE;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br><p><strong>内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 阻塞当前线程</span></span>
<span class="line"><span style="color:#6A737D;">// 调用当前当前线程的 unpark 恢复</span></span>
<span class="line"><span style="color:#6A737D;">// 或线程被中断</span></span>
<span class="line"><span style="color:#6A737D;">// 或线程被虚假唤醒</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">park</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    UNSAFE.</span><span style="color:#B392F0;">park</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 恢复指定线程</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(Thread thread) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (thread </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        UNSAFE.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(thread);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 阻塞当前线程</span></span>
<span class="line"><span style="color:#6A737D;">// 调用当前当前线程的 unpark 恢复</span></span>
<span class="line"><span style="color:#6A737D;">// 或线程被中断</span></span>
<span class="line"><span style="color:#6A737D;">// 或线程被虚假唤醒</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">park</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    UNSAFE.</span><span style="color:#6F42C1;">park</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 恢复指定线程</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(Thread thread) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (thread </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        UNSAFE.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(thread);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><br><h3 id="reentrantlock" tabindex="-1">ReentrantLock <a class="header-anchor" href="#reentrantlock" aria-label="Permalink to &quot;ReentrantLock&quot;">​</a></h3><blockquote><p>一个可重入的互斥锁，其基本行为和语义与使用同步方法和语句获取锁相同，但扩展性更好。一个 ReentrantLock 被最后成功加锁且目前还没有解锁的线程所拥有。</p><p>如果当前线程已拥有锁，该方法将立即返回。可以通过 isHeldByCurrentThread 和 getHoldCount 方法来检查当前线程是否持有锁资源。</p><p>对于同一个线程，最多支持 2147483647 次锁的重用，超过此次数将会抛出 Error</p></blockquote><blockquote><p><strong>构造函数</strong></p><p>构造函数中接受一个公平性参数，可以为 true 或 false。true 表示获取的是公平锁，反之获取非公平锁。</p><p>锁的公平性并不能保证线程调度的公平性，许多使用公平锁的线程可能会连续多次获得锁。tryLock 方法并不遵循公平性的规格。如果其他线程释放了锁资源，就会抢占锁资源</p></blockquote><blockquote><p><strong>实现</strong></p><p>应该总是在 lock 方法之后立即跟着 try-finally 块以进行 unlock 操作。ReentrantLock 除了实现 Lock 接口的方法之外还额外定义了检查和监控 state 状态的 public 和 protected 方法</p></blockquote><blockquote><p><strong>序列化与反序列化</strong></p><p>序列化后进行反序列化时，state 永远处于解锁状态</p></blockquote><br><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span><span style="color:#E1E4E8;">, java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span><span style="color:#24292E;">, java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="内部类-1" tabindex="-1">内部类 <a class="header-anchor" href="#内部类-1" aria-label="Permalink to &quot;内部类&quot;">​</a></h4><h5 id="sync" tabindex="-1">Sync <a class="header-anchor" href="#sync" aria-label="Permalink to &quot;Sync&quot;">​</a></h5><blockquote><p>ReentrantLock 同步机制控制的基础，使用 AQS 的 state 属性来表示锁被持有的数量。</p><p>子类分别是 FairSync 和 NonfairSync 用来实现公平和非公平锁。</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AbstractQueuedSynchronizer</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AbstractQueuedSynchronizer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 锁的形式，由子类来实现</span></span>
<span class="line"><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查锁资源是否由当前线程占有</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isHeldExclusively</span><span style="color:#E1E4E8;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 非公平的方式获取锁</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">nonfairTryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// state == 0 表示当前无任何线程占有锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, acquires)) { </span><span style="color:#6A737D;">// CAS 占有锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(current); </span><span style="color:#6A737D;">// 将当前线程设置为占有锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (current </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 如果锁已经被当前线程占有</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> acquires; </span><span style="color:#6A737D;">// 重入，每次重入 state + 1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (nextc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// overflow 达到最大重入次数，抛出 Error</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(nextc);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 当前锁被其他线程占有</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放锁资源</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> releases) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> releases; </span><span style="color:#6A737D;">// state 减一</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) </span><span style="color:#6A737D;">// 检查锁是否被当前线程占有</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> free </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// state 减到 0 表示锁释放完毕</span></span>
<span class="line"><span style="color:#E1E4E8;">        free </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 将占有锁的线程设置为 null</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(c);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> free;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 定义和当前锁相关的 Condition</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ConditionObject </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConditionObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 锁的形式，由子类来实现</span></span>
<span class="line"><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查锁资源是否由当前线程占有</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isHeldExclusively</span><span style="color:#24292E;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 非公平的方式获取锁</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">nonfairTryAcquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// state == 0 表示当前无任何线程占有锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, acquires)) { </span><span style="color:#6A737D;">// CAS 占有锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(current); </span><span style="color:#6A737D;">// 将当前线程设置为占有锁的线程</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (current </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 如果锁已经被当前线程占有</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> acquires; </span><span style="color:#6A737D;">// 重入，每次重入 state + 1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (nextc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// overflow 达到最大重入次数，抛出 Error</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(nextc);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 当前锁被其他线程占有</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放锁资源</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> releases) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> releases; </span><span style="color:#6A737D;">// state 减一</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) </span><span style="color:#6A737D;">// 检查锁是否被当前线程占有</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> free </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// state 减到 0 表示锁释放完毕</span></span>
<span class="line"><span style="color:#24292E;">        free </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 将占有锁的线程设置为 null</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(c);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> free;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 定义和当前锁相关的 Condition</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ConditionObject </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConditionObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h5 id="nonfairsync" tabindex="-1">NonfairSync <a class="header-anchor" href="#nonfairsync" aria-label="Permalink to &quot;NonfairSync&quot;">​</a></h5><blockquote><p>非公平的 Sync 子类，不保证锁的获取顺序，并发情况下吞吐量更大</p><p>非公平锁调用逻辑 NonfairSync#lock -&gt; AQS#acquire -&gt; NonfairSync#tryAcquire -&gt; Sync#nonfairTryAcquire</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 实现非公平锁</span></span>
<span class="line"><span style="color:#6A737D;">// acquire 方法由 AQS 实现，是一个模版方法，实际上内部调用的是 tryAcquire</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// 锁获取成功</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">//锁获取失败</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 实现非公平锁</span></span>
<span class="line"><span style="color:#6A737D;">// acquire 方法由 AQS 实现，是一个模版方法，实际上内部调用的是 tryAcquire</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#6A737D;">// 锁获取成功</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">//锁获取失败</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br><h5 id="fairsync" tabindex="-1">FairSync <a class="header-anchor" href="#fairsync" aria-label="Permalink to &quot;FairSync&quot;">​</a></h5><blockquote><p>公平的 Sync 子类，保证锁的获取顺序</p><p>公平锁调用逻辑： FairSync#lock -&gt; AQS#acquire -&gt; FairSync#tryAcquire</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Fair version of tryAcquire. </span></span>
<span class="line"><span style="color:#6A737D;">// Don&#39;t grant access unless recursive call or no waiters or is first.</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 当前无任何线程占有锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">hasQueuedPredecessors</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 队列中没有前驱</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, acquires)) { </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(current); </span><span style="color:#6A737D;">// 将当前线程设置为锁的占有线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (current </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 重入锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> acquires; </span><span style="color:#6A737D;">// state + 1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (nextc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// state overflow</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(nextc);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Fair version of tryAcquire. </span></span>
<span class="line"><span style="color:#6A737D;">// Don&#39;t grant access unless recursive call or no waiters or is first.</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 当前无任何线程占有锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">hasQueuedPredecessors</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 队列中没有前驱</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, acquires)) { </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(current); </span><span style="color:#6A737D;">// 将当前线程设置为锁的占有线程</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (current </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 重入锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> acquires; </span><span style="color:#6A737D;">// state + 1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (nextc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// state overflow</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(nextc);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><br><h4 id="内部方法-1" tabindex="-1">内部方法 <a class="header-anchor" href="#内部方法-1" aria-label="Permalink to &quot;内部方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 默认为非公平锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取公平 or 非公平锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> fair) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> fair </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FairSync</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock 如果已经占有锁，则 state + 1</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">(); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock only if it is not held by another thread at the time of </span></span>
<span class="line"><span style="color:#6A737D;">// invocation.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 会忽视公平/非公平模式，只要锁空闲就会尝试获取，如果已经占有锁，则 state + 1</span></span>
<span class="line"><span style="color:#6A737D;">// 如果想要遵循公平模式，使用 tryLock(0, TimeUnit.SECONDS)</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">nonfairTryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 如果当前线程占有锁，则 state - 1，当 state 减到 0 时释放锁</span></span>
<span class="line"><span style="color:#6A737D;">// 如果当前线程未占有锁抛出 IllegalMonitorStateException</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 返回和当前 Lock 实例相关联的 Condition 实例</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查是否有在排队获取锁的线程，使用公平锁时会调用到这个方法</span></span>
<span class="line"><span style="color:#6A737D;">// ReentrantLock.FairSync#tryAcquire -&gt; hasQueuedThreads</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasQueuedThreads</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">hasQueuedThreads</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查是否有其他线程在等待同一个 Condition</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasWaiters</span><span style="color:#E1E4E8;">(Condition condition) {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 默认为非公平锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sync </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取公平 or 非公平锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> fair) {</span></span>
<span class="line"><span style="color:#24292E;">    sync </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> fair </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FairSync</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock 如果已经占有锁，则 state + 1</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">(); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquires the lock only if it is not held by another thread at the time of </span></span>
<span class="line"><span style="color:#6A737D;">// invocation.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 会忽视公平/非公平模式，只要锁空闲就会尝试获取，如果已经占有锁，则 state + 1</span></span>
<span class="line"><span style="color:#6A737D;">// 如果想要遵循公平模式，使用 tryLock(0, TimeUnit.SECONDS)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">nonfairTryAcquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 如果当前线程占有锁，则 state - 1，当 state 减到 0 时释放锁</span></span>
<span class="line"><span style="color:#6A737D;">// 如果当前线程未占有锁抛出 IllegalMonitorStateException</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sync.</span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 返回和当前 Lock 实例相关联的 Condition 实例</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查是否有在排队获取锁的线程，使用公平锁时会调用到这个方法</span></span>
<span class="line"><span style="color:#6A737D;">// ReentrantLock.FairSync#tryAcquire -&gt; hasQueuedThreads</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasQueuedThreads</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">hasQueuedThreads</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查是否有其他线程在等待同一个 Condition</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasWaiters</span><span style="color:#24292E;">(Condition condition) {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><br><h3 id="readwritelock" tabindex="-1">ReadWriteLock <a class="header-anchor" href="#readwritelock" aria-label="Permalink to &quot;ReadWriteLock&quot;">​</a></h3><blockquote><p>ReadWriteLock 维护一对相关的锁，一个读锁，一个写锁。读锁支持多个线程并发访问共享变量；写锁是独占锁。</p><p>与互斥锁相比，读写锁允许对共享数据的并发读。虽然每次只有一个线程（写线程）可以修改共享数据，但任何数量的线程（读线程）都可以并发地读取数据。</p><p>使用读写锁是否能比使用互斥锁获得更高的性能，取决于数据的读取和修改的频率、读写操作的时间以及在同一时间试图读取或写入数据的线程数量。如果一个共享变量读取的频率高于写入的频率，则符合读写锁的使用场景。</p></blockquote><blockquote><p><strong>读写偏向策略</strong></p><ul><li><p>当读写线程都在等待释放锁的时候，授予读锁还是写锁？</p><p>写优先是很常见的，因为预计写的时间很短，而且不经常发生。读偏好不太常见，如果读线程较频繁且持续时间长，可能会导致长时间的写入延迟。</p><p>当然公平/非公平模式也是支持的。</p></li><li><p>确定锁是否是可重入的</p><p>拥有写锁的线程能否重新获得它？它能否在持有写锁的同时获得一个读锁？读锁本身是可重入的吗？</p></li><li><p>写锁能否降级为读锁且不允许有写线程介入？一个读锁能否升级为写锁，且优先于其他等待的读或写线程？</p></li></ul></blockquote><blockquote><p><strong>内存效应</strong></p><p>成功获得读锁的线程能看到在释放写锁之前做出的所有更新。</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadWriteLock</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadWriteLock</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Returns the lock used for reading.</span></span>
<span class="line"><span style="color:#E1E4E8;">Lock </span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns the lock used for writing.</span></span>
<span class="line"><span style="color:#E1E4E8;">Lock </span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Returns the lock used for reading.</span></span>
<span class="line"><span style="color:#24292E;">Lock </span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns the lock used for writing.</span></span>
<span class="line"><span style="color:#24292E;">Lock </span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><br><h3 id="reentrantreadwritelock" tabindex="-1">ReentrantReadWriteLock <a class="header-anchor" href="#reentrantreadwritelock" aria-label="Permalink to &quot;ReentrantReadWriteLock&quot;">​</a></h3><blockquote><p>ReadWriteLock 的实现类，具有和 ReentrantLock 相似的语义</p></blockquote><blockquote><p><strong>锁的获取策略</strong></p><p>ReentrantReadWriteLock 支持公平和非公平模式</p><ul><li><p>非公平模式（默认）</p><p>忽略获取顺序，锁只要空闲就抢占，比公平模式具有更高的吞吐量</p></li><li><p>公平模式</p></li></ul></blockquote><blockquote><p><strong>可重入性</strong></p><p>ReentrantReadWriteLock 的读写锁都是可重入锁。写线程可以获得读锁，但反之则不能。如果占有了读锁，在获取写锁时需要先释放读锁。</p><p>当写锁中调用或回调那些在读锁下进行读取的方法时，重入是有用的。换言之，占有写锁的同时可以重入读锁。</p><p>读锁和写锁最高支持 65535 次重入，超过抛出 Error</p></blockquote><blockquote><p><strong>锁降级</strong></p><p>写锁可以通过获取读锁，降级为读锁。先获取写锁，再获取读锁，最后释放写锁，就完成降级。但是从读锁升级为写锁是不被允许的</p></blockquote><blockquote><p><strong>锁获取过程中断</strong></p><p>读锁写锁都允许在获取的时候中断</p></blockquote><blockquote><p><strong>Condition 支持</strong></p><p>写锁提供了一个 Condition 的实现，其行为方式与 ReentrantLock.newCondition 为 ReentrantLock 提供的 Condition 的行为方式相同。当然，这个 Condition 只能与写锁一起使用。</p><p>读锁不支持 Condition，调用 readLock().newCondition() 将抛出 UnsupportedOperationException。</p></blockquote><blockquote><p><strong>序列化与反序列化</strong></p><p>反序列化得到的锁始终处于解锁状态</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantReadWriteLock</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadWriteLock</span><span style="color:#E1E4E8;">, java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantReadWriteLock</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadWriteLock</span><span style="color:#24292E;">, java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Usage</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CachedData</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;">  Object data;    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> cacheValid;    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock rwl </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantReadWriteLock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">processCachedData</span><span style="color:#E1E4E8;">() {      </span></span>
<span class="line"><span style="color:#E1E4E8;">    rwl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">cacheValid) {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// Must release read lock before acquiring write lock        			</span></span>
<span class="line"><span style="color:#E1E4E8;">      rwl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();        </span></span>
<span class="line"><span style="color:#E1E4E8;">      rwl.</span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Recheck state because another thread might have          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// acquired write lock and changed state before we did.          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">cacheValid) {            </span></span>
<span class="line"><span style="color:#E1E4E8;">          	data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ...            </span></span>
<span class="line"><span style="color:#E1E4E8;">            cacheValid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;          </span></span>
<span class="line"><span style="color:#E1E4E8;">        }          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Downgrade by acquiring read lock before releasing write lock          </span></span>
<span class="line"><span style="color:#E1E4E8;">        rwl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();        </span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {          </span></span>
<span class="line"><span style="color:#E1E4E8;">        rwl.</span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// Unlock write, still hold read        </span></span>
<span class="line"><span style="color:#E1E4E8;">      }      </span></span>
<span class="line"><span style="color:#E1E4E8;">    }        </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(data);      </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      rwl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RWDictionary</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Data</span><span style="color:#E1E4E8;">&gt; m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> TreeMap&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Data</span><span style="color:#E1E4E8;">&gt;();    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock rwl </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantReadWriteLock</span><span style="color:#E1E4E8;">();    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Lock r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rwl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">();    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Lock w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rwl.</span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Data </span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">key</span><span style="color:#E1E4E8;">) {      </span></span>
<span class="line"><span style="color:#E1E4E8;">    r.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> m.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(key); </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      r.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#B392F0;">allKeys</span><span style="color:#E1E4E8;">() {      </span></span>
<span class="line"><span style="color:#E1E4E8;">    r.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> m.</span><span style="color:#B392F0;">keySet</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">toArray</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      r.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Data </span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">key</span><span style="color:#E1E4E8;">, Data </span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;">) {      </span></span>
<span class="line"><span style="color:#E1E4E8;">    w.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> m.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(key, value); </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      w.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">() {      </span></span>
<span class="line"><span style="color:#E1E4E8;">    w.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      m.</span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      w.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CachedData</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;">  Object data;    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> cacheValid;    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ReentrantReadWriteLock rwl </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantReadWriteLock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">processCachedData</span><span style="color:#24292E;">() {      </span></span>
<span class="line"><span style="color:#24292E;">    rwl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">cacheValid) {        </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// Must release read lock before acquiring write lock        			</span></span>
<span class="line"><span style="color:#24292E;">      rwl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();        </span></span>
<span class="line"><span style="color:#24292E;">      rwl.</span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();        </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Recheck state because another thread might have          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// acquired write lock and changed state before we did.          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">cacheValid) {            </span></span>
<span class="line"><span style="color:#24292E;">          	data </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ...            </span></span>
<span class="line"><span style="color:#24292E;">            cacheValid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;          </span></span>
<span class="line"><span style="color:#24292E;">        }          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Downgrade by acquiring read lock before releasing write lock          </span></span>
<span class="line"><span style="color:#24292E;">        rwl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();        </span></span>
<span class="line"><span style="color:#24292E;">      } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {          </span></span>
<span class="line"><span style="color:#24292E;">        rwl.</span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// Unlock write, still hold read        </span></span>
<span class="line"><span style="color:#24292E;">      }      </span></span>
<span class="line"><span style="color:#24292E;">    }        </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">use</span><span style="color:#24292E;">(data);      </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      rwl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RWDictionary</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Data</span><span style="color:#24292E;">&gt; m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> TreeMap&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Data</span><span style="color:#24292E;">&gt;();    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ReentrantReadWriteLock rwl </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantReadWriteLock</span><span style="color:#24292E;">();    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Lock r </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rwl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">();    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Lock w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rwl.</span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Data </span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">key</span><span style="color:#24292E;">) {      </span></span>
<span class="line"><span style="color:#24292E;">    r.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> m.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(key); </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      r.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#6F42C1;">allKeys</span><span style="color:#24292E;">() {      </span></span>
<span class="line"><span style="color:#24292E;">    r.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> m.</span><span style="color:#6F42C1;">keySet</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toArray</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      r.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Data </span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">key</span><span style="color:#24292E;">, Data </span><span style="color:#E36209;">value</span><span style="color:#24292E;">) {      </span></span>
<span class="line"><span style="color:#24292E;">    w.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> m.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(key, value); </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      w.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">clear</span><span style="color:#24292E;">() {      </span></span>
<span class="line"><span style="color:#24292E;">    w.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      m.</span><span style="color:#6F42C1;">clear</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">      w.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><br><h4 id="内部类-2" tabindex="-1">内部类 <a class="header-anchor" href="#内部类-2" aria-label="Permalink to &quot;内部类&quot;">​</a></h4><h5 id="sync-1" tabindex="-1">Sync <a class="header-anchor" href="#sync-1" aria-label="Permalink to &quot;Sync&quot;">​</a></h5><blockquote><p>ReentrantReadWriteLock 同步机制的内部实现</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AbstractQueuedSynchronizer</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AbstractQueuedSynchronizer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部类/属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 当前线程持有的可重入读锁的计数，用于实现读锁的重入</span></span>
<span class="line"><span style="color:#6A737D;">// 当线程持有的读锁数为 0 时移除</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transient</span><span style="color:#E1E4E8;"> ThreadLocalHoldCounter readHolds;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存最后一个成功获得读锁的线程信息，比如该线程的 id 以及该线程持有的读锁个数</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 在当前线程是最后一个获取读锁线程的情况下：可以优化读锁的获取和释放过程，避免重复计算读锁的持</span></span>
<span class="line"><span style="color:#6A737D;"> * 有次数，从而提高读锁的性能</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存活时间可以超过被缓存的线程，不保存对线程的引用，避免错过垃圾回收，仅保存线程 id 和读锁持</span></span>
<span class="line"><span style="color:#6A737D;"> * 有计数</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transient</span><span style="color:#E1E4E8;"> HoldCounter cachedHoldCounter;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 一个读锁计数器，用于记录每个线程持有的读锁数</span></span>
<span class="line"><span style="color:#6A737D;"> * 维护一个 count 计数和一个线程 id，不直接引用线程避免存在垃圾引用</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存在 cachedHoldCounter 中</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HoldCounter</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> count </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// // Use id, not reference, to avoid garbage retention</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> tid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> SHARED_SHIFT   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁计数器和写锁状态存储在同一个 int 类型的变量中</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位表示写锁持有计数，低 16 位表示读锁持有计数</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位表示数据的前 16 位，低 16 位存储的是数据的后 16 位</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> SHARED_UNIT    </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> SHARED_SHIFT);</span></span>
<span class="line"><span style="color:#6A737D;">// 读锁和写锁的最大数量 65535</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> MAX_COUNT      </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> SHARED_SHIFT) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#6A737D;">// 写锁的状态位,被设置为 (1 &lt;&lt; 16)，一个整数的第 17 位表示写锁状态。</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> EXCLUSIVE_MASK </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> SHARED_SHIFT) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns the number of shared holds</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sharedCount</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c)    { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">&gt;&gt;&gt;</span><span style="color:#E1E4E8;"> SHARED_SHIFT; }</span></span>
<span class="line"><span style="color:#6A737D;">// Returns the number of exclusive holds</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c) { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> EXCLUSIVE_MASK; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取锁</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、如果读锁或写锁被占有，获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、如果重入到最大次数，获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、否则重入或获取成功，更新 state 以及设置锁的 owner 线程为当前线程</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(c); </span><span style="color:#6A737D;">// 获取独占计数</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// state 非 0，锁已经被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> current </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) </span><span style="color:#6A737D;">// 锁被占有且是独占锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 获取失败</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(acquires) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> MAX_COUNT) </span><span style="color:#6A737D;">// 已到达最大获取数量</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Reentrant acquire // 重入获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> acquires); </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// state 为 0 则尝试获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">writerShouldBlock</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">!</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> acquires))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(current);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放锁</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> releases) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">isHeldExclusively</span><span style="color:#E1E4E8;">()) </span><span style="color:#6A737D;">// 非当前线程占有，释放失败</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> releases; </span><span style="color:#6A737D;">// 锁释放后 state 的值</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> free </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(nextc) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 释放后独占计数是否为 0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (free) </span><span style="color:#6A737D;">// 释放</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(nextc);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> free;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 轻量级 tryAcquireShared</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、如果写锁被其他线程持有，读锁获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、否则当前线程就有机会获取读锁，然后检查是否需要排队获取读锁。如果不需要排队，则尝试使用 </span></span>
<span class="line"><span style="color:#6A737D;"> * CAS 修改 state，获取锁；如果需要排队，则入队阻塞。注意在这这一步不需要检查可重次数， </span></span>
<span class="line"><span style="color:#6A737D;"> * fullTryAcquireShared 才需要进行重入次数检查。</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、如果第 2 步因为线程 CAS 获取锁失败或锁被获取的次数达到最大而获取失败，</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试 fullTryAcquireShared</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> unused) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(c) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 如果存在独占锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> current) </span><span style="color:#6A737D;">// 且拥有独占锁的线程不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 获取共享锁失败</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sharedCount</span><span style="color:#E1E4E8;">(c); </span><span style="color:#6A737D;">// 持有共享锁的线程数</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">readerShouldBlock</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 检查是否需要阻塞当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">        r </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> MAX_COUNT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 检查读锁是否达到最大持有数</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// 尝试 CAS 获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 当前是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            firstReader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> current; </span></span>
<span class="line"><span style="color:#E1E4E8;">            firstReaderHoldCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReader </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> current) { </span><span style="color:#6A737D;">// 当前是第一个持有读锁的线程，重入读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            firstReaderHoldCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 当前线程不是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            HoldCounter rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cachedHoldCounter; </span><span style="color:#6A737D;">// 最后一个成功获取读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// rh == null 没有线程占有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁已被占有，但是不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 以下情况可能会走到这一步：当前线程已经获取了写锁，但是需要锁降级成读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> rh.tid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(current)) </span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 获取当前线程的读锁计数，并缓存到 cachedHoldCounter</span></span>
<span class="line"><span style="color:#E1E4E8;">                cachedHoldCounter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readHolds.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh.count </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// rh.count == 0 说明该线程不持有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                readHolds.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(rh); </span><span style="color:#6A737D;">// 将持有读锁的线程信息保存到当前线程的 ThreadLocal</span></span>
<span class="line"><span style="color:#E1E4E8;">            rh.count</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 当前线程持有的读锁计数 + 1</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// 如果上面获取读锁的流程都失败，尝试 fullTryAcquireShared</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fullTryAcquireShared</span><span style="color:#E1E4E8;">(current);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 完整版的读锁获取</span></span>
<span class="line"><span style="color:#6A737D;">// 可以处理 tryAcquireShared 中没有处理的 CAS 缺失和读锁重入计数</span></span>
<span class="line"><span style="color:#6A737D;">// 与 tryAcquireShared 中的部分内容重复，但总体上更简单，不需要在重试和惰性读取读锁持有计数</span></span>
<span class="line"><span style="color:#6A737D;">// 之间进行交互</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fullTryAcquireShared</span><span style="color:#E1E4E8;">(Thread current) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    HoldCounter rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) { </span><span style="color:#6A737D;">// 自旋获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(c) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> current)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 存在独占锁且不是当前线程持有，锁获取失败</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// else we hold the exclusive lock; blocking here</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// would cause deadlock.</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">readerShouldBlock</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 如果当前线程持有独占锁，阻塞所有读线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// Make sure we&#39;re not acquiring read lock reentrantly</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReader </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> current) { </span><span style="color:#6A737D;">// 检查是否是第一个读线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// assert firstReaderHoldCount &gt; 0;</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 不是第一个读线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// rh 最后一个成功获取读锁的线程持有的读锁计数</span></span>
<span class="line"><span style="color:#E1E4E8;">                    rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// rh == null 读锁没有被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有，但不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> rh.tid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(current)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                      	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#E1E4E8;">                        rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readHolds.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh.count </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// rh.count == 0 说明该线程不再持有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                            readHolds.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 将其移除</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh.count </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">sharedCount</span><span style="color:#E1E4E8;">(c) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// CAS 获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">sharedCount</span><span style="color:#E1E4E8;">(c) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 如果当前是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> current;</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReaderHoldCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReader </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> current) { </span><span style="color:#6A737D;">// 已经是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReaderHoldCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 读锁已被其他线程获取</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// 获取最后一个成功获取读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                    rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有但不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> rh.tid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(current))</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#E1E4E8;">                    rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readHolds.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh.count </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                    readHolds.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(rh);</span></span>
<span class="line"><span style="color:#E1E4E8;">                rh.count</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                cachedHoldCounter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rh; </span><span style="color:#6A737D;">// cache for release</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放读锁</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReleaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> unused) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReader </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> current) { </span><span style="color:#6A737D;">// 如果当前线程是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// assert firstReaderHoldCount &gt; 0;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReaderHoldCount </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 如果读锁只被当前线程持有 1 次</span></span>
<span class="line"><span style="color:#E1E4E8;">            firstReader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            firstReaderHoldCount</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 读锁被当前线程重入多次</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 存在其他线程先占有了读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 最后一个成功获取到读锁的线程 HoldCounter 缓存</span></span>
<span class="line"><span style="color:#E1E4E8;">        HoldCounter rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cachedHoldCounter; </span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有但不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> rh.tid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(current)) </span><span style="color:#6A737D;">// 未持有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 获取当前线程读锁计数</span></span>
<span class="line"><span style="color:#E1E4E8;">            rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readHolds.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(); </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> count </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rh.count;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (count </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            readHolds.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 释放读锁重入计数</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (count </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unmatchedUnlockException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">rh.count;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> SHARED_UNIT;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, nextc)) </span><span style="color:#6A737D;">// CAS 设置 state</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 释放读锁对读线程无任何影响，</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 如果读锁和写锁都是空闲的，读线程可能会等待写线程先执行</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取写锁，不遵循公平模式规则，如果锁资源空闲，允许抢占</span></span>
<span class="line"><span style="color:#6A737D;"> * 除了没有调用 writerShouldBlock，其他逻辑和 tryAcquire 一致</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryWriteLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// state 非 0，表示锁已被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(c);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> current </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) </span><span style="color:#6A737D;">// 是否是当前线程持有</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// CAS 获取</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(current);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试获取读锁</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReadLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">exclusiveCount</span><span style="color:#E1E4E8;">(c) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 是否是独占锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> current) </span><span style="color:#6A737D;">// 独占锁是否由当前线程持有</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sharedCount</span><span style="color:#E1E4E8;">(c); </span><span style="color:#6A737D;">// 共享锁持有计数</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// CAS 获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 如果是第一个占有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> current;</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReaderHoldCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (firstReader </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> current) { </span><span style="color:#6A737D;">// 已经是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                firstReaderHoldCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 读锁已被其他线程占有</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// 最后一个成功获得读锁的线程计数</span></span>
<span class="line"><span style="color:#E1E4E8;">                HoldCounter rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cachedHoldCounter; </span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有，但不是当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> rh.tid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getThreadId</span><span style="color:#E1E4E8;">(current))</span></span>
<span class="line"><span style="color:#E1E4E8;">                  	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#E1E4E8;">                    cachedHoldCounter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readHolds.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rh.count </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    readHolds.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(rh);</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// 以上判断是为了避免同一个线程在未释放之前重复获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// 以及确保当前线程拥有的读锁与试图获取的读锁不冲突</span></span>
<span class="line"><span style="color:#E1E4E8;">                rh.count</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 供外部类使用，创建和当前锁相关量的 Condition 对象</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ConditionObject </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConditionObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 当前线程持有的可重入读锁的计数，用于实现读锁的重入</span></span>
<span class="line"><span style="color:#6A737D;">// 当线程持有的读锁数为 0 时移除</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transient</span><span style="color:#24292E;"> ThreadLocalHoldCounter readHolds;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存最后一个成功获得读锁的线程信息，比如该线程的 id 以及该线程持有的读锁个数</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 在当前线程是最后一个获取读锁线程的情况下：可以优化读锁的获取和释放过程，避免重复计算读锁的持</span></span>
<span class="line"><span style="color:#6A737D;"> * 有次数，从而提高读锁的性能</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存活时间可以超过被缓存的线程，不保存对线程的引用，避免错过垃圾回收，仅保存线程 id 和读锁持</span></span>
<span class="line"><span style="color:#6A737D;"> * 有计数</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transient</span><span style="color:#24292E;"> HoldCounter cachedHoldCounter;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 一个读锁计数器，用于记录每个线程持有的读锁数</span></span>
<span class="line"><span style="color:#6A737D;"> * 维护一个 count 计数和一个线程 id，不直接引用线程避免存在垃圾引用</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存在 cachedHoldCounter 中</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HoldCounter</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// // Use id, not reference, to avoid garbage retention</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> tid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> SHARED_SHIFT   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁计数器和写锁状态存储在同一个 int 类型的变量中</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位表示写锁持有计数，低 16 位表示读锁持有计数</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位表示数据的前 16 位，低 16 位存储的是数据的后 16 位</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> SHARED_UNIT    </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> SHARED_SHIFT);</span></span>
<span class="line"><span style="color:#6A737D;">// 读锁和写锁的最大数量 65535</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> MAX_COUNT      </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> SHARED_SHIFT) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6A737D;">// 写锁的状态位,被设置为 (1 &lt;&lt; 16)，一个整数的第 17 位表示写锁状态。</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> EXCLUSIVE_MASK </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> SHARED_SHIFT) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Returns the number of shared holds</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sharedCount</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c)    { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">&gt;&gt;&gt;</span><span style="color:#24292E;"> SHARED_SHIFT; }</span></span>
<span class="line"><span style="color:#6A737D;">// Returns the number of exclusive holds</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c) { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> EXCLUSIVE_MASK; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取锁</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、如果读锁或写锁被占有，获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、如果重入到最大次数，获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、否则重入或获取成功，更新 state 以及设置锁的 owner 线程为当前线程</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(c); </span><span style="color:#6A737D;">// 获取独占计数</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// state 非 0，锁已经被占有</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> current </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) </span><span style="color:#6A737D;">// 锁被占有且是独占锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 获取失败</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(acquires) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> MAX_COUNT) </span><span style="color:#6A737D;">// 已到达最大获取数量</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Reentrant acquire // 重入获取锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> acquires); </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// state 为 0 则尝试获取锁</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">writerShouldBlock</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> acquires))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(current);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放锁</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> releases) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">isHeldExclusively</span><span style="color:#24292E;">()) </span><span style="color:#6A737D;">// 非当前线程占有，释放失败</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> releases; </span><span style="color:#6A737D;">// 锁释放后 state 的值</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> free </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(nextc) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 释放后独占计数是否为 0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (free) </span><span style="color:#6A737D;">// 释放</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(nextc);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> free;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 轻量级 tryAcquireShared</span></span>
<span class="line"><span style="color:#6A737D;"> * 1、如果写锁被其他线程持有，读锁获取失败</span></span>
<span class="line"><span style="color:#6A737D;"> * 2、否则当前线程就有机会获取读锁，然后检查是否需要排队获取读锁。如果不需要排队，则尝试使用 </span></span>
<span class="line"><span style="color:#6A737D;"> * CAS 修改 state，获取锁；如果需要排队，则入队阻塞。注意在这这一步不需要检查可重次数， </span></span>
<span class="line"><span style="color:#6A737D;"> * fullTryAcquireShared 才需要进行重入次数检查。</span></span>
<span class="line"><span style="color:#6A737D;"> * 3、如果第 2 步因为线程 CAS 获取锁失败或锁被获取的次数达到最大而获取失败，</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试 fullTryAcquireShared</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> unused) {</span></span>
<span class="line"><span style="color:#24292E;">    Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(c) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 如果存在独占锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> current) </span><span style="color:#6A737D;">// 且拥有独占锁的线程不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 获取共享锁失败</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sharedCount</span><span style="color:#24292E;">(c); </span><span style="color:#6A737D;">// 持有共享锁的线程数</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">readerShouldBlock</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 检查是否需要阻塞当前线程</span></span>
<span class="line"><span style="color:#24292E;">        r </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> MAX_COUNT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 检查读锁是否达到最大持有数</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// 尝试 CAS 获取读锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (r </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 当前是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">            firstReader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> current; </span></span>
<span class="line"><span style="color:#24292E;">            firstReaderHoldCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReader </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> current) { </span><span style="color:#6A737D;">// 当前是第一个持有读锁的线程，重入读锁</span></span>
<span class="line"><span style="color:#24292E;">            firstReaderHoldCount</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 当前线程不是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">            HoldCounter rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cachedHoldCounter; </span><span style="color:#6A737D;">// 最后一个成功获取读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// rh == null 没有线程占有读锁</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁已被占有，但是不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 以下情况可能会走到这一步：当前线程已经获取了写锁，但是需要锁降级成读锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> rh.tid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(current)) </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 获取当前线程的读锁计数，并缓存到 cachedHoldCounter</span></span>
<span class="line"><span style="color:#24292E;">                cachedHoldCounter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readHolds.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh.count </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// rh.count == 0 说明该线程不持有读锁</span></span>
<span class="line"><span style="color:#24292E;">                readHolds.</span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(rh); </span><span style="color:#6A737D;">// 将持有读锁的线程信息保存到当前线程的 ThreadLocal</span></span>
<span class="line"><span style="color:#24292E;">            rh.count</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 当前线程持有的读锁计数 + 1</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// 如果上面获取读锁的流程都失败，尝试 fullTryAcquireShared</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fullTryAcquireShared</span><span style="color:#24292E;">(current);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 完整版的读锁获取</span></span>
<span class="line"><span style="color:#6A737D;">// 可以处理 tryAcquireShared 中没有处理的 CAS 缺失和读锁重入计数</span></span>
<span class="line"><span style="color:#6A737D;">// 与 tryAcquireShared 中的部分内容重复，但总体上更简单，不需要在重试和惰性读取读锁持有计数</span></span>
<span class="line"><span style="color:#6A737D;">// 之间进行交互</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fullTryAcquireShared</span><span style="color:#24292E;">(Thread current) {</span></span>
<span class="line"><span style="color:#24292E;">    HoldCounter rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) { </span><span style="color:#6A737D;">// 自旋获取读锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(c) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> current)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 存在独占锁且不是当前线程持有，锁获取失败</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// else we hold the exclusive lock; blocking here</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// would cause deadlock.</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">readerShouldBlock</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 如果当前线程持有独占锁，阻塞所有读线程</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Make sure we&#39;re not acquiring read lock reentrantly</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReader </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> current) { </span><span style="color:#6A737D;">// 检查是否是第一个读线程</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// assert firstReaderHoldCount &gt; 0;</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 不是第一个读线程</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// rh 最后一个成功获取读锁的线程持有的读锁计数</span></span>
<span class="line"><span style="color:#24292E;">                    rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// rh == null 读锁没有被占有</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有，但不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> rh.tid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(current)) {</span></span>
<span class="line"><span style="color:#24292E;">                      	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#24292E;">                        rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readHolds.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh.count </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// rh.count == 0 说明该线程不再持有读锁</span></span>
<span class="line"><span style="color:#24292E;">                            readHolds.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 将其移除</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh.count </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">sharedCount</span><span style="color:#24292E;">(c) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// CAS 获取读锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">sharedCount</span><span style="color:#24292E;">(c) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 如果当前是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">                firstReader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> current;</span></span>
<span class="line"><span style="color:#24292E;">                firstReaderHoldCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReader </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> current) { </span><span style="color:#6A737D;">// 已经是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">                firstReaderHoldCount</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 读锁已被其他线程获取</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// 获取最后一个成功获取读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">                    rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有但不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> rh.tid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(current))</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#24292E;">                    rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readHolds.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh.count </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 获取读锁</span></span>
<span class="line"><span style="color:#24292E;">                    readHolds.</span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(rh);</span></span>
<span class="line"><span style="color:#24292E;">                rh.count</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                cachedHoldCounter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rh; </span><span style="color:#6A737D;">// cache for release</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试释放读锁</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReleaseShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> unused) {</span></span>
<span class="line"><span style="color:#24292E;">    Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReader </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> current) { </span><span style="color:#6A737D;">// 如果当前线程是第一个持有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// assert firstReaderHoldCount &gt; 0;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReaderHoldCount </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 如果读锁只被当前线程持有 1 次</span></span>
<span class="line"><span style="color:#24292E;">            firstReader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            firstReaderHoldCount</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 读锁被当前线程重入多次</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 存在其他线程先占有了读锁</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 最后一个成功获取到读锁的线程 HoldCounter 缓存</span></span>
<span class="line"><span style="color:#24292E;">        HoldCounter rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cachedHoldCounter; </span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有但不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> rh.tid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(current)) </span><span style="color:#6A737D;">// 未持有读锁</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 获取当前线程读锁计数</span></span>
<span class="line"><span style="color:#24292E;">            rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readHolds.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(); </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rh.count;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (count </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            readHolds.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 释放读锁重入计数</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (count </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unmatchedUnlockException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">rh.count;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> SHARED_UNIT;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, nextc)) </span><span style="color:#6A737D;">// CAS 设置 state</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 释放读锁对读线程无任何影响，</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 如果读锁和写锁都是空闲的，读线程可能会等待写线程先执行</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 尝试获取写锁，不遵循公平模式规则，如果锁资源空闲，允许抢占</span></span>
<span class="line"><span style="color:#6A737D;"> * 除了没有调用 writerShouldBlock，其他逻辑和 tryAcquire 一致</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryWriteLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// state 非 0，表示锁已被占有</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(c);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> current </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) </span><span style="color:#6A737D;">// 是否是当前线程持有</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#6A737D;">// CAS 获取</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(current);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试获取读锁</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReadLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取当前 state</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">exclusiveCount</span><span style="color:#24292E;">(c) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 是否是独占锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> current) </span><span style="color:#6A737D;">// 独占锁是否由当前线程持有</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sharedCount</span><span style="color:#24292E;">(c); </span><span style="color:#6A737D;">// 共享锁持有计数</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (r </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> MAX_COUNT) </span><span style="color:#6A737D;">// 达到最大持有数</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> SHARED_UNIT)) { </span><span style="color:#6A737D;">// CAS 获取读锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (r </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 如果是第一个占有读锁</span></span>
<span class="line"><span style="color:#24292E;">                firstReader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> current;</span></span>
<span class="line"><span style="color:#24292E;">                firstReaderHoldCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (firstReader </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> current) { </span><span style="color:#6A737D;">// 已经是第一个占有读锁的线程</span></span>
<span class="line"><span style="color:#24292E;">                firstReaderHoldCount</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 读锁已被其他线程占有</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// 最后一个成功获得读锁的线程计数</span></span>
<span class="line"><span style="color:#24292E;">                HoldCounter rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cachedHoldCounter; </span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// rh == null 读锁未被占有</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// rh.tid != getThreadId(current) 读锁被占有，但不是当前线程</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> rh.tid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getThreadId</span><span style="color:#24292E;">(current))</span></span>
<span class="line"><span style="color:#24292E;">                  	</span><span style="color:#6A737D;">// 获取当前线程的读锁计数</span></span>
<span class="line"><span style="color:#24292E;">                    cachedHoldCounter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readHolds.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rh.count </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    readHolds.</span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(rh);</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// 以上判断是为了避免同一个线程在未释放之前重复获取读锁</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// 以及确保当前线程拥有的读锁与试图获取的读锁不冲突</span></span>
<span class="line"><span style="color:#24292E;">                rh.count</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 供外部类使用，创建和当前锁相关量的 Condition 对象</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ConditionObject </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConditionObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br></div></div><br><h5 id="nonfairsync-1" tabindex="-1">NonfairSync <a class="header-anchor" href="#nonfairsync-1" aria-label="Permalink to &quot;NonfairSync&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部类/属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">writerShouldBlock</span><span style="color:#E1E4E8;">() { </span><span style="color:#6A737D;">// 阻塞写线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// writers can always barge</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 为了写线程处于无限的等待，如果等待队列头是写线程，则阻塞所有读线程</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">readerShouldBlock</span><span style="color:#E1E4E8;">() { </span><span style="color:#6A737D;">// 阻塞读线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">apparentlyFirstQueuedIsExclusive</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">writerShouldBlock</span><span style="color:#24292E;">() { </span><span style="color:#6A737D;">// 阻塞写线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// writers can always barge</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 为了写线程处于无限的等待，如果等待队列头是写线程，则阻塞所有读线程</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">readerShouldBlock</span><span style="color:#24292E;">() { </span><span style="color:#6A737D;">// 阻塞读线程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">apparentlyFirstQueuedIsExclusive</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br><h5 id="fairsync-1" tabindex="-1">FairSync <a class="header-anchor" href="#fairsync-1" aria-label="Permalink to &quot;FairSync&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">writerShouldBlock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasQueuedPredecessors</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 如果存在等待队列，则阻塞 or 入队写线程</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">readerShouldBlock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasQueuedPredecessors</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 如果存在等待队列，则阻塞 or 入队读线程</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">writerShouldBlock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasQueuedPredecessors</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 如果存在等待队列，则阻塞 or 入队写线程</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">readerShouldBlock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasQueuedPredecessors</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 如果存在等待队列，则阻塞 or 入队读线程</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><br><h5 id="readlock" tabindex="-1">ReadLock <a class="header-anchor" href="#readlock" aria-label="Permalink to &quot;ReadLock&quot;">​</a></h5><blockquote><p><strong>公平读锁调用流程</strong></p><p>ReentrantReadWriteLock.ReadLock#lock</p><p>-&gt; AQS#acquireShared</p><p>-&gt; ReentrantReadWriteLock.Sync#tryAcquireShared</p><p>-&gt; ReentrantReadWriteLock.Sync#fullTryAcquireShared</p><br><p><strong>非公平读锁调用流程</strong></p><p>ReadLock#tryLock</p><p>-&gt; ReentrantReadWriteLock.Sync#tryReadLock</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadLock</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span><span style="color:#E1E4E8;">, java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadLock</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span><span style="color:#24292E;">, java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">acquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); } </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">tryReadLock</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">// 尝试获取读锁，忽略公平规则</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">releaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁不支持 Condition</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">UnsupportedOperationException</span><span style="color:#E1E4E8;">(); }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">acquireShared</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); } </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">tryReadLock</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">// 尝试获取读锁，忽略公平规则</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">releaseShared</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁不支持 Condition</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">UnsupportedOperationException</span><span style="color:#24292E;">(); }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br><h5 id="writelock" tabindex="-1">WriteLock <a class="header-anchor" href="#writelock" aria-label="Permalink to &quot;WriteLock&quot;">​</a></h5><blockquote><p><strong>公平写锁调用流程</strong></p><p>ReentrantReadWriteLock.WriteLock#lock</p><p>-&gt; AQS#acquire</p><p>-&gt; ReentrantReadWriteLock.Sync#tryAcquire</p><br><p><strong>非公平写锁调用流程</strong></p><p>ReentrantReadWriteLock.WriteLock#tryLock</p><p>-&gt; ReentrantReadWriteLock.Sync#tryWriteLock</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WriteLock</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span><span style="color:#E1E4E8;">, java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WriteLock</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span><span style="color:#24292E;">, java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); } </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">( ) { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">tryWriteLock</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">// 尝试获取写锁，忽略公平规则</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取与当前写锁相关联的 Condition 实例</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">(); }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); } </span><span style="color:#6A737D;">// 获取锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">( ) { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">tryWriteLock</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">// 尝试获取写锁，忽略公平规则</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 获取与当前写锁相关联的 Condition 实例</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">(); }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br><h4 id="内部属性-1" tabindex="-1">内部属性 <a class="header-anchor" href="#内部属性-1" aria-label="Permalink to &quot;内部属性&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Sync sync; </span><span style="color:#6A737D;">// 同步机制</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock.ReadLock readerLock; </span><span style="color:#6A737D;">// 读锁</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock.WriteLock writerLock; </span><span style="color:#6A737D;">// 写锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Unsafe mechanics</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> sun.misc.Unsafe UNSAFE; </span><span style="color:#6A737D;">// Unsafe 类</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> TID_OFFSET; </span><span style="color:#6A737D;">// 线程 id 的 offset</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        UNSAFE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sun.misc.Unsafe.</span><span style="color:#B392F0;">getUnsafe</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; tk </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.class;</span></span>
<span class="line"><span style="color:#E1E4E8;">        TID_OFFSET </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> UNSAFE.objectFieldOffset</span></span>
<span class="line"><span style="color:#E1E4E8;">            (tk.</span><span style="color:#B392F0;">getDeclaredField</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;tid&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Exception </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(e);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Sync sync; </span><span style="color:#6A737D;">// 同步机制</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ReentrantReadWriteLock.ReadLock readerLock; </span><span style="color:#6A737D;">// 读锁</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ReentrantReadWriteLock.WriteLock writerLock; </span><span style="color:#6A737D;">// 写锁</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Unsafe mechanics</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> sun.misc.Unsafe UNSAFE; </span><span style="color:#6A737D;">// Unsafe 类</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> TID_OFFSET; </span><span style="color:#6A737D;">// 线程 id 的 offset</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        UNSAFE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sun.misc.Unsafe.</span><span style="color:#6F42C1;">getUnsafe</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; tk </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.class;</span></span>
<span class="line"><span style="color:#24292E;">        TID_OFFSET </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> UNSAFE.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292E;">            (tk.</span><span style="color:#6F42C1;">getDeclaredField</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;tid&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(e);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><br><h4 id="内部方法-2" tabindex="-1">内部方法 <a class="header-anchor" href="#内部方法-2" aria-label="Permalink to &quot;内部方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 获取写锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock.WriteLock </span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> writerLock; }</span></span>
<span class="line"><span style="color:#6A737D;">// 获取读锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> ReentrantReadWriteLock.ReadLock  </span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">()  { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> readerLock; }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 获取写锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> ReentrantReadWriteLock.WriteLock </span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> writerLock; }</span></span>
<span class="line"><span style="color:#6A737D;">// 获取读锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> ReentrantReadWriteLock.ReadLock  </span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">()  { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> readerLock; }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><br><h4 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h4><blockquote><ul><li>读锁不支持 Condition</li><li>在只获取一种锁的情况下，读/写锁都是可重入锁。在获取了读锁的情况下，不允许重入写锁；在获取了写锁的情况下，允许重入读锁</li></ul></blockquote><br><h3 id="stampedlock" tabindex="-1">StampedLock <a class="header-anchor" href="#stampedlock" aria-label="Permalink to &quot;StampedLock&quot;">​</a></h3><blockquote><p>一个基于能力的锁，有三种模式来控制读/写。StampedLock 的状态由 version 和 mode 两部分组成，锁的获取方法返回一个 stamp，代表并控制与锁状态有关的访问。</p><p>如果使用 tryXXX 方法获取锁，返回 0 表示获取失败。锁的释放和转换方法需要传入 stamp 作为参数，首先进行 stamp 校验，如果 stamp 不匹配则失败。</p></blockquote><blockquote><p><strong>三种锁模式</strong></p><ul><li><p>读锁</p><p>readLock，可能会阻塞非独占访问，返回一个 stamp 用于 unlockRead 解锁。</p></li><li><p>写锁</p><p>writeLock，可能会阻塞独占访问，返回一个 stamp 用于 unlockWrite 解锁。如果写锁被占有，则所有的读锁获取操作都会失败，并且乐观锁校验都会失败。</p></li><li><p>乐观锁</p><p>tryOptimisticRead，如果当前不是写模式，则返回非 0 的 stamp 表示获取到乐观锁。在获取到乐观锁后，可以使用 validate 方法检查写锁是否被占有。</p><p>乐观锁可以认为是一个很弱的读锁，随时都有可能被写锁打破。它只会返回一个 stamp 用作校验，并不会真正上锁不会阻塞其他线程。</p><p>使用乐观锁对简短的只读代码段通常会降低线程对锁的争抢，提高吞吐量。</p></li></ul></blockquote><blockquote><p><strong>锁模式转换</strong></p><p>StampedLock 提供三种锁模式之间的转换，tryConvertToWriteLock 方法可以尝试进行锁升级。</p><p>如果当前</p><ul><li>已经处于写模式</li><li>处于读模式，但是没有其他读线程</li><li>处于乐观模式，且读写锁都可用</li></ul><p>都会返回一个有效的 stamp，代表锁转换成功</p></blockquote><blockquote><p><strong>公平与非公平</strong></p><p>同样的，StampedLock 提供了 tryXXX 方法，这些方法不遵循公平规则，只要锁处于空闲状态都会尝试去获取。StampedLock 没有内置的等待队列，而是通过尝试获取读锁或写锁来实现并发控制，不支持 Condition</p></blockquote><blockquote><p><strong>可重入性</strong></p><p>StampedLock 不可重入，在使用 StampedLock 的时候，如果一个线程已经持有了写锁，则其它线程就不能获取读锁或者写锁，直到持有写锁的线程释放锁。如果一个线程已经持有了写锁，再次尝试获取写锁会导致死锁。如果一个线程已经持有了读锁，再次尝试获取写锁也会导致死锁。</p><p>尽管可以将 stamp 作为参数传入 tryConvertToWriteLock 尝试进行锁的转换，但是重入是不被允许的。</p></blockquote><blockquote><p><strong>Stamp 取值</strong></p><p>Stamp 的取值是有限的，在密码学上是不安全的，一个有效的 stamp 是有可能被猜到的。stamp 在运行一年之后可以进行回收，超过这段时间没有使用或者进行校验的 stamp 可能会无法正确校验。</p></blockquote><blockquote><p><strong>序列化与反序列化</strong></p><p>StampedLock 是可以序列化的，但总是反序列化为无锁状态，所以在远程调用中是不可用的</p></blockquote><blockquote><p><strong>锁的状态表示</strong></p><p>通常来说，锁的主要状态主要由二进制串表示，初始值为 256，二进制 100000000，二进制下标位从 0 开始，从右往左第 7 位（左高右低）为 0 表示锁未被占有。</p><p>当锁第一次被获取 stamp = state + WBIT = 256 + 128 = 384，第一次获取锁时返回的 stamp = 384，从右往左第 7 位为 1，表示锁被占有。</p><p>此二进制序列号会被读锁的非零计数抵消，如果获取的是乐观锁，读计数会忽略。因为需要用一个足够小的有限数来表示读计数，读锁超过计数最大值时，使用 RBITS 来表示读锁溢出，作为更新溢出的自旋保护机制</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StampedLock</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StampedLock</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>Usage</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Point</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> x, y;    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> StampedLock sl </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StampedLock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">deltaX</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">deltaY</span><span style="color:#E1E4E8;">) { </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// an exclusively locked method      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// do something     </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      sl.</span><span style="color:#B392F0;">unlockWrite</span><span style="color:#E1E4E8;">(stamp);      </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">() { </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// A read-only method      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">tryOptimisticRead</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// get  OptimisticRead first</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> currentX </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> x, currentY </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> y;      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">sl.</span><span style="color:#B392F0;">validate</span><span style="color:#E1E4E8;">(stamp)) { </span><span style="color:#6A737D;">// check OptimisticRead stamp     </span></span>
<span class="line"><span style="color:#E1E4E8;">      stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">();         </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {           </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// read data     </span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {            </span></span>
<span class="line"><span style="color:#E1E4E8;">        sl.</span><span style="color:#B392F0;">unlockRead</span><span style="color:#E1E4E8;">(stamp);         </span></span>
<span class="line"><span style="color:#E1E4E8;">      }      </span></span>
<span class="line"><span style="color:#E1E4E8;">    }      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> data;  </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// upgrade      </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">upgrade</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">newX</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">newY</span><span style="color:#E1E4E8;">) { </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Could instead start with optimistic, not read mode      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (x </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> y </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">) {          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> ws </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">tryConvertToWriteLock</span><span style="color:#E1E4E8;">(stamp); </span><span style="color:#6A737D;">// upgrade read to write        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ws </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) {            </span></span>
<span class="line"><span style="color:#E1E4E8;">          stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ws;            </span></span>
<span class="line"><span style="color:#E1E4E8;">          x </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> newX;            </span></span>
<span class="line"><span style="color:#E1E4E8;">          y </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> newY;            </span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;          </span></span>
<span class="line"><span style="color:#E1E4E8;">        }          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// upgrade fail, relase read and acquire write</span></span>
<span class="line"><span style="color:#E1E4E8;">          sl.</span><span style="color:#B392F0;">unlockRead</span><span style="color:#E1E4E8;">(stamp);            </span></span>
<span class="line"><span style="color:#E1E4E8;">          stamp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sl.</span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">();          </span></span>
<span class="line"><span style="color:#E1E4E8;">        }        </span></span>
<span class="line"><span style="color:#E1E4E8;">      }      </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {        </span></span>
<span class="line"><span style="color:#E1E4E8;">      sl.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(stamp);      </span></span>
<span class="line"><span style="color:#E1E4E8;">    }    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Point</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> x, y;    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> StampedLock sl </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StampedLock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">deltaX</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">deltaY</span><span style="color:#24292E;">) { </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// an exclusively locked method      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// do something     </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      sl.</span><span style="color:#6F42C1;">unlockWrite</span><span style="color:#24292E;">(stamp);      </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">() { </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// A read-only method      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">tryOptimisticRead</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// get  OptimisticRead first</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> currentX </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> x, currentY </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> y;      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">sl.</span><span style="color:#6F42C1;">validate</span><span style="color:#24292E;">(stamp)) { </span><span style="color:#6A737D;">// check OptimisticRead stamp     </span></span>
<span class="line"><span style="color:#24292E;">      stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">();         </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {           </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// read data     </span></span>
<span class="line"><span style="color:#24292E;">      } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {            </span></span>
<span class="line"><span style="color:#24292E;">        sl.</span><span style="color:#6F42C1;">unlockRead</span><span style="color:#24292E;">(stamp);         </span></span>
<span class="line"><span style="color:#24292E;">      }      </span></span>
<span class="line"><span style="color:#24292E;">    }      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> data;  </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// upgrade      </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">upgrade</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">newX</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">newY</span><span style="color:#24292E;">) { </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Could instead start with optimistic, not read mode      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (x </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> y </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">) {          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> ws </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">tryConvertToWriteLock</span><span style="color:#24292E;">(stamp); </span><span style="color:#6A737D;">// upgrade read to write        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ws </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) {            </span></span>
<span class="line"><span style="color:#24292E;">          stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ws;            </span></span>
<span class="line"><span style="color:#24292E;">          x </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> newX;            </span></span>
<span class="line"><span style="color:#24292E;">          y </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> newY;            </span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;          </span></span>
<span class="line"><span style="color:#24292E;">        }          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// upgrade fail, relase read and acquire write</span></span>
<span class="line"><span style="color:#24292E;">          sl.</span><span style="color:#6F42C1;">unlockRead</span><span style="color:#24292E;">(stamp);            </span></span>
<span class="line"><span style="color:#24292E;">          stamp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sl.</span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">();          </span></span>
<span class="line"><span style="color:#24292E;">        }        </span></span>
<span class="line"><span style="color:#24292E;">      }      </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {        </span></span>
<span class="line"><span style="color:#24292E;">      sl.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(stamp);      </span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">  }  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="内部类-3" tabindex="-1">内部类 <a class="header-anchor" href="#内部类-3" aria-label="Permalink to &quot;内部类&quot;">​</a></h4><h5 id="wnode" tabindex="-1">WNode <a class="header-anchor" href="#wnode" aria-label="Permalink to &quot;WNode&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> WNode prev;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> WNode next;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> WNode cowait;    </span><span style="color:#6A737D;">// list of linked readers // 读等待列表</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> Thread thread;   </span><span style="color:#6A737D;">// non-null while possibly parked</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> status;      </span><span style="color:#6A737D;">// 0, WAITING, or CANCELLED</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> mode;           </span><span style="color:#6A737D;">// RMODE or WMODE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">m</span><span style="color:#E1E4E8;">, WNode </span><span style="color:#FFAB70;">p</span><span style="color:#E1E4E8;">) { mode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> m; prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p; }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> WNode prev;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> WNode next;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> WNode cowait;    </span><span style="color:#6A737D;">// list of linked readers // 读等待列表</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> Thread thread;   </span><span style="color:#6A737D;">// non-null while possibly parked</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> status;      </span><span style="color:#6A737D;">// 0, WAITING, or CANCELLED</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> mode;           </span><span style="color:#6A737D;">// RMODE or WMODE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">m</span><span style="color:#24292E;">, WNode </span><span style="color:#E36209;">p</span><span style="color:#24292E;">) { mode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> m; prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p; }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><br><h5 id="readlockview" tabindex="-1">ReadLockView <a class="header-anchor" href="#readlockview" aria-label="Permalink to &quot;ReadLockView&quot;">​</a></h5><blockquote><p>Returns a ReadWriteLock view of this StampedLock in which the ReadWriteLock.readLock() method is mapped to asReadLock()</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadLockView</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadLockView</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() { </span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">// StampedLock#readLock</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReadLock</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">; } </span><span style="color:#6A737D;">// StampedLock#tryReadLock</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() { </span><span style="color:#B392F0;">unstampedUnlockRead</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">// StampedLock#unstampedUnlockRead</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 不支持 Condition</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">UnsupportedOperationException</span><span style="color:#E1E4E8;">(); }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() { </span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">// StampedLock#readLock</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReadLock</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">; } </span><span style="color:#6A737D;">// StampedLock#tryReadLock</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() { </span><span style="color:#6F42C1;">unstampedUnlockRead</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">// StampedLock#unstampedUnlockRead</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 不支持 Condition</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">UnsupportedOperationException</span><span style="color:#24292E;">(); }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><br><h5 id="writelockview" tabindex="-1">WriteLockView <a class="header-anchor" href="#writelockview" aria-label="Permalink to &quot;WriteLockView&quot;">​</a></h5><blockquote><p>Returns a ReadWriteLock view of this StampedLock in which the ReadWriteLock.writeLock() is mapped to asWriteLock().</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WriteLockView</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lock</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WriteLockView</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lock</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() { </span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">// StampedLock#writeLock</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryWriteLock</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">; }</span><span style="color:#6A737D;">//StampedLock#tryWriteLock</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() { </span><span style="color:#B392F0;">unstampedUnlockWrite</span><span style="color:#E1E4E8;">(); } </span><span style="color:#6A737D;">//StampedLock#unstampedUnlockWrite</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 不支持 Condition</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Condition </span><span style="color:#B392F0;">newCondition</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">UnsupportedOperationException</span><span style="color:#E1E4E8;">(); }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() { </span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">// StampedLock#writeLock</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryWriteLock</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">; }</span><span style="color:#6A737D;">//StampedLock#tryWriteLock</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() { </span><span style="color:#6F42C1;">unstampedUnlockWrite</span><span style="color:#24292E;">(); } </span><span style="color:#6A737D;">//StampedLock#unstampedUnlockWrite</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 不支持 Condition</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Condition </span><span style="color:#6F42C1;">newCondition</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">UnsupportedOperationException</span><span style="color:#24292E;">(); }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><br><h5 id="readwritelockview" tabindex="-1">ReadWriteLockView <a class="header-anchor" href="#readwritelockview" aria-label="Permalink to &quot;ReadWriteLockView&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadWriteLockView</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadWriteLock</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Lock </span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">asReadLock</span><span style="color:#E1E4E8;">(); }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Lock </span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">asWriteLock</span><span style="color:#E1E4E8;">(); }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadWriteLockView</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadWriteLock</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Lock </span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">asReadLock</span><span style="color:#24292E;">(); }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Lock </span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">asWriteLock</span><span style="color:#24292E;">(); }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><br><h4 id="内部属性-2" tabindex="-1">内部属性 <a class="header-anchor" href="#内部属性-2" aria-label="Permalink to &quot;内部属性&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// StampedLock 内部使用了一个 long 类型的变量 state 来记录锁的状态，</span></span>
<span class="line"><span style="color:#6A737D;">// 其中高 16 位表示写锁状态，低 16 位表示读锁状态。</span></span>
<span class="line"><span style="color:#6A737D;">// 其中，LG_READERS 定义了低 16 位中用于记录读锁个数的位数，</span></span>
<span class="line"><span style="color:#6A737D;">// 实际上这个位数就是 16 减 LG_READERS，可以用来控制读锁的数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 记录读锁个数的位数</span></span>
<span class="line"><span style="color:#6A737D;">// LG_READERS 的默认值是 7，意味着可以支持最多同时持有 2^(16-7) = 256 个读锁</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> LG_READERS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 表示锁的状态，和计算 stamp 的值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1L</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 读锁计数器的单位值，用于读锁计数器的自增</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 写锁的掩码值，用于标识写锁的状态，通过左移操作得到</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测写锁是否空闲</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> WBIT  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> LG_READERS; </span><span style="color:#6A737D;">// 2^7 = 128</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁的掩码值</span></span>
<span class="line"><span style="color:#6A737D;">// 当 state 中低 LG_READERS 位的 RBITS 全部为 1 时，表示当前所有 reader 位都被占用</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测读锁是否空闲</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> RBITS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1L</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 128 - 1 = 127</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 当读锁计数器达到该值时，代表读锁已满，不能再获取新的读锁，用于限制读锁计数器的最大值</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> RFULL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> RBITS </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1L</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 127 - 1 = 126</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ABITS 和 SBITS 是用来计算锁的状态的，锁的状态是一个 long 类型的值，</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位是读锁的计数器，低 16 位是写锁的计数器，中间的1位是一个标志位，用来表示锁的状态。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquiring Bits 获取状态位，当一个线程试图获取一个锁时，被设置为 1</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测锁是否空闲</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> ABITS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> RBITS </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> WBIT; </span><span style="color:#6A737D;">// 127 ｜ 126 = 255 // 11111111</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Successful Bits 成功获取位，当线程获得锁时，它被设置为 1</span></span>
<span class="line"><span style="color:#6A737D;">// 还可以获取乐观锁，校验乐观锁等</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> SBITS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">RBITS; </span><span style="color:#6A737D;">// note overlap with ABITS // -128 // 10000000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 锁状态的初始值</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> ORIGIN </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 128 * 2 = 256</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 节点状态值</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> WAITING   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> CANCELLED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#6A737D;">// 节点模式</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> RMODE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> WMODE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// StampedLock 内部使用了一个 long 类型的变量 state 来记录锁的状态，</span></span>
<span class="line"><span style="color:#6A737D;">// 其中高 16 位表示写锁状态，低 16 位表示读锁状态。</span></span>
<span class="line"><span style="color:#6A737D;">// 其中，LG_READERS 定义了低 16 位中用于记录读锁个数的位数，</span></span>
<span class="line"><span style="color:#6A737D;">// 实际上这个位数就是 16 减 LG_READERS，可以用来控制读锁的数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 记录读锁个数的位数</span></span>
<span class="line"><span style="color:#6A737D;">// LG_READERS 的默认值是 7，意味着可以支持最多同时持有 2^(16-7) = 256 个读锁</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> LG_READERS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 表示锁的状态，和计算 stamp 的值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1L</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 读锁计数器的单位值，用于读锁计数器的自增</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 写锁的掩码值，用于标识写锁的状态，通过左移操作得到</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测写锁是否空闲</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> WBIT  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> LG_READERS; </span><span style="color:#6A737D;">// 2^7 = 128</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 读锁的掩码值</span></span>
<span class="line"><span style="color:#6A737D;">// 当 state 中低 LG_READERS 位的 RBITS 全部为 1 时，表示当前所有 reader 位都被占用</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测读锁是否空闲</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> RBITS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1L</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 128 - 1 = 127</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 当读锁计数器达到该值时，代表读锁已满，不能再获取新的读锁，用于限制读锁计数器的最大值</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> RFULL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RBITS </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1L</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 127 - 1 = 126</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ABITS 和 SBITS 是用来计算锁的状态的，锁的状态是一个 long 类型的值，</span></span>
<span class="line"><span style="color:#6A737D;">// 高 16 位是读锁的计数器，低 16 位是写锁的计数器，中间的1位是一个标志位，用来表示锁的状态。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Acquiring Bits 获取状态位，当一个线程试图获取一个锁时，被设置为 1</span></span>
<span class="line"><span style="color:#6A737D;">// 用于检测锁是否空闲</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> ABITS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RBITS </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> WBIT; </span><span style="color:#6A737D;">// 127 ｜ 126 = 255 // 11111111</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Successful Bits 成功获取位，当线程获得锁时，它被设置为 1</span></span>
<span class="line"><span style="color:#6A737D;">// 还可以获取乐观锁，校验乐观锁等</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> SBITS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">RBITS; </span><span style="color:#6A737D;">// note overlap with ABITS // -128 // 10000000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 锁状态的初始值</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> ORIGIN </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 128 * 2 = 256</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 节点状态值</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> WAITING   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> CANCELLED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6A737D;">// 节点模式</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> RMODE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> WMODE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h4 id="内部方法-3" tabindex="-1">内部方法 <a class="header-anchor" href="#内部方法-3" aria-label="Permalink to &quot;内部方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 提供给 ReadLockView 和 WriteLockView 使用</span></span>
<span class="line"><span style="color:#6A737D;">// 因为 View 类不会保存 state 信息，所以需要在外部定义</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 无需 stamp 参数释放写锁</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unstampedUnlockWrite</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    WNode h; </span><span style="color:#6A737D;">// 头节点</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s; </span><span style="color:#6A737D;">// 当前 state</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// WBIT 写锁对应的状态位</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// ((s = state) &amp; WBIT) == 0L 读取当前状态 state 并检查写锁是否被持有</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// 如果当前状态的写锁位为 0，则表示写锁未被持有</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// state = (s += WBIT) == 0L 如果写锁位加上 state 后结果为 0</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// 将状态 state 重置为初始状态 ORIGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> ORIGIN </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> s;</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#6A737D;">// 释放等待队列中的节点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 无需 stamp 参数释放读锁</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unstampedUnlockRead</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// m 表示当前状态下读锁的数量</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, m; </span></span>
<span class="line"><span style="color:#E1E4E8;">      	WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 如果 m 的值为 0，或者大于等于 WBIT（写锁被持有）</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> m </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> WBIT)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 如果读锁的数量小于 RFULL，减少读锁的数量</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 尝试使用 CAS 操作将 state 的值减去 RUNIT，表示释放一个读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, s </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> RUNIT)) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// m == RUNI 仅有一个读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// (h = whead) != null 存在下一个需要获取锁的节点</span></span>
<span class="line"><span style="color:#E1E4E8;">              	</span><span style="color:#6A737D;">// h.status != 0 则 status 可能为 WAITING = -1 或 CANCELLED = 1</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h); </span><span style="color:#6A737D;">// 将 WAITING/CANCELLED 状态的头节点移除避免死锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// // 如果读锁的数量已经达到了 RFULL 尝试减少读溢出数量</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryDecReaderOverflow</span><span style="color:#E1E4E8;">(s) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 唤醒 h 结点的后继结点（h 通常表示等待结点的头结点），此方法等效于 h.next，</span></span>
<span class="line"><span style="color:#6A737D;"> * 但是它可以在 h 指向的下一个结点有延迟的时候从尾结点遍历，唤醒其他结点</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果后继的一个或者多个线程结点被取消，唤醒可能会失败</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(WNode h) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// q 表示当前节点的下一个结点</span></span>
<span class="line"><span style="color:#E1E4E8;">        WNode q; </span></span>
<span class="line"><span style="color:#E1E4E8;">      	Thread w;</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 如果 h 结点处于 WAITING 状态，将其状态设置为 0，退出 WAITING</span></span>
<span class="line"><span style="color:#E1E4E8;">        U.</span><span style="color:#B392F0;">compareAndSwapInt</span><span style="color:#E1E4E8;">(h, WSTATUS, WAITING, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 如果不存在下一个结点或下一个结点被取消</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((q </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> h.next) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> q.status </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> CANCELLED) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 从尾结点遍历，获取其他等待获取锁的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (WNode t </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wtail; t </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> t </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> h; t </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> t.prev)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (t.status </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// WAITING = -1 / CANCELLED = 1 如果存在等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                    q </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> t;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 等待获取锁的结点非空，且结点中的线程依然存活</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (q </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> q.thread) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            U.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(w); </span><span style="color:#6A737D;">// 将其唤醒</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">writeLock</span><span style="color:#E1E4E8;">() { </span><span style="color:#6A737D;">// 在完全无锁的情况下才能成功获取到写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, next;  </span><span style="color:#6A737D;">// bypass acquireWrite in fully unlocked case only</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// state=256, WBIT=128, ABITS=255, STATE=16 表示内存偏移量</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// state &amp; ABITS == 0L 表示锁空闲</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 如果锁没有被获取，并且 CAS 获取锁成功 返回 next = s + WBIT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 第一次成功获取返回 stamp=256+128=384</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 锁获取失败，进入 acquireWrite，在循环中自旋</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ((((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">             U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT)) </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">            next </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireWrite</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果当前锁资源没有被别的线程占有，可以直接获取；</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果当前锁资源被别的线程占有，将当前线程加入等待队列。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果等待队列中只有一个结点，头结点一直自旋，直到获取到锁或者达到头结点自旋上限；</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果等待队列中存在多个结点，唤醒等待队列中的其他结点。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireWrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> interruptible, </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> deadline) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 初始化两个结点，node 表示当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">    WNode node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, p;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;;) { </span><span style="color:#6A737D;">// spin while enqueuing 入队自旋</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> m, s, ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// state &amp; ABITS == 0L 表示锁空闲，直接获取</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ns; </span><span style="color:#6A737D;">// 获取成功返回 stamp，退出自旋循环</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// spins &lt; 0 初始化 spins，设置当前线程最大自旋次数 SPINS= 64</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">            spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> wtail </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> SPINS </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 获取伪随机数，如果大于 0 则 spins 自减</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (LockSupport.</span><span style="color:#B392F0;">nextSecondarySeed</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">spins;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// spins 自减到 0 也没能获取到锁，进入下一个 else if</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// p = wtail == null 队列尾结点为空，表示此时队列为空队列，开始初始化队列</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wtail) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// initialize queue</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 初始化写模式头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 头结点 h 并不是一个真正的线程节点，它只是一个哨兵结点，用于协调多个线程之间的并发竞争。</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 在头结点自旋等待获取锁时，实际上是在等待其他线程释放锁，当获取到锁资源时，线程会从等待队列中取</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 出下一个真正的线程结点 np，将其设置为头结点，并尝试获取锁资源。</span></span>
<span class="line"><span style="color:#E1E4E8;">            WNode hd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;">(WMODE, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 需要一个 dummy head 来辅助</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// CAS 操作设置头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, WHEAD, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, hd))</span></span>
<span class="line"><span style="color:#E1E4E8;">                wtail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hd; </span><span style="color:#6A737D;">// 队列此时只有一个结点，因此尾结点=头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      	</span><span style="color:#6A737D;">// 到这一步，说明队列非空，头结点 p 已存在</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (node </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// node == null 初始化当前 node</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 初始化写模式的 wnode 结点，前驱结点为尾结点 p</span></span>
<span class="line"><span style="color:#E1E4E8;">            node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;">(WMODE, p);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (node.prev </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> p) </span><span style="color:#6A737D;">// 如果 node 不为 null</span></span>
<span class="line"><span style="color:#E1E4E8;">            node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p; </span><span style="color:#6A737D;">// node 的前驱设置为尾结点 p</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, WTAIL, p, node)) { </span><span style="color:#6A737D;">//node设置为尾结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            p.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node; </span><span style="color:#6A737D;">// 将尾结点的后继结点设置为 node</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// node 结点成功进入等待队列，退出循环</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 若等待队列已存在 </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// node 始终是尾结点</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 到这一步：</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 当前线程自旋获取锁失败，创建 node 结点，作为等待链表的尾结点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 等待链表情况如下：</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 1、只有一个结点在等待获取锁 whead = p &lt;-&gt; node = wtail</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 2、链表已存在，有多个结点，尾结点 node = wtail，p 是 node 的前驱 whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 头结点自旋获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 初始化一系列结点</span></span>
<span class="line"><span style="color:#E1E4E8;">      	 </span><span style="color:#6A737D;">// h 表示头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">      	 </span><span style="color:#6A737D;">// np 表示 node 的前驱</span></span>
<span class="line"><span style="color:#E1E4E8;">      	 </span><span style="color:#6A737D;">// pp 表示 p 的前驱</span></span>
<span class="line"><span style="color:#E1E4E8;">        WNode h, np, pp; </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ps;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p) { </span><span style="color:#6A737D;">// 头结点存在，且头节点 == 尾节点 p 对应： h=whead=p &lt;-&gt; node</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// HEAD_SPINS 表示头结点最大自旋次数，HEAD_SPINS 和 CPU 核心数有关</span></span>
<span class="line"><span style="color:#E1E4E8;">              	 </span><span style="color:#6A737D;">// 假设是多核 CPU，HEAD_SPINS=2^10=1024，否则 HEAD_SPINS=0</span></span>
<span class="line"><span style="color:#E1E4E8;">                spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> HEAD_SPINS;</span></span>
<span class="line"><span style="color:#E1E4E8;">          	</span><span style="color:#6A737D;">// 多核 CPU，MAX_HEAD_SPINS=2^16=65536，否则 MAX_HEAD_SPINS=0</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> MAX_HEAD_SPINS) </span></span>
<span class="line"><span style="color:#E1E4E8;">                spins </span><span style="color:#F97583;">&lt;&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// spins = spins &lt;&lt; 1 = spins * 2</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> k </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> spins;;) { </span><span style="color:#6A737D;">// spin at head 头结点自旋</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 尝试获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 获取成功</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        whead </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node; </span><span style="color:#6A737D;">// 头结点自旋获取锁成功，头结点 whead = node</span></span>
<span class="line"><span style="color:#E1E4E8;">                        node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ns; </span><span style="color:#6A737D;">// 返回更新后的 state</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 获取失败，继续自旋</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (LockSupport.</span><span style="color:#B392F0;">nextSecondarySeed</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">k </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 头结点自旋获取锁失败</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 到这一步</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 头结点自旋超过最大次数，锁未获取成功 h = whead = p</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 等待链表情况如下</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 情况1：只有一个结点在等待获取锁 h = whead = p &lt;-&gt; node = wtail</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 情况2：链表已存在，有多个结点，h = whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 唤醒头结点的后继结点（处理情况 2）</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 唤醒链表中的其他等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            WNode c; Thread w;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// c = h.cowait，c 表示等待获取锁的结点链表，如果等待链表非空，循环唤醒链表中的结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> ((c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> h.cowait) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 对应情况 2，等待链表已存在，循环唤醒后继结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c.thread) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(w); </span><span style="color:#6A737D;">// 唤醒后继结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 到这里链表的有两种情况： </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 1、h = whead = p &lt;-&gt; node </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 2、h = whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// np 表示 node 结点的前驱结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((np </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node.prev) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> p) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (np </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 将 node 放到链表末尾</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np).next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;   </span><span style="color:#6A737D;">// stale</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 将 p 结点的状态设置为 WAITING = -1</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((ps </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.status) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">compareAndSwapInt</span><span style="color:#E1E4E8;">(p, WSTATUS, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, WAITING);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ps </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> CANCELLED) { </span><span style="color:#6A737D;">// 如果 p 结点状态为 CANCELLED</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 将 node 结点和 p 的前驱结点 pp 相连接</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.prev) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    pp.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 走到这里说明头结点 p 状态已经是 WAITING</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> time; </span><span style="color:#6A737D;">// 0 argument to park means no timeout</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// deadline = 0</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (deadline </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// deadline 已经过期，取消等待</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> deadline </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> System.</span><span style="color:#B392F0;">nanoTime</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, node, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// deadline !=0 且未过期</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                Thread wt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 保存对 wt 对象的引用</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 将当前线程保存到 node.thread</span></span>
<span class="line"><span style="color:#E1E4E8;">                node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wt;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// p != h ==&gt; p 不是头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// node 的前驱结点是 p 结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// whead == h ==&gt; h 是头结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// p.status &lt; 0 说明 p 结点在 WAITING 状态</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// state &amp; ABITS != 0L 表示目前的锁已经被其他线程占有</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (p.status </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (p </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                        whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> node.prev </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 进入这一步说明等待队列中存在多个等待结点</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// UnSafe.park 模拟 LockSupport.park</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 实际上 LockSupport.park 底层实现就是依靠 UnSafe.park阻塞当前线程</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 当 balancing unpark 发生或 balancing unpark 已经发生恢复线程被中断后恢复</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 如果 absolute=false 并且 time 非零，等待 time 时间后恢复；</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 如果 absolute=true 并且 time 非零；或参数 time 过期，线程恢复或虚假恢复</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// park 当前线程，当前线程进入等待状态，并等待被唤醒</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">park</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, time);  </span><span style="color:#6A737D;">// emulate LockSupport.park</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 到这里说明线程被唤醒，将 node.thread 设置为 null</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 因为 node 结点是 dummy 结点，因此不会对线程有影响</span></span>
<span class="line"><span style="color:#E1E4E8;">                node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 清空对 wt 对象的引用</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (interruptible </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">interrupted</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 如果线程可中断或者已经被中断，取消等待</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, node, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryWriteLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, next;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// ((s = state) &amp; ABITS) == 0L 读写锁均空闲</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ((((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">             U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT)) </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">            next </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlockWrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// state != stamp stamp 不匹配</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// (stamp &amp; WBIT) == 0L 或写锁处于空闲</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> ORIGIN </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> stamp;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">readLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state, next;  </span><span style="color:#6A737D;">// bypass acquireRead on common uncontended case</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// (whead == wtail &amp;&amp; (s &amp; ABITS) &lt; RFULL 读锁持有数为达到最大值</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ((whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> wtail </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">             U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT)) </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">            next </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireRead</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireRead</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> interruptible, </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> deadline) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// node 表示当前线程结点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// p 表示尾结点</span></span>
<span class="line"><span style="color:#E1E4E8;">    WNode node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, p;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 如果头尾结点相等 h = whead = p = wtail 表示当前只有 node 等待获取</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wtail)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> m, s, ns;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// (m = (s = state) &amp; ABITS) &lt; RFULL 表示读锁持有数未达到最大值</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 则尝试 CAS 获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT) </span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// m &lt; WBIT 表示当前存在读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 如果读锁持有超过最大持有数，先尝试获取锁，成功后增大最大持有数</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// ++readerOverflow</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryIncReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> WBIT) { </span><span style="color:#6A737D;">// 当前存在写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (LockSupport.</span><span style="color:#B392F0;">nextSecondarySeed</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 自旋获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">spins;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 自旋结束还是没获取到锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                            WNode nh </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead, np </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wtail;</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// h = whead</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// p = wtail</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((nh </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> np </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nh) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> (p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np))</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                        }</span></span>
<span class="line"><span style="color:#E1E4E8;">                        spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> SPINS;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 到这里，说明自旋获取读锁未成功</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (p </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// initialize queue 初始化队列</span></span>
<span class="line"><span style="color:#E1E4E8;">            WNode hd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;">(WMODE, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 创建 dummy head</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, WHEAD, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, hd))</span></span>
<span class="line"><span style="color:#E1E4E8;">                wtail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hd;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (node </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WNode</span><span style="color:#E1E4E8;">(RMODE, p); </span><span style="color:#6A737D;">// 创建 node，前驱 p = wtail</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> p.mode </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> RMODE) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (node.prev </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> p)</span></span>
<span class="line"><span style="color:#E1E4E8;">                node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, WTAIL, p, node)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                p.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// CAS 设置 cowait，即将 node 加入等待队列</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(p, WCOWAIT, node.cowait </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.cowait, node))</span></span>
<span class="line"><span style="color:#E1E4E8;">            node.cowait </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 到这里说明 node 已经在队列中</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// pp 表示 p 的前驱</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// c = h.cowait</span></span>
<span class="line"><span style="color:#E1E4E8;">                WNode pp, c; Thread w;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> h.cowait) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c.thread) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// help release</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(w); </span><span style="color:#6A737D;">// 唤醒 h = whead 的后继读结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.prev) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> pp </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> m, s, ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 尝试获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">                            U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                 ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT) </span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                            (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                             (ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryIncReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    } </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> WBIT);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> p.prev </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> pp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> time;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 抛弃已取消的结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pp </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> p.status </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// p.status = CANCELLED = 1 &gt; 0</span></span>
<span class="line"><span style="color:#E1E4E8;">                        node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// throw away</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (deadline </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> deadline </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> System.</span><span style="color:#B392F0;">nanoTime</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, p, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    Thread wt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wt;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> pp </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                        whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> p.prev </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> pp)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        U.</span><span style="color:#B392F0;">park</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, time); </span><span style="color:#6A737D;">// 还是没获取到锁，park 当前线程 time 时间</span></span>
<span class="line"><span style="color:#E1E4E8;">                    node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (interruptible </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">interrupted</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, p, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        WNode h, np, pp; </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ps;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                spins </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> HEAD_SPINS;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (spins </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> MAX_HEAD_SPINS)</span></span>
<span class="line"><span style="color:#E1E4E8;">                spins </span><span style="color:#F97583;">&lt;&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> k </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> spins;;) { </span><span style="color:#6A737D;">// spin at head 头结点自旋获取锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> m, s, ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL </span><span style="color:#F97583;">?</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT) </span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (ns </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryIncReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    WNode c; Thread w;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    whead </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> ((c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node.cowait) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(node, WCOWAIT,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                   c, c.cowait) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                            (w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c.thread) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            U.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(w);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ns;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> WBIT </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                         LockSupport.</span><span style="color:#B392F0;">nextSecondarySeed</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">k </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            WNode c; Thread w;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> ((c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> h.cowait) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapObject</span><span style="color:#E1E4E8;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (w </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c.thread) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">unpark</span><span style="color:#E1E4E8;">(w);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((np </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node.prev) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> p) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (np </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np).next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;   </span><span style="color:#6A737D;">// stale 唤醒队列中后继结点</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((ps </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.status) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">compareAndSwapInt</span><span style="color:#E1E4E8;">(p, WSTATUS, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, WAITING);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ps </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> CANCELLED) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p.prev) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    pp.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> time;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (deadline </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> deadline </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> System.</span><span style="color:#B392F0;">nanoTime</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, node, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                Thread wt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wt;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (p.status </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (p </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    whead </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> h </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> node.prev </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> p)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    U.</span><span style="color:#B392F0;">park</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, time);</span></span>
<span class="line"><span style="color:#E1E4E8;">                node.thread </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                U.</span><span style="color:#B392F0;">putObject</span><span style="color:#E1E4E8;">(wt, PARKBLOCKER, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (interruptible </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">interrupted</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cancelWaiter</span><span style="color:#E1E4E8;">(node, node, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReadLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, m, next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未满</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryIncReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 读锁持有数已满，尝试自增</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlockRead</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s, m; WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 满足条件释放读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未满，正常释放</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, s </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> RUNIT)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryDecReaderOverflow</span><span style="color:#E1E4E8;">(s) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 读锁持有数超过最大值，尝试减少</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试获取乐观锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryOptimisticRead</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> s;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 验证乐观锁 stamp</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">validate</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    U.</span><span style="color:#B392F0;">loadFence</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 解锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS, m, s; WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS)) { </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 当前锁未被持有</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) { </span><span style="color:#6A737D;">// 当前锁被写线程持有</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> m) </span><span style="color:#6A737D;">// 校验写线程的标志位是否等于给定的标志位</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> ORIGIN </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> s; </span><span style="color:#6A737D;">// 更新锁的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#6A737D;">// 给定标志位为 0 或大于等于 WBIT，即非读锁标志位</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 当前锁被读线程持有</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, s </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> RUNIT)) { </span><span style="color:#6A737D;">// 尝试释放读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryDecReaderOverflow</span><span style="color:#E1E4E8;">(s) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 尝试释放读锁并减少溢出</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成写锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryConvertToWriteLock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS, m, s, next;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 当前锁空闲</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 锁状态位不为 0，表示锁已经被获取</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT)) </span><span style="color:#6A737D;">// 直接获取写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) { </span><span style="color:#6A737D;">// 当前已经持有写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> m)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> stamp;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 当前持有读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> WBIT)) </span><span style="color:#6A737D;">// 释放读锁获取写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成读锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryConvertToReadLock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS, m, s, next; WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS)) { </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 锁空闲，直接获取</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未达到最大</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryIncReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 读锁持有数溢出，尝试增加并获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) { </span><span style="color:#6A737D;">// 当前持有写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> m)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// s + (WBIT + RUNIT) 可以看成 (s + WBIT) + RUNIT 先释放写锁在获取读锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (WBIT </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> RUNIT);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> WBIT)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> stamp;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成乐观锁</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryConvertToOptimisticRead</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> stamp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS, m, s, next; WNode h;</span></span>
<span class="line"><span style="color:#E1E4E8;">    U.</span><span style="color:#B392F0;">loadFence</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 加载屏障</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (((s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> state) </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> (stamp </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS)) </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> ABITS) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 当前锁空闲</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 锁被抢占，无法转换成乐观锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> s; </span><span style="color:#6A737D;">// 否则获取乐观锁成功</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> WBIT) { </span><span style="color:#6A737D;">// 当前线程持有写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> m) </span><span style="color:#6A737D;">// 无法转换成乐观锁</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// s = s + WBIT 释放写锁，返回解锁后的 s 作为乐观锁的 stamp</span></span>
<span class="line"><span style="color:#E1E4E8;">            state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (s </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> WBIT) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> ORIGIN </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> s;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// a == 0L 表示当前线程没有获取到锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// a &gt;= WBIT 表示当前存在写锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 转换成乐观锁失败</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> WBIT)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> RFULL) { </span><span style="color:#6A737D;">// 当前持有读锁，释放读锁，获取乐观锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (U.</span><span style="color:#B392F0;">compareAndSwapLong</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, STATE, s, next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> RUNIT)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (m </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> RUNIT </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> whead) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryDecReaderOverflow</span><span style="color:#E1E4E8;">(s)) </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> next </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> SBITS;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 提供给 ReadLockView 和 WriteLockView 使用</span></span>
<span class="line"><span style="color:#6A737D;">// 因为 View 类不会保存 state 信息，所以需要在外部定义</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 无需 stamp 参数释放写锁</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unstampedUnlockWrite</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    WNode h; </span><span style="color:#6A737D;">// 头节点</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s; </span><span style="color:#6A737D;">// 当前 state</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// WBIT 写锁对应的状态位</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// ((s = state) &amp; WBIT) == 0L 读取当前状态 state 并检查写锁是否被持有</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// 如果当前状态的写锁位为 0，则表示写锁未被持有</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// state = (s += WBIT) == 0L 如果写锁位加上 state 后结果为 0</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// 将状态 state 重置为初始状态 ORIGIN</span></span>
<span class="line"><span style="color:#24292E;">    state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> ORIGIN </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> s;</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#6A737D;">// 释放等待队列中的节点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 无需 stamp 参数释放读锁</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unstampedUnlockRead</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// m 表示当前状态下读锁的数量</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, m; </span></span>
<span class="line"><span style="color:#24292E;">      	WNode h;</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 如果 m 的值为 0，或者大于等于 WBIT（写锁被持有）</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> m </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> WBIT)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 如果读锁的数量小于 RFULL，减少读锁的数量</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 尝试使用 CAS 操作将 state 的值减去 RUNIT，表示释放一个读锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, s </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> RUNIT)) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// m == RUNI 仅有一个读锁</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// (h = whead) != null 存在下一个需要获取锁的节点</span></span>
<span class="line"><span style="color:#24292E;">              	</span><span style="color:#6A737D;">// h.status != 0 则 status 可能为 WAITING = -1 或 CANCELLED = 1</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h); </span><span style="color:#6A737D;">// 将 WAITING/CANCELLED 状态的头节点移除避免死锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// // 如果读锁的数量已经达到了 RFULL 尝试减少读溢出数量</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryDecReaderOverflow</span><span style="color:#24292E;">(s) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 唤醒 h 结点的后继结点（h 通常表示等待结点的头结点），此方法等效于 h.next，</span></span>
<span class="line"><span style="color:#6A737D;"> * 但是它可以在 h 指向的下一个结点有延迟的时候从尾结点遍历，唤醒其他结点</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果后继的一个或者多个线程结点被取消，唤醒可能会失败</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(WNode h) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// q 表示当前节点的下一个结点</span></span>
<span class="line"><span style="color:#24292E;">        WNode q; </span></span>
<span class="line"><span style="color:#24292E;">      	Thread w;</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 如果 h 结点处于 WAITING 状态，将其状态设置为 0，退出 WAITING</span></span>
<span class="line"><span style="color:#24292E;">        U.</span><span style="color:#6F42C1;">compareAndSwapInt</span><span style="color:#24292E;">(h, WSTATUS, WAITING, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 如果不存在下一个结点或下一个结点被取消</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((q </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> h.next) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> q.status </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> CANCELLED) {</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 从尾结点遍历，获取其他等待获取锁的线程</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (WNode t </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wtail; t </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> t </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> h; t </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> t.prev)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (t.status </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// WAITING = -1 / CANCELLED = 1 如果存在等待结点</span></span>
<span class="line"><span style="color:#24292E;">                    q </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> t;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 等待获取锁的结点非空，且结点中的线程依然存活</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (q </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> q.thread) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            U.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(w); </span><span style="color:#6A737D;">// 将其唤醒</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">writeLock</span><span style="color:#24292E;">() { </span><span style="color:#6A737D;">// 在完全无锁的情况下才能成功获取到写锁</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, next;  </span><span style="color:#6A737D;">// bypass acquireWrite in fully unlocked case only</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// state=256, WBIT=128, ABITS=255, STATE=16 表示内存偏移量</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// state &amp; ABITS == 0L 表示锁空闲</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 如果锁没有被获取，并且 CAS 获取锁成功 返回 next = s + WBIT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 第一次成功获取返回 stamp=256+128=384</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 锁获取失败，进入 acquireWrite，在循环中自旋</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ((((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">             U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT)) </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">            next </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireWrite</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果当前锁资源没有被别的线程占有，可以直接获取；</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果当前锁资源被别的线程占有，将当前线程加入等待队列。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果等待队列中只有一个结点，头结点一直自旋，直到获取到锁或者达到头结点自旋上限；</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果等待队列中存在多个结点，唤醒等待队列中的其他结点。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireWrite</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> interruptible, </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> deadline) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 初始化两个结点，node 表示当前线程</span></span>
<span class="line"><span style="color:#24292E;">    WNode node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, p;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;;) { </span><span style="color:#6A737D;">// spin while enqueuing 入队自旋</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> m, s, ns;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// state &amp; ABITS == 0L 表示锁空闲，直接获取</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ns; </span><span style="color:#6A737D;">// 获取成功返回 stamp，退出自旋循环</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// spins &lt; 0 初始化 spins，设置当前线程最大自旋次数 SPINS= 64</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">            spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> wtail </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> SPINS </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 获取伪随机数，如果大于 0 则 spins 自减</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (LockSupport.</span><span style="color:#6F42C1;">nextSecondarySeed</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">spins;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// spins 自减到 0 也没能获取到锁，进入下一个 else if</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// p = wtail == null 队列尾结点为空，表示此时队列为空队列，开始初始化队列</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wtail) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// initialize queue</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 初始化写模式头结点</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 头结点 h 并不是一个真正的线程节点，它只是一个哨兵结点，用于协调多个线程之间的并发竞争。</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 在头结点自旋等待获取锁时，实际上是在等待其他线程释放锁，当获取到锁资源时，线程会从等待队列中取</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 出下一个真正的线程结点 np，将其设置为头结点，并尝试获取锁资源。</span></span>
<span class="line"><span style="color:#24292E;">            WNode hd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;">(WMODE, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 需要一个 dummy head 来辅助</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// CAS 操作设置头结点</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, WHEAD, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, hd))</span></span>
<span class="line"><span style="color:#24292E;">                wtail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hd; </span><span style="color:#6A737D;">// 队列此时只有一个结点，因此尾结点=头结点</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      	</span><span style="color:#6A737D;">// 到这一步，说明队列非空，头结点 p 已存在</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (node </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// node == null 初始化当前 node</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 初始化写模式的 wnode 结点，前驱结点为尾结点 p</span></span>
<span class="line"><span style="color:#24292E;">            node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;">(WMODE, p);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (node.prev </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> p) </span><span style="color:#6A737D;">// 如果 node 不为 null</span></span>
<span class="line"><span style="color:#24292E;">            node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p; </span><span style="color:#6A737D;">// node 的前驱设置为尾结点 p</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, WTAIL, p, node)) { </span><span style="color:#6A737D;">//node设置为尾结点</span></span>
<span class="line"><span style="color:#24292E;">            p.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node; </span><span style="color:#6A737D;">// 将尾结点的后继结点设置为 node</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// node 结点成功进入等待队列，退出循环</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 若等待队列已存在 </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// node 始终是尾结点</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 到这一步：</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 当前线程自旋获取锁失败，创建 node 结点，作为等待链表的尾结点</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 等待链表情况如下：</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 1、只有一个结点在等待获取锁 whead = p &lt;-&gt; node = wtail</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 2、链表已存在，有多个结点，尾结点 node = wtail，p 是 node 的前驱 whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 头结点自旋获取锁</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 初始化一系列结点</span></span>
<span class="line"><span style="color:#24292E;">      	 </span><span style="color:#6A737D;">// h 表示头结点</span></span>
<span class="line"><span style="color:#24292E;">      	 </span><span style="color:#6A737D;">// np 表示 node 的前驱</span></span>
<span class="line"><span style="color:#24292E;">      	 </span><span style="color:#6A737D;">// pp 表示 p 的前驱</span></span>
<span class="line"><span style="color:#24292E;">        WNode h, np, pp; </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ps;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p) { </span><span style="color:#6A737D;">// 头结点存在，且头节点 == 尾节点 p 对应： h=whead=p &lt;-&gt; node</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// HEAD_SPINS 表示头结点最大自旋次数，HEAD_SPINS 和 CPU 核心数有关</span></span>
<span class="line"><span style="color:#24292E;">              	 </span><span style="color:#6A737D;">// 假设是多核 CPU，HEAD_SPINS=2^10=1024，否则 HEAD_SPINS=0</span></span>
<span class="line"><span style="color:#24292E;">                spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HEAD_SPINS;</span></span>
<span class="line"><span style="color:#24292E;">          	</span><span style="color:#6A737D;">// 多核 CPU，MAX_HEAD_SPINS=2^16=65536，否则 MAX_HEAD_SPINS=0</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> MAX_HEAD_SPINS) </span></span>
<span class="line"><span style="color:#24292E;">                spins </span><span style="color:#D73A49;">&lt;&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// spins = spins &lt;&lt; 1 = spins * 2</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> k </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spins;;) { </span><span style="color:#6A737D;">// spin at head 头结点自旋</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, ns;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 尝试获取锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 获取成功</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT)) {</span></span>
<span class="line"><span style="color:#24292E;">                        whead </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node; </span><span style="color:#6A737D;">// 头结点自旋获取锁成功，头结点 whead = node</span></span>
<span class="line"><span style="color:#24292E;">                        node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ns; </span><span style="color:#6A737D;">// 返回更新后的 state</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 获取失败，继续自旋</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (LockSupport.</span><span style="color:#6F42C1;">nextSecondarySeed</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">k </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 头结点自旋获取锁失败</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 到这一步</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 头结点自旋超过最大次数，锁未获取成功 h = whead = p</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 等待链表情况如下</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 情况1：只有一个结点在等待获取锁 h = whead = p &lt;-&gt; node = wtail</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 情况2：链表已存在，有多个结点，h = whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 唤醒头结点的后继结点（处理情况 2）</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 唤醒链表中的其他等待结点</span></span>
<span class="line"><span style="color:#24292E;">            WNode c; Thread w;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// c = h.cowait，c 表示等待获取锁的结点链表，如果等待链表非空，循环唤醒链表中的结点</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> ((c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> h.cowait) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 对应情况 2，等待链表已存在，循环唤醒后继结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c.thread) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(w); </span><span style="color:#6A737D;">// 唤醒后继结点</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 到这里链表的有两种情况： </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 1、h = whead = p &lt;-&gt; node </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 2、h = whead &lt;-&gt; ... &lt;-&gt; p &lt;-&gt; node </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// np 表示 node 结点的前驱结点</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((np </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node.prev) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> p) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (np </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 将 node 放到链表末尾</span></span>
<span class="line"><span style="color:#24292E;">                    (p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np).next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;   </span><span style="color:#6A737D;">// stale</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 将 p 结点的状态设置为 WAITING = -1</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((ps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.status) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">compareAndSwapInt</span><span style="color:#24292E;">(p, WSTATUS, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, WAITING);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ps </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> CANCELLED) { </span><span style="color:#6A737D;">// 如果 p 结点状态为 CANCELLED</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 将 node 结点和 p 的前驱结点 pp 相连接</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.prev) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pp;</span></span>
<span class="line"><span style="color:#24292E;">                    pp.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 走到这里说明头结点 p 状态已经是 WAITING</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> time; </span><span style="color:#6A737D;">// 0 argument to park means no timeout</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// deadline = 0</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (deadline </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// deadline 已经过期，取消等待</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> deadline </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">nanoTime</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, node, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// deadline !=0 且未过期</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292E;">                Thread wt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 保存对 wt 对象的引用</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 将当前线程保存到 node.thread</span></span>
<span class="line"><span style="color:#24292E;">                node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wt;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// p != h ==&gt; p 不是头结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// node 的前驱结点是 p 结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// whead == h ==&gt; h 是头结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// p.status &lt; 0 说明 p 结点在 WAITING 状态</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// state &amp; ABITS != 0L 表示目前的锁已经被其他线程占有</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (p.status </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (p </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                        whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> node.prev </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 进入这一步说明等待队列中存在多个等待结点</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// UnSafe.park 模拟 LockSupport.park</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 实际上 LockSupport.park 底层实现就是依靠 UnSafe.park阻塞当前线程</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 当 balancing unpark 发生或 balancing unpark 已经发生恢复线程被中断后恢复</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 如果 absolute=false 并且 time 非零，等待 time 时间后恢复；</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 如果 absolute=true 并且 time 非零；或参数 time 过期，线程恢复或虚假恢复</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// park 当前线程，当前线程进入等待状态，并等待被唤醒</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">park</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, time);  </span><span style="color:#6A737D;">// emulate LockSupport.park</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 到这里说明线程被唤醒，将 node.thread 设置为 null</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 因为 node 结点是 dummy 结点，因此不会对线程有影响</span></span>
<span class="line"><span style="color:#24292E;">                node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 清空对 wt 对象的引用</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (interruptible </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">interrupted</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 如果线程可中断或者已经被中断，取消等待</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, node, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryWriteLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, next;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// ((s = state) &amp; ABITS) == 0L 读写锁均空闲</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ((((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">             U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT)) </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">            next </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlockWrite</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    WNode h;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// state != stamp stamp 不匹配</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// (stamp &amp; WBIT) == 0L 或写锁处于空闲</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> ORIGIN </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> stamp;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">readLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state, next;  </span><span style="color:#6A737D;">// bypass acquireRead on common uncontended case</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// (whead == wtail &amp;&amp; (s &amp; ABITS) &lt; RFULL 读锁持有数为达到最大值</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ((whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> wtail </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">             U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT)) </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">            next </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireRead</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireRead</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> interruptible, </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> deadline) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// node 表示当前线程结点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// p 表示尾结点</span></span>
<span class="line"><span style="color:#24292E;">    WNode node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, p;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;;) {</span></span>
<span class="line"><span style="color:#24292E;">        WNode h;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 如果头尾结点相等 h = whead = p = wtail 表示当前只有 node 等待获取</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wtail)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> m, s, ns;;) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// (m = (s = state) &amp; ABITS) &lt; RFULL 表示读锁持有数未达到最大值</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 则尝试 CAS 获取读锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT) </span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// m &lt; WBIT 表示当前存在读锁</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 如果读锁持有超过最大持有数，先尝试获取锁，成功后增大最大持有数</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// ++readerOverflow</span></span>
<span class="line"><span style="color:#24292E;">                    (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryIncReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ns;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> WBIT) { </span><span style="color:#6A737D;">// 当前存在写锁</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (LockSupport.</span><span style="color:#6F42C1;">nextSecondarySeed</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 自旋获取读锁</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">spins;</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 自旋结束还是没获取到锁</span></span>
<span class="line"><span style="color:#24292E;">                            WNode nh </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead, np </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wtail;</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// h = whead</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// p = wtail</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((nh </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> np </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nh) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> (p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np))</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                        }</span></span>
<span class="line"><span style="color:#24292E;">                        spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SPINS;</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 到这里，说明自旋获取读锁未成功</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (p </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// initialize queue 初始化队列</span></span>
<span class="line"><span style="color:#24292E;">            WNode hd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;">(WMODE, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 创建 dummy head</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, WHEAD, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, hd))</span></span>
<span class="line"><span style="color:#24292E;">                wtail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hd;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (node </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WNode</span><span style="color:#24292E;">(RMODE, p); </span><span style="color:#6A737D;">// 创建 node，前驱 p = wtail</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> p.mode </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> RMODE) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (node.prev </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> p)</span></span>
<span class="line"><span style="color:#24292E;">                node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, WTAIL, p, node)) {</span></span>
<span class="line"><span style="color:#24292E;">                p.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// CAS 设置 cowait，即将 node 加入等待队列</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(p, WCOWAIT, node.cowait </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.cowait, node))</span></span>
<span class="line"><span style="color:#24292E;">            node.cowait </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 到这里说明 node 已经在队列中</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// pp 表示 p 的前驱</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// c = h.cowait</span></span>
<span class="line"><span style="color:#24292E;">                WNode pp, c; Thread w;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> h.cowait) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                    (w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c.thread) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// help release</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(w); </span><span style="color:#6A737D;">// 唤醒 h = whead 的后继读结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.prev) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> pp </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> m, s, ns;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 尝试获取读锁</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">                            U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s,</span></span>
<span class="line"><span style="color:#24292E;">                                                 ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT) </span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">                            (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                             (ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryIncReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ns;</span></span>
<span class="line"><span style="color:#24292E;">                    } </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> WBIT);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> p.prev </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> pp) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> time;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 抛弃已取消的结点</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pp </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> p.status </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// p.status = CANCELLED = 1 &gt; 0</span></span>
<span class="line"><span style="color:#24292E;">                        node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// throw away</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (deadline </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> deadline </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">nanoTime</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, p, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    Thread wt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wt;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> pp </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                        whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> p.prev </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> pp)</span></span>
<span class="line"><span style="color:#24292E;">                        U.</span><span style="color:#6F42C1;">park</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, time); </span><span style="color:#6A737D;">// 还是没获取到锁，park 当前线程 time 时间</span></span>
<span class="line"><span style="color:#24292E;">                    node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (interruptible </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">interrupted</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, p, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;;) {</span></span>
<span class="line"><span style="color:#24292E;">        WNode h, np, pp; </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ps;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                spins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HEAD_SPINS;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (spins </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> MAX_HEAD_SPINS)</span></span>
<span class="line"><span style="color:#24292E;">                spins </span><span style="color:#D73A49;">&lt;&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> k </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spins;;) { </span><span style="color:#6A737D;">// spin at head 头结点自旋获取锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> m, s, ns;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL </span><span style="color:#D73A49;">?</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT) </span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">                    (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (ns </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryIncReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)) {</span></span>
<span class="line"><span style="color:#24292E;">                    WNode c; Thread w;</span></span>
<span class="line"><span style="color:#24292E;">                    whead </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;</span></span>
<span class="line"><span style="color:#24292E;">                    node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> ((c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node.cowait) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(node, WCOWAIT,</span></span>
<span class="line"><span style="color:#24292E;">                                                   c, c.cowait) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                            (w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c.thread) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                            U.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(w);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ns;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> WBIT </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                         LockSupport.</span><span style="color:#6F42C1;">nextSecondarySeed</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">k </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            WNode c; Thread w;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> ((c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> h.cowait) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapObject</span><span style="color:#24292E;">(h, WCOWAIT, c, c.cowait) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                    (w </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c.thread) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">unpark</span><span style="color:#24292E;">(w);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((np </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node.prev) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> p) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (np </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    (p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np).next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;   </span><span style="color:#6A737D;">// stale 唤醒队列中后继结点</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((ps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.status) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">compareAndSwapInt</span><span style="color:#24292E;">(p, WSTATUS, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, WAITING);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ps </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> CANCELLED) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p.prev) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pp;</span></span>
<span class="line"><span style="color:#24292E;">                    pp.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> time;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (deadline </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> deadline </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">nanoTime</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, node, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                Thread wt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wt;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (p.status </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                    (p </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                    whead </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> h </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> node.prev </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> p)</span></span>
<span class="line"><span style="color:#24292E;">                    U.</span><span style="color:#6F42C1;">park</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, time);</span></span>
<span class="line"><span style="color:#24292E;">                node.thread </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                U.</span><span style="color:#6F42C1;">putObject</span><span style="color:#24292E;">(wt, PARKBLOCKER, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (interruptible </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">interrupted</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cancelWaiter</span><span style="color:#24292E;">(node, node, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReadLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, m, next;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未满</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryIncReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 读锁持有数已满，尝试自增</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlockRead</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s, m; WNode h;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 满足条件释放读锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">            (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未满，正常释放</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, s </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> RUNIT)) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryDecReaderOverflow</span><span style="color:#24292E;">(s) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 读锁持有数超过最大值，尝试减少</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试获取乐观锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryOptimisticRead</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> s;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 验证乐观锁 stamp</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">validate</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    U.</span><span style="color:#6F42C1;">loadFence</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 解锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS, m, s; WNode h;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS)) { </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 当前锁未被持有</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) { </span><span style="color:#6A737D;">// 当前锁被写线程持有</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> m) </span><span style="color:#6A737D;">// 校验写线程的标志位是否等于给定的标志位</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> ORIGIN </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> s; </span><span style="color:#6A737D;">// 更新锁的状态</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> WBIT) </span><span style="color:#6A737D;">// 给定标志位为 0 或大于等于 WBIT，即非读锁标志位</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 当前锁被读线程持有</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, s </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> RUNIT)) { </span><span style="color:#6A737D;">// 尝试释放读锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryDecReaderOverflow</span><span style="color:#24292E;">(s) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 尝试释放读锁并减少溢出</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成写锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryConvertToWriteLock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS, m, s, next;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 当前锁空闲</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 锁状态位不为 0，表示锁已经被获取</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT)) </span><span style="color:#6A737D;">// 直接获取写锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) { </span><span style="color:#6A737D;">// 当前已经持有写锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> m)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> stamp;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 当前持有读锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s,</span></span>
<span class="line"><span style="color:#24292E;">                                     next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> WBIT)) </span><span style="color:#6A737D;">// 释放读锁获取写锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成读锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryConvertToReadLock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS, m, s, next; WNode h;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS)) { </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 锁空闲，直接获取</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 读锁持有数未达到最大</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryIncReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 读锁持有数溢出，尝试增加并获取读锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) { </span><span style="color:#6A737D;">// 当前持有写锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> m)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// s + (WBIT + RUNIT) 可以看成 (s + WBIT) + RUNIT 先释放写锁在获取读锁</span></span>
<span class="line"><span style="color:#24292E;">            state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (WBIT </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> RUNIT);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> WBIT)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> stamp;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 尝试转换成乐观锁</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryConvertToOptimisticRead</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> stamp) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// a = stamp &amp; ABITS a 表示锁的状态位</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS, m, s, next; WNode h;</span></span>
<span class="line"><span style="color:#24292E;">    U.</span><span style="color:#6F42C1;">loadFence</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 加载屏障</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (((s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> state) </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> (stamp </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS)) </span><span style="color:#6A737D;">// 判断当前锁的状态是否等于给定 stamp 的状态</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> ABITS) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 当前锁空闲</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 锁被抢占，无法转换成乐观锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> s; </span><span style="color:#6A737D;">// 否则获取乐观锁成功</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> WBIT) { </span><span style="color:#6A737D;">// 当前线程持有写锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> m) </span><span style="color:#6A737D;">// 无法转换成乐观锁</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// s = s + WBIT 释放写锁，返回解锁后的 s 作为乐观锁的 stamp</span></span>
<span class="line"><span style="color:#24292E;">            state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (s </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> WBIT) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> ORIGIN </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> s;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 判断是否存在等待结点，存在则释放等待结点</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// a == 0L 表示当前线程没有获取到锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// a &gt;= WBIT 表示当前存在写锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 转换成乐观锁失败</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> WBIT)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> RFULL) { </span><span style="color:#6A737D;">// 当前持有读锁，释放读锁，获取乐观锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (U.</span><span style="color:#6F42C1;">compareAndSwapLong</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, STATE, s, next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> RUNIT)) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (m </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> RUNIT </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> whead) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryDecReaderOverflow</span><span style="color:#24292E;">(s)) </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> next </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> SBITS;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0L</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br><span class="line-number">626</span><br><span class="line-number">627</span><br><span class="line-number">628</span><br><span class="line-number">629</span><br><span class="line-number">630</span><br><span class="line-number">631</span><br><span class="line-number">632</span><br><span class="line-number">633</span><br><span class="line-number">634</span><br></div></div><br><h2 id="工具类" tabindex="-1">工具类 <a class="header-anchor" href="#工具类" aria-label="Permalink to &quot;工具类&quot;">​</a></h2><br><h3 id="semaphore" tabindex="-1">Semaphore <a class="header-anchor" href="#semaphore" aria-label="Permalink to &quot;Semaphore&quot;">​</a></h3><blockquote><p>计数信号量，一个信号量维护一组 permit。如果 permit 不可用，调用 acquire 会阻塞线程，直到信号量可用；每次调用 release 方法都会增加 permit。需要注意的是，并没有实际存在的 permit 对象，Semaphore 只是维护了一个计数器代表 permit（实际上就是基于 AQS的 state）。</p><p>信号量通常用于限制可以访问某些资源的线程数。一个初始值为 1 的信号量，在使用时最多只有一个 permit 可用，可以当作独占锁。这就是二进制信号，因为它只有两种状态，可用和不可用。 这在一些特殊情况下很有用，比如说死锁恢复。因为 release 可以由别的线程调用。</p></blockquote><blockquote><p><strong>公平/非公平</strong> Semaphore 类的其中一个构造方法接收一个公平性参数，用于获取公平/非公平信号量，非公平允许竞争，公平保证 FIFO。默认情况下，总是返回非公平的实例。同样的，tryXXX 方法不遵循公平规定。 一般来说，保证公平性能够确保线程不会长时间饥饿；使用非公平性能获得更高的吞吐量。</p></blockquote><blockquote><p><strong>内存一致性</strong> 一个线程调用 release 方法 happen-before 另一个线程调用 acquire 方法</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Semaphore</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> java.io.</span><span style="color:#B392F0;">Serializable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Semaphore</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> java.io.</span><span style="color:#6F42C1;">Serializable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>Usage</strong></p><blockquote><p>Before obtaining an item each thread must acquire a permit from the semaphore, guaranteeing that an item is available for use. When the thread has finished with the item it is returned back to the pool and a permit is returned to the semaphore, allowing another thread to acquire that item.</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Pool</span><span style="color:#E1E4E8;"> {    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> MAX_AVAILABLE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">;    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Semaphore available </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Semaphore</span><span style="color:#E1E4E8;">(MAX_AVAILABLE, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getItem</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> InterruptedException {      </span></span>
<span class="line"><span style="color:#E1E4E8;">        available.</span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getNextAvailableItem</span><span style="color:#E1E4E8;">();    </span></span>
<span class="line"><span style="color:#E1E4E8;">    }      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">putItem</span><span style="color:#E1E4E8;">(Object </span><span style="color:#FFAB70;">x</span><span style="color:#E1E4E8;">) {      </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">markAsUnused</span><span style="color:#E1E4E8;">(x))        </span></span>
<span class="line"><span style="color:#E1E4E8;">        available.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">();    </span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Pool</span><span style="color:#24292E;"> {    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> MAX_AVAILABLE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">;    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Semaphore available </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Semaphore</span><span style="color:#24292E;">(MAX_AVAILABLE, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getItem</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> InterruptedException {      </span></span>
<span class="line"><span style="color:#24292E;">        available.</span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getNextAvailableItem</span><span style="color:#24292E;">();    </span></span>
<span class="line"><span style="color:#24292E;">    }      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">putItem</span><span style="color:#24292E;">(Object </span><span style="color:#E36209;">x</span><span style="color:#24292E;">) {      </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">markAsUnused</span><span style="color:#24292E;">(x))        </span></span>
<span class="line"><span style="color:#24292E;">        available.</span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">();    </span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><br><h4 id="内部类-4" tabindex="-1">内部类 <a class="header-anchor" href="#内部类-4" aria-label="Permalink to &quot;内部类&quot;">​</a></h4><h5 id="sync-2" tabindex="-1">Sync <a class="header-anchor" href="#sync-2" aria-label="Permalink to &quot;Sync&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AbstractQueuedSynchronizer</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AbstractQueuedSynchronizer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 实际上 permit 就是 state</span></span>
<span class="line"><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> permits) { </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(permits); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getPermits</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); }</span></span>
<span class="line"><span style="color:#6A737D;">// 获取非公平共享信号量</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">nonfairTryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> available </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> remaining </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> available </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> acquires;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (remaining </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(available, remaining))</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> remaining;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 释放共享信号量</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReleaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> releases) {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 实际上 permit 就是 state</span></span>
<span class="line"><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> permits) { </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(permits); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getPermits</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); }</span></span>
<span class="line"><span style="color:#6A737D;">// 获取非公平共享信号量</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">nonfairTryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> available </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> remaining </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> available </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> acquires;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (remaining </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(available, remaining))</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> remaining;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 释放共享信号量</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReleaseShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> releases) {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><br><h5 id="fairsync-2" tabindex="-1">FairSync <a class="header-anchor" href="#fairsync-2" aria-label="Permalink to &quot;FairSync&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">hasQueuedPredecessors</span><span style="color:#E1E4E8;">()) </span><span style="color:#6A737D;">// 检查是否有队列在等待获取信号量</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> available </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> remaining </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> available </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> acquires;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (remaining </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(available, remaining))</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> remaining;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">hasQueuedPredecessors</span><span style="color:#24292E;">()) </span><span style="color:#6A737D;">// 检查是否有队列在等待获取信号量</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> available </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> remaining </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> available </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> acquires;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (remaining </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(available, remaining))</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> remaining;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><br><h5 id="nonfairsync-2" tabindex="-1">NonfairSync <a class="header-anchor" href="#nonfairsync-2" aria-label="Permalink to &quot;NonfairSync&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">//  获取共享信号量</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">nonfairTryAcquireShared</span><span style="color:#E1E4E8;">(acquires);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">//  获取共享信号量</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">nonfairTryAcquireShared</span><span style="color:#24292E;">(acquires);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="内部方法-4" tabindex="-1">内部方法 <a class="header-anchor" href="#内部方法-4" aria-label="Permalink to &quot;内部方法&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 获取信号量，permit - 1，如果不可用则阻塞知道获取成功或当前线程中断</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Acquires in shared mode, aborting if interrupted.</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync.</span><span style="color:#B392F0;">acquireSharedInterruptibly</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 不遵守公平规则获取 permit，如果不可用则阻塞知道获取成功或当前线程中断</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> sync.</span><span style="color:#B392F0;">nonfairTryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 释放信号量，permit + 1</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync.</span><span style="color:#B392F0;">releaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 获取信号量，permit - 1，如果不可用则阻塞知道获取成功或当前线程中断</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Acquires in shared mode, aborting if interrupted.</span></span>
<span class="line"><span style="color:#24292E;">    sync.</span><span style="color:#6F42C1;">acquireSharedInterruptibly</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 不遵守公平规则获取 permit，如果不可用则阻塞知道获取成功或当前线程中断</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> sync.</span><span style="color:#6F42C1;">nonfairTryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 释放信号量，permit + 1</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sync.</span><span style="color:#6F42C1;">releaseShared</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><br><h3 id="countdownlatch" tabindex="-1">CountDownLatch <a class="header-anchor" href="#countdownlatch" aria-label="Permalink to &quot;CountDownLatch&quot;">​</a></h3><blockquote><p>一个同步辅助工具，允许一个或多个线程等待，直到其他线程中正在执行的一组操作完成。可以使用一个给定的计数来初始化 CountDownLatch。线程调用 await 方法后会进入阻塞，直到计数器由于 countDown 方法减为 0，处于等待的线程被唤醒执行。CyclicBarrier 的作用与 CountDownLatch 相反</p></blockquote><blockquote><p>CountDownLatch 是一个多功能的同步工具，可用于多种用途。一个初始化为 1 的 CountDownLatch 可以作为一个简单的开/关锁：所有调用 await 的线程都在等待，直到 countDown 调用到计数为 0；一个初始化为 N 的 CountDownLatch 可以用来让一个线程等待，直到 N 个线程执行完成，或者某个操作已经完成了 N 次。</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CountDownLatch</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CountDownLatch</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>内部/类/属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AbstractQueuedSynchronizer</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">count</span><span style="color:#E1E4E8;">) { </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(count); }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getCount</span><span style="color:#E1E4E8;">() { </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">(); }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquireShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">acquires</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryReleaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">releases</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Decrement count; signal when transition to zero</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(c, nextc))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CountDownLatch</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> count) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (count </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalArgumentException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;count &lt; 0&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.sync </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;">(count);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">countDown</span><span style="color:#E1E4E8;">() { sync.</span><span style="color:#B392F0;">releaseShared</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); }</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync.</span><span style="color:#B392F0;">acquireSharedInterruptibly</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AbstractQueuedSynchronizer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">count</span><span style="color:#24292E;">) { </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(count); }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getCount</span><span style="color:#24292E;">() { </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">(); }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquireShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">acquires</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryReleaseShared</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">releases</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Decrement count; signal when transition to zero</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(c, nextc))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CountDownLatch</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (count </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalArgumentException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;count &lt; 0&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.sync </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;">(count);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">countDown</span><span style="color:#24292E;">() { sync.</span><span style="color:#6F42C1;">releaseShared</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); }</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292E;">    sync.</span><span style="color:#6F42C1;">acquireSharedInterruptibly</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>Usage</strong></p><br><h3 id="cyclicbarrier" tabindex="-1">CyclicBarrier <a class="header-anchor" href="#cyclicbarrier" aria-label="Permalink to &quot;CyclicBarrier&quot;">​</a></h3><blockquote><p>一个同步辅助工具，允许一组线程互相等待，以达到指定的触发值。效果和 CountDownLatch 相反。屏障被称为循环的，因为它在等待的线程被释放后可以被重新使用，使用 reset 方法会重新生成一个 Generation，即可重新利用 CyclicBarrier。 CyclicBarrier 支持一个可选的 Runnable 命令，该命令在最后一个线程到达之后，在释放任何线程之前，运行一次</p></blockquote><blockquote><p><strong>内存一致性</strong> 一个线程调用 await 操作 happen-before 屏障操作；而屏障操作又 happen-before 其他线程成功调用 await 后执行的操作</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CyclicBarrier</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CyclicBarrier</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// barrier 的每次使用都被表示为一个 Generation 实例，barrier 改变时 Generation 实例也会跟着变化。可能会有很多 Generation 实例和使用 barrier 的线程相关联。</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Generation</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> broken </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 指定触发值，创建 CyclicBarrier 实例</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CyclicBarrier</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> parties) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">(parties, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 指定触发值 parties，并指定达到触发值后运行的操作 barrierAction，创建 CyclicBarrier 实例</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CyclicBarrier</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> parties, Runnable barrierAction) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (parties </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalArgumentException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.parties </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parties;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.count </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parties;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.barrierCommand </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> barrierAction;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Resets the barrier to its initial state.</span></span>
<span class="line"><span style="color:#6A737D;">// If any parties are currently waiting at the barrier, they will return with a BrokenBarrierException.</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">reset</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ReentrantLock lock </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.lock;</span></span>
<span class="line"><span style="color:#E1E4E8;">    lock.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">breakBarrier</span><span style="color:#E1E4E8;">();   </span><span style="color:#6A737D;">// break the current generation</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">nextGeneration</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// start a new generation</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        lock.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// barrier 的每次使用都被表示为一个 Generation 实例，barrier 改变时 Generation 实例也会跟着变化。可能会有很多 Generation 实例和使用 barrier 的线程相关联。</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Generation</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> broken </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 指定触发值，创建 CyclicBarrier 实例</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CyclicBarrier</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> parties) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">(parties, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 指定触发值 parties，并指定达到触发值后运行的操作 barrierAction，创建 CyclicBarrier 实例</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CyclicBarrier</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> parties, Runnable barrierAction) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (parties </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalArgumentException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.parties </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parties;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parties;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.barrierCommand </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> barrierAction;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Resets the barrier to its initial state.</span></span>
<span class="line"><span style="color:#6A737D;">// If any parties are currently waiting at the barrier, they will return with a BrokenBarrierException.</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">reset</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ReentrantLock lock </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.lock;</span></span>
<span class="line"><span style="color:#24292E;">    lock.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">breakBarrier</span><span style="color:#24292E;">();   </span><span style="color:#6A737D;">// break the current generation</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">nextGeneration</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// start a new generation</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        lock.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>Usage</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CyclicBarrierTest</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        CyclicBarrier barrier </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CyclicBarrier</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;All works done&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Thread</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; =&gt; DONE&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    barrier.</span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 当前线程工作完成，进入等待</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RuntimeException</span><span style="color:#E1E4E8;">(e);</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BrokenBarrierException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RuntimeException</span><span style="color:#E1E4E8;">(e);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }, </span><span style="color:#9ECBFF;">&quot;th-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i).</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CyclicBarrierTest</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        CyclicBarrier barrier </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CyclicBarrier</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">7</span><span style="color:#24292E;">, () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;All works done&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        });</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Thread</span><span style="color:#24292E;">(() </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; =&gt; DONE&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    barrier.</span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 当前线程工作完成，进入等待</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(e);</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BrokenBarrierException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(e);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }, </span><span style="color:#032F62;">&quot;th-&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i).</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><br><h3 id="phaser" tabindex="-1">Phaser <a class="header-anchor" href="#phaser" aria-label="Permalink to &quot;Phaser&quot;">​</a></h3><blockquote><p>分段锁，一个可重用的同步屏障，在功能上与 CyclicBarrier 和 CountDownLatch 相似，但更灵活。它允许多个线程协调执行，并在到达同步点时同步它们的进度。</p><p>Phaser 中最基本的概念是“阶段（phase）”，它代表了一个同步点。Phaser 可以有任意数量的阶段，每个阶段都有一个唯一的标识符。</p></blockquote><blockquote><p>Phaser 的主要操作是 arrive 和 awaitAdvance</p><ul><li><p>arrive 方法通知 Phaser 当前线程已经到达当前阶段的同步点，它会阻塞等待所有其他线程到达。一旦所有线程都到达，Phaser 会将阶段递增，并唤醒所有等待的线程。</p></li><li><p>awaitAdvance 方法允许线程等待 Phaser 进入下一个阶段。该方法返回当前阶段的标识符，如果 Phaser 已经进入了下一个阶段，则该方法将一直阻塞，直到进入下一个阶段为止。</p></li></ul><p>Phaser 还提供了其他一些方法，例如 register，允许线程将自己注册到 Phaser 中，以便在 Phaser 进入下一个阶段时被唤醒。Phaser 还提供了一些高级功能，例如可中断的等待和超时等待。</p><p>Phaser 是一种非常灵活和可扩展的同步器，可以用于许多不同的并发场景，例如分段并发执行，分治算法，以及多线程任务的分组等。</p></blockquote><blockquote><p><strong>注册</strong> 线程任务可以在任何时候将自己注册到 Phaser。可以使用 register/bulkRegister 方法注册或构造器注册；也可以在任何到达的时候使用 arriveAndDeregister 取消注册。 注册和注销只影响内部 count 计数，外部线程任务不能查询它们是否被注册。</p></blockquote><blockquote><p><strong>同步机制</strong> 和 CyclicBarrier 一样，Phaser 可以被反复 await，arriveAndAwaitAdvance 方法的效果类似于 CyclicBarrier.await。 每一段 phaser 都有一个与之相对应的 phase number，phase number 从 0 开始。当所有的注册的线程任务都达到 phase 时 phase number + 1，在达到 Integer.MAX_VALUE 后重置为 0。</p><p>phase number 可以独立控制<strong>到达某一阶段 phaser</strong>和<strong>等待其他线程</strong>这两个动作</p><ul><li>Arrival arrive 和 arriveAndDeregister 方法负责记到达状态，这两个方法不会阻塞，会返回相关的 arrival phase number 用来确认到达状态。当所有注册的线程任务都到达了同一个 phase，一个可选的 action 就会执行，phase 也会向前推进。可选操作通过重写 onAdvance 方法实现，通常可以用来控制终止状态，此方法类似于 CyclicBarrier 提供的 barrierAction，但比它更灵活。</li><li>Waiting awaitAdvance 方法需要一个表示 arrival phase number 的参数，并且在 phaser 前进到与给定 phase 不同的 phase 时返回。和 CyclicBarrier 不同，即使等待线程已经被中断，awaitAdvance 方法也会一直等待。中断状态和超时时间同样可用，但是当任务等待中断或超时后未改变 phaser 的状态时会报异常。如果有必要，在方法 forceTermination 之后可以执行这些异常的相关的 handler 进行恢复操作。Phaser 也可能被 ForkJoinPool 中的任务使用，这样在其他任务阻塞等待一个 phase 时可以保证足够的并行度来执行任务。</li></ul></blockquote><blockquote><p><strong>终止机制</strong> 可以使用 isTerminated 方法检查 Phaser 是否处于终止状态。一旦终止，所有的 arrive 方法立即返回负数。在终止时注册是无效的。当调用 onAdvance 返回 true 时 Termination 被触发。当 deregistration 操作使已注册的线程任务变为 0 时，onAdvance 的默认实现就会返回 true。也可以重写 onAdvance 方法来定义终止动作。forceTermination 方法也可以释放等待线程并且允许它们终止。</p></blockquote><blockquote><p><strong>分层结构</strong> Phaser 支持分层结构(树状构造)来减少竞争。注册了大量线程任务的 Phaser 可能会因为同步竞争消耗很高的成本，因此可以设置一些子 Phaser 来共享一个通用的 parent。即使每个操作消耗了更多的开销，也能提高整体吞吐量。 在一棵分层 Phaser 树中，子 Phaser 与其父 Phaser 的注册和取消注册由父结点自动管理。 每当子 Phaser 注册数量不为 0，该 Phaser 就会向其父 Phaser 进行注册。 每当 arriveAndDeregister 调用后发现注册数量变为零时，该子 Phaser 将从其父 Phaser 中取消注册。</p></blockquote><blockquote><p><strong>状态监控</strong> 虽然同步方法只能由注册方调用，但 Phaser 的当前状态可由任何调用者监控。在任何给定的时刻，总共有 getRegisteredParties 个参与者，其中 getArrivedParties 个已经到达了当前阶段(getPhase)。当剩余的参与者（getUnarrivedParties）到达时，该阶段向前推进。</p><p>这些方法返回的值可能会反映出瞬态状态，因此通常不适合用于同步控制。toString 方法能以非正式监测的形式返回这些状态查询快照。</p></blockquote><p><strong>内部类/属性/方法</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">QNode</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ForkJoinPool.ManagedBlocker</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">volatile</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> state;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 注册一个新的 party</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">register</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#6A737D;">// 批量注册</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">bulkRegister</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> parties)</span></span>
<span class="line"><span style="color:#6A737D;">// 使当前线程到达 phaser，不等待其他任务到达。返回 arrival phase number</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">arrive</span><span style="color:#E1E4E8;">() </span></span>
<span class="line"><span style="color:#6A737D;">// 使当前线程到达 phaser 并撤销注册，返回 arrival phase number</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">arriveAndDeregister</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 使当前线程到达 phaser 并等待其他任务到达，等价于 awaitAdvance(arrive())。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果需要等待中断或超时，可以使用 awaitAdvance 方法完成一个类似的构造。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果需要在到达后取消注册，可以使用 awaitAdvance(arriveAndDeregister())。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">arriveAndAwaitAdvance</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#6A737D;">//等待给定 phase 数，返回下一个 arrival phase number</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awaitAdvance</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> phase)</span></span>
<span class="line"><span style="color:#6A737D;">//阻塞等待，直到 phase 前进到下一代，返回下一代的 phase number</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awaitAdvance</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> phase) </span></span>
<span class="line"><span style="color:#6A737D;">//响应中断版 awaitAdvance</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awaitAdvanceInterruptibly</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> phase) throws InterruptedException</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awaitAdvanceInterruptibly</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> phase, </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#E1E4E8;">    throws InterruptedException, TimeoutException</span></span>
<span class="line"><span style="color:#6A737D;">//使当前 phaser 进入终止状态，已注册的 parties 不受影响，如果是分层结构，则终止所有 phaser</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">forceTermination</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">QNode</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ForkJoinPool.ManagedBlocker</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">volatile</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> state;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 注册一个新的 party</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">register</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#6A737D;">// 批量注册</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">bulkRegister</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> parties)</span></span>
<span class="line"><span style="color:#6A737D;">// 使当前线程到达 phaser，不等待其他任务到达。返回 arrival phase number</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">arrive</span><span style="color:#24292E;">() </span></span>
<span class="line"><span style="color:#6A737D;">// 使当前线程到达 phaser 并撤销注册，返回 arrival phase number</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">arriveAndDeregister</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 使当前线程到达 phaser 并等待其他任务到达，等价于 awaitAdvance(arrive())。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果需要等待中断或超时，可以使用 awaitAdvance 方法完成一个类似的构造。</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果需要在到达后取消注册，可以使用 awaitAdvance(arriveAndDeregister())。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">arriveAndAwaitAdvance</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#6A737D;">//等待给定 phase 数，返回下一个 arrival phase number</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awaitAdvance</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> phase)</span></span>
<span class="line"><span style="color:#6A737D;">//阻塞等待，直到 phase 前进到下一代，返回下一代的 phase number</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awaitAdvance</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> phase) </span></span>
<span class="line"><span style="color:#6A737D;">//响应中断版 awaitAdvance</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awaitAdvanceInterruptibly</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> phase) throws InterruptedException</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awaitAdvanceInterruptibly</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> phase, </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#24292E;">    throws InterruptedException, TimeoutException</span></span>
<span class="line"><span style="color:#6A737D;">//使当前 phaser 进入终止状态，已注册的 parties 不受影响，如果是分层结构，则终止所有 phaser</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">forceTermination</span><span style="color:#24292E;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><br><p><strong>Usage</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">runTasks</span><span style="color:#E1E4E8;">(List</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">Runnable</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> tasks) {    </span></span>
<span class="line"><span style="color:#E1E4E8;">	 </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Phaser phaser </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Phaser</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#E1E4E8;">	 </span><span style="color:#6A737D;">// create and start threads    </span></span>
<span class="line"><span style="color:#E1E4E8;">	 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Runnable task </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tasks) {      </span></span>
<span class="line"><span style="color:#E1E4E8;">		 phaser.</span><span style="color:#B392F0;">register</span><span style="color:#E1E4E8;">();      </span></span>
<span class="line"><span style="color:#E1E4E8;">		 </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Thread</span><span style="color:#E1E4E8;">() {        </span></span>
<span class="line"><span style="color:#E1E4E8;">			 </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">run</span><span style="color:#E1E4E8;">() {          </span></span>
<span class="line"><span style="color:#E1E4E8;">			     phaser.</span><span style="color:#B392F0;">arriveAndAwaitAdvance</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// await all creation</span></span>
<span class="line"><span style="color:#E1E4E8;">					task.</span><span style="color:#B392F0;">run</span><span style="color:#E1E4E8;">();        </span></span>
<span class="line"><span style="color:#E1E4E8;">				}      </span></span>
<span class="line"><span style="color:#E1E4E8;">			}.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();    </span></span>
<span class="line"><span style="color:#E1E4E8;">		}      </span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// allow threads to start and deregister self</span></span>
<span class="line"><span style="color:#E1E4E8;">		phaser.</span><span style="color:#B392F0;">arriveAndDeregister</span><span style="color:#E1E4E8;">();  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">runTasks</span><span style="color:#24292E;">(List</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">Runnable</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> tasks) {    </span></span>
<span class="line"><span style="color:#24292E;">	 </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Phaser phaser </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Phaser</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#24292E;">	 </span><span style="color:#6A737D;">// create and start threads    </span></span>
<span class="line"><span style="color:#24292E;">	 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Runnable task </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tasks) {      </span></span>
<span class="line"><span style="color:#24292E;">		 phaser.</span><span style="color:#6F42C1;">register</span><span style="color:#24292E;">();      </span></span>
<span class="line"><span style="color:#24292E;">		 </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Thread</span><span style="color:#24292E;">() {        </span></span>
<span class="line"><span style="color:#24292E;">			 </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">() {          </span></span>
<span class="line"><span style="color:#24292E;">			     phaser.</span><span style="color:#6F42C1;">arriveAndAwaitAdvance</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// await all creation</span></span>
<span class="line"><span style="color:#24292E;">					task.</span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">();        </span></span>
<span class="line"><span style="color:#24292E;">				}      </span></span>
<span class="line"><span style="color:#24292E;">			}.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();    </span></span>
<span class="line"><span style="color:#24292E;">		}      </span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// allow threads to start and deregister self</span></span>
<span class="line"><span style="color:#24292E;">		phaser.</span><span style="color:#6F42C1;">arriveAndDeregister</span><span style="color:#24292E;">();  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>...</p></blockquote><br><h2 id="并发集合" tabindex="-1">并发集合 <a class="header-anchor" href="#并发集合" aria-label="Permalink to &quot;并发集合&quot;">​</a></h2><h3 id="concurrenthashmap" tabindex="-1">ConcurrentHashMap <a class="header-anchor" href="#concurrenthashmap" aria-label="Permalink to &quot;ConcurrentHashMap&quot;">​</a></h3><h3 id="copyonwritearraylist" tabindex="-1">CopyOnWriteArrayList <a class="header-anchor" href="#copyonwritearraylist" aria-label="Permalink to &quot;CopyOnWriteArrayList&quot;">​</a></h3><h3 id="concurrentskiplistmap" tabindex="-1">ConcurrentSkipListMap <a class="header-anchor" href="#concurrentskiplistmap" aria-label="Permalink to &quot;ConcurrentSkipListMap&quot;">​</a></h3><h3 id="concurrentskiplistset" tabindex="-1">ConcurrentSkipListSet <a class="header-anchor" href="#concurrentskiplistset" aria-label="Permalink to &quot;ConcurrentSkipListSet&quot;">​</a></h3><br><h2 id="atomic" tabindex="-1">Atomic <a class="header-anchor" href="#atomic" aria-label="Permalink to &quot;Atomic&quot;">​</a></h2><h3 id="atomicinteger" tabindex="-1">AtomicInteger <a class="header-anchor" href="#atomicinteger" aria-label="Permalink to &quot;AtomicInteger&quot;">​</a></h3><h3 id="atomiclong" tabindex="-1">AtomicLong <a class="header-anchor" href="#atomiclong" aria-label="Permalink to &quot;AtomicLong&quot;">​</a></h3><h3 id="atomicreference" tabindex="-1">AtomicReference <a class="header-anchor" href="#atomicreference" aria-label="Permalink to &quot;AtomicReference&quot;">​</a></h3><h3 id="atomicreferencearray" tabindex="-1">AtomicReferenceArray <a class="header-anchor" href="#atomicreferencearray" aria-label="Permalink to &quot;AtomicReferenceArray&quot;">​</a></h3><h3 id="atomicstampedreference" tabindex="-1">AtomicStampedReference <a class="header-anchor" href="#atomicstampedreference" aria-label="Permalink to &quot;AtomicStampedReference&quot;">​</a></h3><h3 id="doubleadder" tabindex="-1">DoubleAdder <a class="header-anchor" href="#doubleadder" aria-label="Permalink to &quot;DoubleAdder&quot;">​</a></h3><h3 id="longadder" tabindex="-1">LongAdder <a class="header-anchor" href="#longadder" aria-label="Permalink to &quot;LongAdder&quot;">​</a></h3></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><!----><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/posts/be/java/java-threadpool/Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Previous</span><span class="title" data-v-ef5dee53>Java 线程池</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/posts/be/java/io/Java-IO" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next</span><span class="title" data-v-ef5dee53>Java IO</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5a346dfe data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Power by Vitepress & Github Page</p><p class="copyright" data-v-e03eb2e1>Copyright © 2021-present GnL</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"posts_be_java_java-advance_java-进阶.md\":\"42abd51d\",\"posts_al_常见算法.md\":\"9bc8df87\",\"about.md\":\"a162070c\",\"posts_al_位运算.md\":\"5ecf9586\",\"posts_dp_index_index.md\":\"86e10ddd\",\"posts_dpl_index_index.md\":\"564bcd34\",\"posts_al_index_index.md\":\"5ef2f242\",\"posts_db_redis_redis.md\":\"83ebd6d8\",\"posts_be_java_jvm_jvm.md\":\"2ba04d00\",\"posts_be_java_java-collection_java-集合.md\":\"c313d7a9\",\"posts_fe_typescript_typescript.md\":\"cf218c1e\",\"index.md\":\"5976cc20\",\"posts_be_springmvc_springmvc.md\":\"129d7912\",\"posts_mw_index_index.md\":\"a194d817\",\"posts_db_mysql_mysql.md\":\"db6ed566\",\"posts_be_springsecurity_springsecurity.md\":\"78670d02\",\"posts_mw_elasticsearch_elasticsearch.md\":\"b66d3004\",\"recently.md\":\"4b0fcd1d\",\"posts_be_springcloud_springcloud.md\":\"95bfcc3d\",\"posts_be_java_io_java-io.md\":\"eb84996f\",\"posts_db_index_index.md\":\"2a58eedb\",\"posts_be_index_index.md\":\"2848fce1\",\"posts_be_dubbo_dubbo.md\":\"c4c4060c\",\"posts_be_java_java-basic_java-基础.md\":\"ea4ad302\",\"posts_be_java_index_java.md\":\"56198839\",\"posts_renew_spring_spring.md\":\"95e99988\",\"posts_be_spring_spring5.md\":\"c6b3eb7f\",\"posts_be_mybatis_mybatis.md\":\"d32e69e5\",\"posts_be_java_java-threadpool_java-线程池.md\":\"f6d25920\",\"posts_fe_vuejs_vuejs.md\":\"dff77e28\",\"posts_be_java_java-thread_java-多线程.md\":\"95811c4b\",\"posts_mw_kafka_kafka.md\":\"f4f60b5d\",\"posts_dp_设计模式.md\":\"e515ad08\",\"posts_mw_rocketmq_rocketmq.md\":\"b62cd2a5\",\"posts_renew_mysql_mysql.md\":\"8d44b32f\",\"posts_renew_redis_redis-数据类型.md\":\"16cbe99d\",\"posts_renew_redis_redis-配置详解.md\":\"9e22e5f6\",\"posts_dpl_nginx_nginx.md\":\"e5a33acd\",\"posts_fe_index_index.md\":\"9b5e1b9e\",\"posts_be_java_java-juc_java-juc.md\":\"13e136cd\",\"posts_fe_react_react.md\":\"47e06a33\",\"posts_be_springboot_springboot.md\":\"fdd2c0dc\",\"posts_fe_javascript_javascript.md\":\"db17f093\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Gnl\",\"description\":\"A VitePress site\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"./logo.jpeg\",\"nav\":[{\"text\":\"Recently\",\"link\":\"/recently\"},{\"text\":\"算法\",\"link\":\"posts/al/index/\"},{\"text\":\"前端\",\"items\":[{\"text\":\"JavaScript\",\"link\":\"/posts/fe/javascript/JavaScript\"},{\"text\":\"Vue.js\",\"link\":\"/posts/fe/vuejs/Vuejs\"},{\"text\":\"React\",\"link\":\"/posts/fe/react/React\"},{\"text\":\"TypeScript\",\"link\":\"/posts/fe/typescript/TypeScript\"}]},{\"text\":\"后端\",\"items\":[{\"text\":\"Java\",\"link\":\"/posts/be/java/index/Java\"},{\"text\":\"Spring5\",\"link\":\"/posts/be/spring/Spring5\"},{\"text\":\"Spring MVC\",\"link\":\"/posts/be/springmvc/SpringMVC\"},{\"text\":\"Spring Boot\",\"link\":\"/posts/be/springboot/SpringBoot\"},{\"text\":\"Spring Security\",\"link\":\"/posts/be/springsecurity/SpringSecurity\"},{\"text\":\"Spring Cloud\",\"link\":\"/posts/be/springcloud/SpringCloud\"},{\"text\":\"MyBatis\",\"link\":\"/posts/be/mybatis/MyBatis\"}]},{\"text\":\"数据库\",\"items\":[{\"text\":\"MySQL\",\"link\":\"/posts/db/mysql/MySQL\"},{\"text\":\"Redis\",\"link\":\"/posts/db/redis/Redis\"}]},{\"text\":\"中间件\",\"items\":[{\"text\":\"RocketMQ\",\"link\":\"/posts/mw/rocketmq/RocketMQ\"},{\"text\":\"Elasticsearch\",\"link\":\"/posts/mw/elasticsearch/Elasticsearch\"},{\"text\":\"Kafka\",\"link\":\"/posts/mw/kafka/Kafka\"},{\"text\":\"Nginx\",\"link\":\"/posts/mw/nginx/Nginx\"}]}],\"sidebar\":[{\"text\":\"算法\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/al/index/\"},{\"text\":\"位运算\",\"link\":\"/posts/al/位运算\"},{\"text\":\"常见算法\",\"link\":\"/posts/al/常见算法\"}]},{\"text\":\"设计模式\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/dp/index/\"},{\"text\":\"设计模式\",\"link\":\"/posts/dp/设计模式\"}]},{\"text\":\"前端\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/fe/index/\"},{\"text\":\"JavaScript\",\"link\":\"/posts/fe/javascript/JavaScript\"},{\"text\":\"Vue.js\",\"link\":\"/posts/fe/vuejs/Vuejs\"},{\"text\":\"React\",\"link\":\"/posts/fe/react/React\"},{\"text\":\"TypeScript\",\"link\":\"/posts/fe/typescript/TypeScript\"}]},{\"text\":\"后端\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/be/index/\"},{\"text\":\"Java\",\"link\":\"/posts/be/java/index/Java\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Java 基础\",\"link\":\"/posts/be/java/java-basic/Java-基础\"},{\"text\":\"Java 集合\",\"link\":\"/posts/be/java/java-collection/Java-集合\"},{\"text\":\"Java 多线程\",\"link\":\"/posts/be/java/java-thread/Java-多线程\"},{\"text\":\"Java 线程池\",\"link\":\"/posts/be/java/java-threadpool/Java-线程池\"},{\"text\":\"Java JUC\",\"link\":\"/posts/be/java/java-juc/Java-JUC\"},{\"text\":\"Java IO\",\"link\":\"/posts/be/java/io/Java-IO\"},{\"text\":\"Java 进阶\",\"link\":\"/posts/be/java/java-advance/Java-进阶\"}]},{\"text\":\"JVM\",\"link\":\"/posts/be/java/jvm/JVM\"},{\"text\":\"Spring5\",\"link\":\"/posts/be/spring/Spring5\"},{\"text\":\"Spring MVC\",\"link\":\"/posts/be/springmvc/SpringMVC\"},{\"text\":\"Spring Boot\",\"link\":\"/posts/be/springboot/SpringBoot\"},{\"text\":\"Spring Security\",\"link\":\"/posts/be/springsecurity/SpringSecurity\"},{\"text\":\"Spring Cloud\",\"link\":\"/posts/be/springcloud/SpringCloud\"},{\"text\":\"MyBatis\",\"link\":\"/posts/be/mybatis/MyBatis\"}]},{\"text\":\"数据库\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/db/index/\"},{\"text\":\"MySQL\",\"link\":\"/posts/db/mysql/MySQL\"},{\"text\":\"Redis\",\"link\":\"/posts/db/redis/Redis\"}]},{\"text\":\"中间件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/mw/index/\"},{\"text\":\"RocketMQ\",\"link\":\"/posts/mw/rocketmq/RocketMQ\"},{\"text\":\"Elasticsearch\",\"link\":\"/posts/mw/elasticsearch/Elasticsearch\"},{\"text\":\"Kafka\",\"link\":\"/posts/mw/kafka/Kafka\"},{\"text\":\"Nginx\",\"link\":\"/posts/mw/nginx/Nginx\"}]}],\"docFooter\":{\"prev\":\"Previous\",\"next\":\"Next\"},\"footer\":{\"message\":\"Power by Vitepress & Github Page\",\"copyright\":\"Copyright © 2021-present GnL\"}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":true}");</script>
    
  </body>
</html>