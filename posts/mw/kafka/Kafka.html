<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka | Gnl</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/assets/style.192b8fa9.css" as="style">
    
    <script type="module" src="/assets/app.ba26e238.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.834b76fb.js">
    <link rel="modulepreload" href="/assets/chunks/theme.759f3966.js">
    <link rel="modulepreload" href="/assets/posts_mw_kafka_Kafka.md.f4f60b5d.lean.js">
    <link rel="icon" href="./img/logo.jpeg">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="./logo.jpeg" alt data-v-8426fc1a><!--]--><!--[-->Gnl<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/recently" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Recently</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="posts/al/index/" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>算法</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>前端</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/javascript/JavaScript" data-v-43f1e123><!--[-->JavaScript<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/vuejs/Vuejs" data-v-43f1e123><!--[-->Vue.js<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/react/React" data-v-43f1e123><!--[-->React<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/fe/typescript/TypeScript" data-v-43f1e123><!--[-->TypeScript<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>后端</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/java/index/Java" data-v-43f1e123><!--[-->Java<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/spring/Spring5" data-v-43f1e123><!--[-->Spring5<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springmvc/SpringMVC" data-v-43f1e123><!--[-->Spring MVC<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springboot/SpringBoot" data-v-43f1e123><!--[-->Spring Boot<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springsecurity/SpringSecurity" data-v-43f1e123><!--[-->Spring Security<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/springcloud/SpringCloud" data-v-43f1e123><!--[-->Spring Cloud<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/be/mybatis/MyBatis" data-v-43f1e123><!--[-->MyBatis<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>数据库</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/db/mysql/MySQL" data-v-43f1e123><!--[-->MySQL<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/db/redis/Redis" data-v-43f1e123><!--[-->Redis<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>中间件</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/rocketmq/RocketMQ" data-v-43f1e123><!--[-->RocketMQ<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/elasticsearch/Elasticsearch" data-v-43f1e123><!--[-->Elasticsearch<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link active" href="/posts/mw/kafka/Kafka" data-v-43f1e123><!--[-->Kafka<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/posts/mw/nginx/Nginx" data-v-43f1e123><!--[-->Nginx<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>算法</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/%E4%BD%8D%E8%BF%90%E7%AE%97" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>位运算</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/al/%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>常见算法</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>设计模式</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/dp/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/dp/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>设计模式</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>前端</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/javascript/JavaScript" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JavaScript</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/vuejs/Vuejs" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Vue.js</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/react/React" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>React</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/fe/typescript/TypeScript" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>TypeScript</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>后端</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible collapsed is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/index/Java" data-v-e31bd47b><!--[--><h3 class="text" data-v-e31bd47b>Java</h3><!--]--></a><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-basic/Java-%E5%9F%BA%E7%A1%80" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-collection/Java-%E9%9B%86%E5%90%88" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 集合</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-thread/Java-%E5%A4%9A%E7%BA%BF%E7%A8%8B" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 多线程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-threadpool/Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 线程池</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-juc/Java-JUC" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java JUC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/io/Java-IO" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java IO</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/java-advance/Java-%E8%BF%9B%E9%98%B6" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java 进阶</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/java/jvm/JVM" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JVM</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/spring/Spring5" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring5</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springmvc/SpringMVC" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring MVC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springboot/SpringBoot" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Boot</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springsecurity/SpringSecurity" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Security</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/springcloud/SpringCloud" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Spring Cloud</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/be/mybatis/MyBatis" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MyBatis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible collapsed" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>数据库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/mysql/MySQL" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySQL</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/db/redis/Redis" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Redis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>中间件</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/index/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/rocketmq/RocketMQ" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>RocketMQ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/elasticsearch/Elasticsearch" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Elasticsearch</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/kafka/Kafka" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Kafka</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/posts/mw/nginx/Nginx" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Nginx</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _posts_mw_kafka_Kafka" data-v-6b87e69f><div><h1 id="kafka" tabindex="-1">Kafka <a class="header-anchor" href="#kafka" aria-label="Permalink to &quot;Kafka&quot;">​</a></h1><br><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><blockquote><p>Kafka 是一个分布式流处理平台，基于发布/订阅模式的消息队列（Message Queue），主要应用于大数据实时处理领域。使用 Kafka 可以帮助进行解耦、异步、削峰等操作</p></blockquote><br><h3 id="基础架构" tabindex="-1">基础架构 <a class="header-anchor" href="#基础架构" aria-label="Permalink to &quot;基础架构&quot;">​</a></h3><p><img src="/assets/基础架构.1d9de240.png" alt="img"></p><br><h3 id="相关概念" tabindex="-1">相关概念 <a class="header-anchor" href="#相关概念" aria-label="Permalink to &quot;相关概念&quot;">​</a></h3><ul><li><p>Producer，消息生产者</p></li><li><p>Consumer，消息消费者，从 Broker 拉取消息</p></li><li><p>Consumer Group</p><p>消费者组，组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费。所有的消费者都属于某个消费者组，消费者组是逻辑上的一个订阅者</p><p><img src="/assets/consumer-groups.c8797fc8.png" alt="img"></p></li><li><p>Broker</p><p>一个 Kafka 服务就是一个 Broker，一个集群由多个 Broker 组成。一个 Broker 可以容纳多个 Topic</p></li><li><p>Topic，发布订阅模式中，生产者和消费者面向的都是一个 Topic</p></li><li><p>Partition</p><p>为了实现扩展性，一个大 Topic 可以分布到多个 Broker 上，一个 Topic 可以分为多个 Partition，每个 Partition 是一个有序的队列</p><p><img src="/assets/streams-and-tables-p1_p4.ceaa828d.png" alt="img"></p></li><li><p>Replica，副本，一个 Topic 的每个分区都有若干个副本，一个 Leader 和零个或若干个 Follower</p></li><li><p>Leader</p><p>每个分区多个副本的“主”，一个分区只有一个 Leader，一个分区的数据只能由 Leader 来处理。生产者发送数据的对象，以及消费者消费数据的对象都是 Leader</p></li><li><p>Follower</p><p>每个分区多个副本中的“从”，实时从 Leader 中同步数据，保持数据的同步。Leader 发生故障时，会从 Follower 中选出新的 Leader</p></li></ul><br><blockquote><p>kafka 中 Zookeeper 和 RocketMQ 的 Nameserver 对比</p><p>有些相似，都是用来管理集群中的节点信息。但是它们的职责不完全相同。</p><ul><li>Zookeeper 是一个高性能的分布式协调服务，它的主要作用是维护和管理分布式应用程序中的配置、命名、分布式同步和群组服务等，同时它还具有分布式锁和分布式队列等功能。</li><li>Nameserver 则是一个轻量级的命名服务，用于管理所有生产者和消费者的信息，包括主题、队列、消费组等。Nameserver 通过将生产者和消费者注册到其管理的主题中，使得生产者和消费者能够互相发现和通信。Nameserver 还可以处理主题的路由和自动化分区等操作，以便消息能够有效地分布到各个消费者实例。</li></ul><br><table><thead><tr><th></th><th>Zookeeper</th><th>Nameserver</th></tr></thead><tbody><tr><td>功能</td><td>分布式协调和管理、数据存储、分布式锁和分布式队列</td><td>消费者和生产者管理、主题路由和自动化分区</td></tr><tr><td>数据存储</td><td>分层的命名空间、可靠的数据存储</td><td>内存数据库</td></tr><tr><td>一致性</td><td>原子/版本/事务保持一致性</td><td>集群中的主节点选举</td></tr><tr><td>可用性和容错</td><td>高度可用性和容错性</td><td>容错性较弱</td></tr><tr><td>应用场景</td><td>分布式应用程序</td><td>分布式消息系统</td></tr></tbody></table></blockquote><br><h3 id="消费模式" tabindex="-1">消费模式 <a class="header-anchor" href="#消费模式" aria-label="Permalink to &quot;消费模式&quot;">​</a></h3><ul><li>点对点，消费者主动拉取数据，消息收到后被清除。生产者生产消息发送到消息队列，消费者从队列中主动拉取并消费消息。消息消费后，队列中不再存储，所以消费者不可能消费到已经被消费的消息。一个消息队列支持多个消费者，但是一个消息，只有一个消费者可以消费。</li><li>发布/订阅，一对多，消息被消费后不会被清除。消息生产者将消息发布到 Topic 中，同时可以有多个消费者订阅该 Topic。和点对点方式不同，发布到 Topic 的消息被消费后不会被清除，会被所有订阅者消费</li></ul><br><h2 id="安装启动" tabindex="-1">安装启动 <a class="header-anchor" href="#安装启动" aria-label="Permalink to &quot;安装启动&quot;">​</a></h2><p><strong>Docker</strong></p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wurstmeister/zookeeper</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wurstmeister/kafka</span></span>
<span class="line"><span style="color:#6A737D;"># 先启动 zk</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zookeeper</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2181</span><span style="color:#9ECBFF;">:2181</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wurstmeister/zookeeper</span></span>
<span class="line"><span style="color:#6A737D;"># 启动 kafka</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kafka</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9092</span><span style="color:#9ECBFF;">:9092</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KAFKA_BROKER_ID=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KAFKA_ZOOKEEPER_CONNECT=IP地址:2181</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://IP地址:9092</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wurstmeister/kafka</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_BROKER_ID=0 在 kafka 集群中，每个 kafka 都有一个 BROKER_ID 来区分</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_ZOOKEEPER_CONNECT=IP地址:2181 配置 zk</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://IP地址:9092 kafka 服务注册到 zk</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 配置 kafka 监听端口</span></span>
<span class="line"><span style="color:#6A737D;"># -v /etc/localtime:/etc/localtime 容器时间同步虚拟机的时间</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wurstmeister/zookeeper</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wurstmeister/kafka</span></span>
<span class="line"><span style="color:#6A737D;"># 先启动 zk</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zookeeper</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2181</span><span style="color:#032F62;">:2181</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wurstmeister/zookeeper</span></span>
<span class="line"><span style="color:#6A737D;"># 启动 kafka</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kafka</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9092</span><span style="color:#032F62;">:9092</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KAFKA_BROKER_ID=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KAFKA_ZOOKEEPER_CONNECT=IP地址:2181</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://IP地址:9092</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wurstmeister/kafka</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_BROKER_ID=0 在 kafka 集群中，每个 kafka 都有一个 BROKER_ID 来区分</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_ZOOKEEPER_CONNECT=IP地址:2181 配置 zk</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://IP地址:9092 kafka 服务注册到 zk</span></span>
<span class="line"><span style="color:#6A737D;"># -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 配置 kafka 监听端口</span></span>
<span class="line"><span style="color:#6A737D;"># -v /etc/localtime:/etc/localtime 容器时间同步虚拟机的时间</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><br><h2 id="基本操作" tabindex="-1">基本操作 <a class="header-anchor" href="#基本操作" aria-label="Permalink to &quot;基本操作&quot;">​</a></h2><blockquote><p><a href="https://kafka.apachecn.org/documentation.html#operations" target="_blank" rel="noreferrer">operations</a></p></blockquote><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 创建 topic</span></span>
<span class="line"><span style="color:#6A737D;"># --topic 定义 topic 名</span></span>
<span class="line"><span style="color:#6A737D;"># --replication-factor 定义副本数</span></span>
<span class="line"><span style="color:#6A737D;"># --partitions 定义分区数</span></span>
<span class="line"><span style="color:#B392F0;">kafka-topics.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看所有 topic</span></span>
<span class="line"><span style="color:#B392F0;">kafka-topics.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--list</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"><span style="color:#6A737D;"># 除了自定义的 Topic，还有一个名为 __consumer_offsets 的 Topic，用于保存消费者的消费 Offset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除 topic</span></span>
<span class="line"><span style="color:#B392F0;">kafka-topics.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--delete</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"><span style="color:#6A737D;"># 需要 config/server.properties 中设置 delete.topic.enable=true 否则只是标记删除</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 消息生产</span></span>
<span class="line"><span style="color:#B392F0;">kafka-console-producer.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> the 1st message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 消费消息</span></span>
<span class="line"><span style="color:#B392F0;">kafka-console-consumer.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-beginning</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看某个 topic 的详情</span></span>
<span class="line"><span style="color:#B392F0;">kafka-topics.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--describe</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改 topic 分区数</span></span>
<span class="line"><span style="color:#B392F0;">kafka-topics.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--alter</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--topic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topic_name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--partitions</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9092</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 创建 topic</span></span>
<span class="line"><span style="color:#6A737D;"># --topic 定义 topic 名</span></span>
<span class="line"><span style="color:#6A737D;"># --replication-factor 定义副本数</span></span>
<span class="line"><span style="color:#6A737D;"># --partitions 定义分区数</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-topics.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看所有 topic</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-topics.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--list</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"><span style="color:#6A737D;"># 除了自定义的 Topic，还有一个名为 __consumer_offsets 的 Topic，用于保存消费者的消费 Offset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除 topic</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-topics.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--delete</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"><span style="color:#6A737D;"># 需要 config/server.properties 中设置 delete.topic.enable=true 否则只是标记删除</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 消息生产</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-console-producer.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> the 1st message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 消费消息</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-console-consumer.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-beginning</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看某个 topic 的详情</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-topics.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--describe</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改 topic 分区数</span></span>
<span class="line"><span style="color:#6F42C1;">kafka-topics.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--alter</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--topic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topic_name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--partitions</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9092</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><br><h2 id="工作流程" tabindex="-1">工作流程 <a class="header-anchor" href="#工作流程" aria-label="Permalink to &quot;工作流程&quot;">​</a></h2><blockquote><p>Kafka 中消息是以 Topic 进行分类的，消息的生产和消费都是面向 Topic 的。</p><p>Topic 是逻辑上的概念，而 Partition 是物理上的概念。每个 Partition 对应于一个 log 文件，该 log 文件中存储的就是生产者生产的数据。（Topic = N partition，partition = log）</p><p>Producer 生产的数据会被不断追加到该 log 文件末端，且每条数据都有自己的 Offset。消费者组中的每个消费者会实时记录自己消费到了哪个 Offset，以便出错恢复时从上次的位置继续消费。</p></blockquote><blockquote><p>生产者 -&gt; Toopic（实际上是 Partition Log File） -&gt; 消费者</p></blockquote><br><h2 id="消息生产消费" tabindex="-1">消息生产消费 <a class="header-anchor" href="#消息生产消费" aria-label="Permalink to &quot;消息生产消费&quot;">​</a></h2><br><h3 id="生产者" tabindex="-1">生产者 <a class="header-anchor" href="#生产者" aria-label="Permalink to &quot;生产者&quot;">​</a></h3><h4 id="生产者分区" tabindex="-1">生产者分区 <a class="header-anchor" href="#生产者分区" aria-label="Permalink to &quot;生产者分区&quot;">​</a></h4><blockquote><p><strong>原因</strong></p><ul><li><p>方便在集群中扩展，每个分区可调整以适应它所在的机器，Topic 可以分成多个分区，集群可以适应更多的数据</p></li><li><p>提高并发，以分区为单位读写，多个分区可以处理更多的读操作</p></li></ul></blockquote><blockquote><p><strong>分区策略</strong></p><ol><li>指明分区的情况下，直接发送到对应的分区</li><li>没有指明分区，但有 key 时，将 key 的 hash 值与分区数进行取余操作，得到存储的分区号</li><li>既没有指明分区，又没有 key 时，第一次调用：随机生成一个整数（后面每次调用在这个整数上自增），将其与 Topic 可用的分区总数取余得到发送到的分区号，即 round-robin 算法</li></ol></blockquote><br><h4 id="生产者-isr" tabindex="-1">生产者 ISR <a class="header-anchor" href="#生产者-isr" aria-label="Permalink to &quot;生产者 ISR&quot;">​</a></h4><blockquote><p>为保证生产者发送的数据，能可靠的发送到指定的 Topic。Topic 的每个分区收到发送的消息后，向生产者发送 ACK，如果生产者收到 ACK，就会进行下一轮的发送，否则重新发送数据。</p></blockquote><blockquote><p><strong>何时发送 ACK</strong></p><p>确保有 Follower 与 Leader 同步完成，Leader 再发送 ACK，才能保证 Leader 故障后，仍有完整的数据保存在 Follower 中，才能选举出新的 Leader</p></blockquote><blockquote><p><strong>Follower 同步 ACK 策略</strong></p><ol><li>半数以上的 Follower 同步完成，可发送 ACK。缺点是选举新的 Leader 时，容忍 n 台节点的故障，需要 2n+1 个副本。如果集群有 2n+1 台机器，选举 Leader 时，至少需要半数以上即 n+1 台机器投票。能容忍的故障最多就是 n 台机器发生故障，容错率 1/2。延迟低</li><li>全部的 Follower 同步完成，才发送 ACK。优点是选举新 Leader 时， 容忍 n 台节点的故障，需要 n+1 个副本（如果集群有 n+1 台机器，选举 Leader 时只要有一个副本就可以），容错率：1。是延迟高</li></ol><p><strong>Kafka 选择了第二种方案</strong>，原因如下</p><ol><li>为了容忍 n 台节点的故障，第一种方案需要 2n+1 个副本，第二种方案只需要 n+1 个副本，Kafka 的每个分区都有大量的数据， 第一种方案会造成大量数据的冗余。</li><li>虽然第二种方案的网络延迟会比较高，但网络延迟对 Kafka 的影响较小。</li></ol></blockquote><blockquote><p>采用第二种方案之后，设想以下情景：Leader 收到数据，所有 Follower 都开始同步数据，但有一个 Follower 发生故障不能与 Leader 进行同步，Leader 就要一直等待，直到 Follower 完成同步，才能发送 ACK。这个问题怎么解决呢？</p><p>Leader 维护了一个动态的 ISR（In-Sync Replica set 同步状态的备份的集合），表示和 Leader 保持同步的 Follower 集合。当 ISR 中的 Follower 完成数据的同步之后，就会给 Leader 发送 ACK。如果 Follower 长时间未向 Leader 同步数据，该 Follower 将被踢出 ISR，时间由 <code>replica.lag.time.max.ms</code> 参数设定。Leader 发生故障之后，就会从 ISR 中选举新的Leader</p></blockquote><br><h4 id="生产者-ack-策略" tabindex="-1">生产者 ACK 策略 <a class="header-anchor" href="#生产者-ack-策略" aria-label="Permalink to &quot;生产者 ACK 策略&quot;">​</a></h4><blockquote><p>对于不太重要的数据，对数据的可靠性要求不高，能够容忍数据少量丢失，不必等 ISR 中的 Follower 全部接收成功。</p><p>Kafka 为用户提供了三种级别 ACK</p><ul><li><p>0，生产者不等 Broker 的 ACK，提供最低的延迟，Broker 接收消息到还没有写入磁盘就已经返回 ACK，Broker 故障时有可能丢失数据</p></li><li><p>1，生产者等 Broker 的 ACK，分区的 Leader 落盘成功后返回 ACK，如果在 Follower 同步成功之前 Leader 故障，将会丢失数据</p></li><li><p>-1（all），生产者等 Broker 的 ACK，分区的 Leader 和 ISR 的 Follower 全部落盘成功后才返回 ACK。如果在 Follower 同步完成后，Broker 发送 ACK 之前，Leader 发生故障，会造成数据重复</p></li></ul></blockquote><br><h3 id="消费者" tabindex="-1">消费者 <a class="header-anchor" href="#消费者" aria-label="Permalink to &quot;消费者&quot;">​</a></h3><h4 id="消费方式" tabindex="-1">消费方式 <a class="header-anchor" href="#消费方式" aria-label="Permalink to &quot;消费方式&quot;">​</a></h4><ul><li><p>拉模式，拉模式从 Broker 中读取数据。如果 Broker 没有数据，消费者可能会陷入循环中，一直返回空数据。针对这一点，Kafka 在拉模式消费中定义了一个超时参数，消费者去请求消息，如果有的话马上返回消息，如果没有的话消费者等着直到超时，然后再次发起拉消息请求。拉模式可以根据 Consumer 的消费能力以适当的速率消费消息</p></li><li><p>推模式，消息发送速率是由 Broker 决定，消费者很难适应。目标是尽可能以最快速度传递消息，但是消费者可能来不及处理消息</p></li></ul><h4 id="消费者分区" tabindex="-1">消费者分区 <a class="header-anchor" href="#消费者分区" aria-label="Permalink to &quot;消费者分区&quot;">​</a></h4><br><p><strong>分区分配再平衡机制</strong></p><blockquote><p>再平衡指的是在消费者订阅的 Topic 发生变化时发生的一种分区重分配机制。</p><p>一般有三种情况会触发再平衡</p><ul><li>消费者组中的新增或删除某个消费者，导致其所消费的分区需要分配到组内其他的消费者上</li><li>消费者订阅的 Topic 发生变化，比如订阅的 Topic 采用的是正则表达式的形式，如 <code>topic-*</code>，此时如果有一个新建了一个 <code>topic-user</code>，这个 Topic 的所有分区也会自动分配给当前消费者</li><li>消费者所订阅的 Topic 发生了新增分区的行为，新增的分区就会分配给当前的消费者</li></ul></blockquote><blockquote><p><a href="https://zhuanlan.zhihu.com/p/86718818" target="_blank" rel="noreferrer">Kafka 再平衡机制详解</a></p></blockquote><br><p><strong>分区分配策略</strong></p><blockquote><p>一个消费者组中有多个消费者，一个 Topic 有多个分区，消费时需要确定哪个分区由哪个消费者来消费。</p><p>两种分配策略</p><ul><li>round-robin 轮询</li><li>range</li></ul></blockquote><br><h4 id="消费-offset" tabindex="-1">消费 Offset <a class="header-anchor" href="#消费-offset" aria-label="Permalink to &quot;消费 Offset&quot;">​</a></h4><blockquote><p>消费者在出现故障恢复后，需要从故障前的位置的继续消费，所以消费者需要实时记录自己消费到了哪个 Offset，以便故障恢复后继续消费。</p><p>消费者默认将 Offset 保存在 Kafka 名为 <code>__consumer_offsets</code> 的内置 Topic 中。</p></blockquote><br><h2 id="消息操作" tabindex="-1">消息操作 <a class="header-anchor" href="#消息操作" aria-label="Permalink to &quot;消息操作&quot;">​</a></h2><h3 id="消息存储" tabindex="-1">消息存储 <a class="header-anchor" href="#消息存储" aria-label="Permalink to &quot;消息存储&quot;">​</a></h3><blockquote><p>一个 Topic 可分为多个分区，一个分可分为多个 Segment，一个 Segment 对应两个文件：<code>.index</code>文件和 <code>.log</code>文件</p></blockquote><blockquote><p>由于生产者生产的消息会不断追加到 log 文件末尾，为防止 log 文件过大导致数据定位效率低下，Kafka 采取了<strong>分片</strong>和<strong>索引</strong>机制，将每个 Partition 分为多个 Segment。</p><p>每个 Segment 对应两个文件：<code>.index</code> 文件和 <code>.log</code> 文件。这些文件位于一个文件夹下，文件夹的命名规则为：<code>Topic 名称 + 分区序号</code>。例如，first 这个 Topic 有 3 个分区，则其对应的文件夹为 first-0，first-1，first-2</p><p><code>.index</code> 和 <code>.log</code> 文件以当前 Segment 的第一条消息的 Offset 命名，当文件大小达到配置的大小（默认 1G）时会根据新的 Offset 生成新的文件</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">00000000000000000000.index</span></span>
<span class="line"><span style="color:#e1e4e8;">00000000000000000000.log</span></span>
<span class="line"><span style="color:#e1e4e8;">00000000000000170410.index</span></span>
<span class="line"><span style="color:#e1e4e8;">00000000000000170410.log</span></span>
<span class="line"><span style="color:#e1e4e8;">00000000000000239430.index</span></span>
<span class="line"><span style="color:#e1e4e8;">00000000000000239430.log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">00000000000000000000.index</span></span>
<span class="line"><span style="color:#24292e;">00000000000000000000.log</span></span>
<span class="line"><span style="color:#24292e;">00000000000000170410.index</span></span>
<span class="line"><span style="color:#24292e;">00000000000000170410.log</span></span>
<span class="line"><span style="color:#24292e;">00000000000000239430.index</span></span>
<span class="line"><span style="color:#24292e;">00000000000000239430.log</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></blockquote><p><img src="/assets/image-20210802170907770.d6e65451.png" alt="image-20210802170907770"></p><br><h3 id="消息日志删除" tabindex="-1">消息日志删除 <a class="header-anchor" href="#消息日志删除" aria-label="Permalink to &quot;消息日志删除&quot;">​</a></h3><p>由于不删除消息，硬盘有被占满的时刻，Kakfa 提供了几种策略解决：一是基于时间；二是基于起始偏移量；三是基于分区文件的大小</p><ul><li>日志删除任务会检查当前日志文件中是否有保留时间超过设定的阈值来寻找可删除的日志分段文件集合</li><li>一般情况下，日志文件的起始偏移量 logStartOffset 等于第一个日志分段的 baseOffset。基于日志起始偏移量的保留策略的判断依据是某日志分段的起始偏移量 baseOffset 是否小于等于 logStartOffset，若是，则可以删除此日志分段</li><li>日志删除任务会检查当前日志的大小是否超过设定的阈值来寻找可删除的日志分段的文件集合</li></ul><br><h2 id="数据一致性问题" tabindex="-1">数据一致性问题 <a class="header-anchor" href="#数据一致性问题" aria-label="Permalink to &quot;数据一致性问题&quot;">​</a></h2><blockquote><p>首先了解两个概念</p><ul><li><p>LEO（Log End Offset），每个副本的最后一个 Offset</p></li><li><p>HW（High Watermark）高水位，指的是消费者能见到的最大的 Offset，ISR 队列中最小的 LEO</p></li></ul></blockquote><p><img src="/assets/image-20210803102155773.64b77247.png" alt="image-20210803102155773"></p><p><strong>Follower 故障和 Leader 故障</strong></p><ul><li>Follower 故障：Follower 发生故障后会被<strong>临时</strong>踢出 ISR，待该 Follower 恢复后，Follower 会读取本地磁盘记录的上次的 HW，并将 log 文件高于 HW 的部分截取掉，从 HW 开始向 Leader 进行同步。等该Follower 的 HW 追上 Leader 之后，就可以重新加入 ISR</li><li>Leader 故障：会从 ISR 中选出一个新的 Leader，为保证多个副本之间的数据一致性， 其余的 Follower 会先将各自的 log 文件高于 HW 的部分截掉，然后从新的 Leader 同步数据</li></ul><blockquote><p><strong>注意</strong>：这只能保证副本之间的数据一致性，并不能保证数据不丢失或者不重复</p></blockquote><br><h2 id="exactlyonce" tabindex="-1">ExactlyOnce <a class="header-anchor" href="#exactlyonce" aria-label="Permalink to &quot;ExactlyOnce&quot;">​</a></h2><ul><li>将 ACK 级别设置为 -1（all），可以保证生产者到 Broker 之间不会丢失数据，保证生产者消息至少发送一次，即 <strong>At Least Once</strong> 语义</li><li>将 ACK 级别设置为 0，可以保证生产者每条消息只会被发送一次，即 <strong>At Most Once</strong> 语义</li><li><strong>消息持久化幂等性</strong>。就是指生产者不论向 Broker 发送多少次重复数据，Broker 只会持久化一条</li></ul><p>At Least Once 可以保证数据不丢失，但是不能保证数据不重复；At Most Once 可以保证数据不重复，但是不能保证数据不丢失。 但是，对于一些非常重要的消息，比如说<strong>交易消息</strong>，消费者要求数据既不重复也不丢失，即 <strong>Exactly Once</strong> 语义。</p><blockquote><p>幂等性结合 At Least Once 语义，就构成了 Kafka 的 Exactly Once 语义。</p><p>At Least Once + 幂等性 = Exactly Once</p></blockquote><p>将生产者的参数 <code>enable.idempotence</code> 设置为 <code>true</code> 即可启用幂等性支持。 Kafka 幂等性实现其实就是将原来下游需要做的去重放在了数据上游。开启幂等性的生产者在初始化时会被分配一个 PID，发往同一个 Partition 的消息会附带 Sequence Number。Broker 会将 <code>&lt;PID, Partition, SeqNumber&gt;</code> 缓存起来当作主键，当具有相同主键的消息提交时， Broker 只会持久化一条。</p><p>但服务重启 PID 就会变化，不同的分区具有不同主键，所以幂等性无法保证跨分区跨会话的 Exactly Once。</p><br><h2 id="高效读写" tabindex="-1">高效读写 <a class="header-anchor" href="#高效读写" aria-label="Permalink to &quot;高效读写&quot;">​</a></h2><br><h3 id="顺序写磁盘" tabindex="-1">顺序写磁盘 <a class="header-anchor" href="#顺序写磁盘" aria-label="Permalink to &quot;顺序写磁盘&quot;">​</a></h3><blockquote><p>Kafka 的生产者生产数据，会写入到 log 文件中，写的过程是一直追加到文件末端，为顺序写。 顺序写<strong>省去了大量磁头寻址的时间</strong>。</p><p>实际上不管是内存还是磁盘，快或慢关键在于寻址的方式。磁盘分为顺序读写与随机读写，内存也一样分为顺序读写与随机读写。顺序读写性能高于随机读写。Kafka 使用磁盘顺序读写，将消息不断追加到本地磁盘文件末尾，来提升的性能。</p><p>每一个分区都是一个文件，收到消息后 Kafka 会把数据插入到文件末尾。这种方法有一个缺陷：没有办法删除数据。所以 Kafka 是不会删除数据的，它会把所有的数据都保留下来，每个消费者对每个 Topic 都有一个 offset 用来表示 读取到了第几条数据。</p></blockquote><br><h3 id="page-cache" tabindex="-1">Page Cache <a class="header-anchor" href="#page-cache" aria-label="Permalink to &quot;Page Cache&quot;">​</a></h3><blockquote><p>为了优化读写性能，Kafka 利用了操作系统本身的 Page Cache，用于缓存磁盘上的消息</p><ul><li>避免 Object 消耗，如果是使用 Java 堆，Java 对象的内存消耗比较大，通常是所存储数据的两倍甚至更多</li><li>避免 GC 问题，随着 JVM 中数据不断增多，垃圾回收会变得复杂/缓慢，使用系统缓存就不会存在 GC 问题</li></ul><p>Kafka 将消息写入磁盘时，同时也会将其缓存在 Page Cache 中。当应用程序需要访问这些消息时，Page Cache 会将它们从磁盘加载到内存中，以便更快读取。</p><p>相比于使用 JVM 或 In-memory cache 等，利用操作系统的 Page Cache 更加简单可靠</p><ul><li><p>操作系统层面的缓存利用率会更高，因为存储的都是紧凑的字节结构而不是独立的对象</p></li><li><p>操作系统本身对 Page Cache 做了优化，提供了 write-behind/read-ahead/flush 等多种机制</p></li><li><p>即使服务进程重启，系统缓存依然存在，避免 In-process cache 重建缓存的过程</p></li></ul></blockquote><br><h3 id="零拷贝技术" tabindex="-1">零拷贝技术 <a class="header-anchor" href="#零拷贝技术" aria-label="Permalink to &quot;零拷贝技术&quot;">​</a></h3><blockquote><p>Linux 操作系统零拷贝机制使用了 sendfile 方法，允许操作系统将数据从 Page Cache 直接发送到网络，只需要最后一步的 copy 操作将数据复制到 NIC（NIC network interface controller 网络接口控制器） 缓冲区， 这样避免重新复制数据</p><p><img src="/assets/14.2ec8d68e.png" alt="零复制技术"></p><p>通过零拷贝机制，Page Cache 结合 sendfile 方法，Kafka 消费端的性能也大幅提升。有时候消费端在不断消费数据，但是并没有看到磁盘 IO 比较高，正是操作系统缓存在提供数据。</p></blockquote><br><p>当 Kafka 客户端从服务器读取数据时，如果不使用零拷贝技术，那么大致需要经历这样的一个过程：</p><ol><li>操作系统将数据从磁盘上读入到内核空间的读缓冲区中</li><li>应用程序（也就是 Kafka）从内核空间的读缓冲区将数据拷贝到用户空间的缓冲区中</li><li>应用程序将数据从用户空间的缓冲区再写回到内核空间的 socket 缓冲区中</li><li>操作系统将 socket 缓冲区中的数据拷贝到 NIC 缓冲区中，然后通过网络发送给客户端</li></ol><blockquote><p>数据在内核空间和用户空间之间穿梭了两次，那么能否避免这个多余的过程呢？</p></blockquote><p>Kafka 使用了零拷贝技术，直接将数据从内核空间的读缓冲区直接拷贝到内核空间的 socket 缓冲区，再写入到 NIC 缓冲区，避免了在内核空间和用户空间之间穿梭。</p><blockquote><p>这里的零拷贝并非指一次拷贝都没有，而是避免了在内核空间和用户空间之间的拷贝</p></blockquote><br><h3 id="分区分段-索引" tabindex="-1">分区分段+索引 <a class="header-anchor" href="#分区分段-索引" aria-label="Permalink to &quot;分区分段+索引&quot;">​</a></h3><blockquote><p>Kafka 的消息是按 Topic 分类存储的，Topic 中的数据又是按照一个个分区存储到不同 Broker 节点。每个分区对应了操作系统上的一个文件夹，分区实际上又是按照 Segment 分段存储的。这也非常符合分布式系统分区分桶的设计思想。</p><p>通过这种分区分段的设计，Kafka 的消息实际上是分布式存储在一个个的 Segment 中的，每次文件操作也是直接操作的 Segment。为了进一步的查询优化，Kafka 又默认为分段后的数据文件建立了索引文件，就是文件系统上的 <code>.index</code> 文件。这种分区分段+索引的设计，不仅提升了数据读取的效率，同时也提高了数据操作的并行度。</p></blockquote><br><h3 id="批量读写" tabindex="-1">批量读写 <a class="header-anchor" href="#批量读写" aria-label="Permalink to &quot;批量读写&quot;">​</a></h3><blockquote><p>Kafka 数据读写是批量的而不是单个的。在向 Kafka 写入数据时，启用批次写入可以避免在网络上频繁传输单个消息带来的延迟和带宽开销。</p></blockquote><br><h3 id="批量压缩" tabindex="-1">批量压缩 <a class="header-anchor" href="#批量压缩" aria-label="Permalink to &quot;批量压缩&quot;">​</a></h3><blockquote><p>在很多情况下，系统的瓶颈不是 CPU 或磁盘，而是网络 IO。可以考虑进行数据压缩，虽然会消耗少量的 CPU 资源，不过对于 Kafka 而言，网络 IO 更应该需要考虑</p><ol><li>如果每个消息都压缩，但是压缩率相对很低，Kafka 使用了批量压缩，多个消息一起压缩</li><li>Kafka 允许使用递归的消息集合，批量的消息可以通过压缩的形式传输并且在日志中也可以保持压缩格式，直到被消费者解压</li><li>Kafka 支持多种压缩协议，包括 Gzip 和 Snappy 压缩协议</li></ol></blockquote><br><h2 id="zookeeper-的作用" tabindex="-1">Zookeeper 的作用 <a class="header-anchor" href="#zookeeper-的作用" aria-label="Permalink to &quot;Zookeeper 的作用&quot;">​</a></h2><blockquote><p>Kafka 集群中有一个 Broker 会被选举为 Controller，负责管理集群 Broker 的上下线，所有 Topic 的分区副本分配和 Leader 选举等工作</p><p>Controller 的管理工作都是依赖于 Zookeeper 的</p><p><img src="/assets/15.7ee6be58.png" alt="Leader选举流程"></p></blockquote><br><h2 id="事务" tabindex="-1">事务 <a class="header-anchor" href="#事务" aria-label="Permalink to &quot;事务&quot;">​</a></h2><blockquote><p>事务可以保证 Kafka 在 Exactly Once 语义基础上，生产和消费跨分区和会话，要么全部成功，要么全部失败</p></blockquote><p><strong>生产者事务</strong></p><blockquote><p>为了实现跨分区跨会话的事务，需要引入一个全局唯一的 <code>Transaction ID</code>，并将生产者的 PID 和 Transaction ID 绑定。当生产者重启后就可以通过正在进行的 Transaction ID 获得原来的 PID。</p><p>为了管理事务， Kafka 引入了一个新的组件 Transaction Coordinator。生产者就是通过和 Transaction Coordinator 交互获得 Transaction ID 对应的任务状态。 Transaction Coordinator 还负责将事务所有写入 Kafka 的一个内部 Topic，这样即使整个服务重启，由于事务状态得到保存，进行中的事务状态可以得到恢复，从而继续进行。</p></blockquote><p><strong>消费者事务</strong></p><blockquote><p>对于消费者而言，事务的保证就会相对较弱，尤其是无法保证 commit 的信息被精确消费。这是由于消费者可以通过 Offset 访问任意信息，而且不同的 Segment File 生命周期不同，同一事务的消息可能会出现重启后被删除的情况</p></blockquote><br><h2 id="api-操作" tabindex="-1">API 操作 <a class="header-anchor" href="#api-操作" aria-label="Permalink to &quot;API 操作&quot;">​</a></h2><h3 id="生产者-1" tabindex="-1">生产者 <a class="header-anchor" href="#生产者-1" aria-label="Permalink to &quot;生产者&quot;">​</a></h3><h4 id="消息生产模型" tabindex="-1">消息生产模型 <a class="header-anchor" href="#消息生产模型" aria-label="Permalink to &quot;消息生产模型&quot;">​</a></h4><p>Kafka 的生产者发送消息采用的是异步发送的方式。在消息发送的过程中，涉及到了两个线程：main 线程和 Sender 线程，以及一个线程共享变量：RecordAccumulator</p><ul><li>main 线程将消息发送给 RecordAccumulator</li><li>Sender 线程不断从 RecordAccumulator 中拉取消息发送到 Broker</li></ul><p><img src="/assets/19.cdbe2072.png" alt="生产者api调用流程"></p><p><strong>相关参数</strong></p><ul><li><code>batch.size</code> 数据积累到 <code>batch.size</code> 之后， Sender 才会发送数据</li><li><code>linger.ms</code> 如果数据迟迟未达到 <code>batch.size</code>， Sender 等待 <code>linger.time</code> 后就会发送数据</li></ul><br><h4 id="异步生产者" tabindex="-1">异步生产者 <a class="header-anchor" href="#异步生产者" aria-label="Permalink to &quot;异步生产者&quot;">​</a></h4><h5 id="普通生产者" tabindex="-1">普通生产者 <a class="header-anchor" href="#普通生产者" aria-label="Permalink to &quot;普通生产者&quot;">​</a></h5><div class="language-xml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;org.apache.kafka&lt;/</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;kafka-clients&lt;/</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">&gt;latest&lt;/</span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;org.apache.kafka&lt;/</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;kafka-clients&lt;/</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">version</span><span style="color:#24292E;">&gt;latest&lt;/</span><span style="color:#22863A;">version</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MyProducer</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Properties props </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Properties</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><span style="color:#9ECBFF;">&quot;localhost:9092&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// ack 级别 all</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.ACKS_CONFIG, </span><span style="color:#9ECBFF;">&quot;all&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 重试次数</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.RETRIES_CONFIG, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 等待时间</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.LINGER_MS_CONFIG, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 将需要发送的消息序列化</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        Producer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; producer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaProducer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            producer.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ProducerRecord&lt;&gt;(</span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;test-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#9ECBFF;">&quot;test-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i));</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        producer.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyProducer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        Properties props </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Properties</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><span style="color:#032F62;">&quot;localhost:9092&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// ack 级别 all</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.ACKS_CONFIG, </span><span style="color:#032F62;">&quot;all&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 重试次数</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.RETRIES_CONFIG, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 等待时间</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.LINGER_MS_CONFIG, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 将需要发送的消息序列化</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        Producer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaProducer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ProducerRecord&lt;&gt;(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;test-&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#032F62;">&quot;test-&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i));</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><br><h5 id="带回调函数生产者" tabindex="-1">带回调函数生产者 <a class="header-anchor" href="#带回调函数生产者" aria-label="Permalink to &quot;带回调函数生产者&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.kafka.clients.producer.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CallBackProducer</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 消费者配置列表 https://kafka.apache.org/documentation.html#consumerconfigs</span></span>
<span class="line"><span style="color:#E1E4E8;">        Properties props </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Properties</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><span style="color:#9ECBFF;">&quot;localhost:9092&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.GROUP_ID_CONFIG, </span><span style="color:#9ECBFF;">&quot;group-test&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 是否开启自动提交 offset 功能</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 自动提交 offset 的时间间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, </span><span style="color:#9ECBFF;">&quot;1000&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        Producer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; producer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaProducer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            producer.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ProducerRecord&lt;&gt;(</span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;test-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#9ECBFF;">&quot;callback-test-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i), </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Callback</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 回调函数，会在 Producer 收到 ack 时调用</span></span>
<span class="line"><span style="color:#E1E4E8;">                @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onCompletion</span><span style="color:#E1E4E8;">(RecordMetadata </span><span style="color:#FFAB70;">metadata</span><span style="color:#E1E4E8;">, Exception </span><span style="color:#FFAB70;">exception</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> exception) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(metadata.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">                    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        exception.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            });</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        producer.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.kafka.clients.producer.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CallBackProducer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 消费者配置列表 https://kafka.apache.org/documentation.html#consumerconfigs</span></span>
<span class="line"><span style="color:#24292E;">        Properties props </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Properties</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><span style="color:#032F62;">&quot;localhost:9092&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.GROUP_ID_CONFIG, </span><span style="color:#032F62;">&quot;group-test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 是否开启自动提交 offset 功能</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 自动提交 offset 的时间间隔</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, </span><span style="color:#032F62;">&quot;1000&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        Producer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaProducer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ProducerRecord&lt;&gt;(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;test-&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#032F62;">&quot;callback-test-&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i), </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Callback</span><span style="color:#24292E;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 回调函数，会在 Producer 收到 ack 时调用</span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onCompletion</span><span style="color:#24292E;">(RecordMetadata </span><span style="color:#E36209;">metadata</span><span style="color:#24292E;">, Exception </span><span style="color:#E36209;">exception</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> exception) {</span></span>
<span class="line"><span style="color:#24292E;">                        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(metadata.</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        exception.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            });</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><br><h5 id="自定义分区生产者" tabindex="-1">自定义分区生产者 <a class="header-anchor" href="#自定义分区生产者" aria-label="Permalink to &quot;自定义分区生产者&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 具体内容填写可参考默认分区器 DefaultPartitioner</span></span>
<span class="line"><span style="color:#6A737D;">// 生产者配置中注册 props.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MyPartitioner</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Partitioner</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">partition</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">topic</span><span style="color:#E1E4E8;">, Object </span><span style="color:#FFAB70;">key</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">keyBytes</span><span style="color:#E1E4E8;">, Object </span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">valueBytes</span><span style="color:#E1E4E8;">, Cluster </span><span style="color:#FFAB70;">cluster</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 返回结果就是自定义分区数</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">configure</span><span style="color:#E1E4E8;">(Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">configs</span><span style="color:#E1E4E8;">) {}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 具体内容填写可参考默认分区器 DefaultPartitioner</span></span>
<span class="line"><span style="color:#6A737D;">// 生产者配置中注册 props.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyPartitioner</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Partitioner</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">partition</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">topic</span><span style="color:#24292E;">, Object </span><span style="color:#E36209;">key</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">keyBytes</span><span style="color:#24292E;">, Object </span><span style="color:#E36209;">value</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">valueBytes</span><span style="color:#24292E;">, Cluster </span><span style="color:#E36209;">cluster</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 返回结果就是自定义分区数</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">configure</span><span style="color:#24292E;">(Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">configs</span><span style="color:#24292E;">) {}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><br><h4 id="同步生产者" tabindex="-1">同步生产者 <a class="header-anchor" href="#同步生产者" aria-label="Permalink to &quot;同步生产者&quot;">​</a></h4><blockquote><p>同步发送的意思就是，一条消息发送之后，会阻塞当前线程， 直至返回 ack。由于 send 方法返回的是一个 Future 对象，根据 Futrue 对象的特点，也可以实现同步发送的效果，只需再调用 Future 对象的 get 方法即可</p></blockquote><br><h4 id="生产拦截器" tabindex="-1">生产拦截器 <a class="header-anchor" href="#生产拦截器" aria-label="Permalink to &quot;生产拦截器&quot;">​</a></h4><blockquote><p>生产者拦截器主要用于实现客户端的定制化控制逻辑</p></blockquote><p>生产拦截器使用户能在消息发送前，以及生产者回调逻辑执行前，有机会对消息做一些定制化需求。比如，修改消息内容、校验消息等。生产者允许用户指定多个拦截器，拦截器可以按序作用于同一条消息从而形成一个拦截链（Interceptor Chain）。</p><p>Intercetpor 的实现接口是 <code>ProducerInterceptor</code>，其定义的方法包括</p><ul><li>configure(configs) 获取配置信息和初始化数据</li><li>onSend(ProducerRecord) 该方法由 KafkaProducer#send 进行调用，运行在用户主线程中。 生产者确保<strong>在消息被序列化以及计算分区前</strong>调用该方法。用户可以在该方法中对消息做任何操作，但最好不要修改消息所属的 Topic 和分区， 否则会影响目标分区的计算</li><li>onAcknowledgement(RecordMetadata, Exception) 方法会在消息从 RecordAccumulator 成功发送到 Broker 后在发送过程中失败时调用。并且通常都是在生产者回调逻辑触发之前。 onAcknowledgement 运行在生产者的 IO 线程中，因此不要在该方法中放入很重的逻辑，否则会拖慢生产者的消息发送效率</li><li>close 方法关闭拦截器，主要用于执行<strong>资源清理</strong>工作</li></ul><p>生产拦截器可能被运行在多个线程中，因此在具体实现时用户需要自行确保线程安全。若指定了多个拦截器，则生产者将按照指定顺序调用。</p><blockquote><p><strong>注意</strong>：生产者仅捕获每个拦截器可能抛出的异常记录到错误日志中，不会向上传递</p></blockquote><br><h3 id="消费者-1" tabindex="-1">消费者 <a class="header-anchor" href="#消费者-1" aria-label="Permalink to &quot;消费者&quot;">​</a></h3><h4 id="普通消费者" tabindex="-1">普通消费者 <a class="header-anchor" href="#普通消费者" aria-label="Permalink to &quot;普通消费者&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 普通消费者</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MyConsumer</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Properties props </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Properties</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;bootstrap.servers&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;127.0.0.1:9092&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;group.id&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;aaa&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 是否开启自动提交 offset 功能</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;enable.auto.commit&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 自动提交 offset 的时间间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;auto.commit.interval.ms&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;1000&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;key.deserializer&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;value.deserializer&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        KafkaConsumer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; consumer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 订阅模式，设置订阅的 topic</span></span>
<span class="line"><span style="color:#E1E4E8;">        consumer.</span><span style="color:#B392F0;">subscribe</span><span style="color:#E1E4E8;">(Arrays.</span><span style="color:#B392F0;">asList</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            ConsumerRecords&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; records </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> consumer.</span><span style="color:#B392F0;">poll</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (ConsumerRecord&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; record </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> records) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(record.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 普通消费者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyConsumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        Properties props </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Properties</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// kafka 地址</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;bootstrap.servers&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;127.0.0.1:9092&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;group.id&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;aaa&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 是否开启自动提交 offset 功能</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;enable.auto.commit&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 自动提交 offset 的时间间隔</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;auto.commit.interval.ms&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;1000&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;key.deserializer&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;value.deserializer&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        KafkaConsumer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; consumer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 订阅模式，设置订阅的 topic</span></span>
<span class="line"><span style="color:#24292E;">        consumer.</span><span style="color:#6F42C1;">subscribe</span><span style="color:#24292E;">(Arrays.</span><span style="color:#6F42C1;">asList</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            ConsumerRecords&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; records </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> consumer.</span><span style="color:#6F42C1;">poll</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (ConsumerRecord&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; record </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> records) {</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(record.</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><br><h4 id="offset-提交" tabindex="-1">Offset 提交 <a class="header-anchor" href="#offset-提交" aria-label="Permalink to &quot;Offset 提交&quot;">​</a></h4><blockquote><p>消费者消费数据时的可靠性是很容易保证的，因为数据在 Kafka 中是持久化保存的，不用担心数据丢失问题</p></blockquote><p>由于消费者在消费过程中可能会出现故障，恢复后需要从故障前的位置的继续消费，所以 Consumer 需要实时记录自己消费到了哪个 Offset，以便恢复后继续消费，所以 Offset 的维护是消费者必须考虑的问题。</p><br><h5 id="自动提交-offset" tabindex="-1">自动提交 Offset <a class="header-anchor" href="#自动提交-offset" aria-label="Permalink to &quot;自动提交 Offset&quot;">​</a></h5><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 自动重置 Offset</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String AUTO_OFFSET_RESET_CONFIG </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;auto.offset.reset&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">Properties props </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Properties</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, </span><span style="color:#9ECBFF;">&quot;earliest&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;group.id&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;abcd&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">KafkaConsumer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; consumer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaConsumer&lt;&gt;(props);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 自动重置 Offset</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String AUTO_OFFSET_RESET_CONFIG </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;auto.offset.reset&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Properties props </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Properties</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, </span><span style="color:#032F62;">&quot;earliest&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;group.id&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;abcd&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">KafkaConsumer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; consumer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaConsumer&lt;&gt;(props);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><br><h5 id="手动提交-offset" tabindex="-1">手动提交 Offset <a class="header-anchor" href="#手动提交-offset" aria-label="Permalink to &quot;手动提交 Offset&quot;">​</a></h5><blockquote><p>自动提交 Offset 十分便利，但是基于时间提交，难以把握 Offset 提交的时机。因此 Kafka 还提供了手动提交 offset 的方法</p></blockquote><p><strong>手动提交 Offset 的方法有两种</strong></p><ol><li>commitSync（同步提交）</li><li>commitAsync（异步提交）</li></ol><p>两者的<strong>相同点</strong>是，都会将本次 poll 的一批数据最高的偏移量提交</p><p><strong>不同点</strong>是，commitSync 阻塞当前线程，一直到提交成功，并且会自动失败重试（由不可控因素导致，也会出现提交失败）；而 commitAsync 则没有失败重试机制，故有可能提交失败</p><p><strong>同步提交 Offset</strong></p><blockquote><p>同步提交 Offset 有失败重试机制，更加可靠</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">//关闭自动提交 offset</span></span>
<span class="line"><span style="color:#E1E4E8;">props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;enable.auto.commit&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;false&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">KafkaConsumer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; consumer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#E1E4E8;">consumer.</span><span style="color:#B392F0;">subscribe</span><span style="color:#E1E4E8;">(Arrays.</span><span style="color:#B392F0;">asList</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;first&quot;</span><span style="color:#E1E4E8;">)); </span><span style="color:#6A737D;">//消费者订阅主题</span></span>
<span class="line"><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#E1E4E8;">  ConsumerRecords&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; records </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    consumer.</span><span style="color:#B392F0;">poll</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (ConsumerRecord&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; record </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> records) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    System.out.</span><span style="color:#B392F0;">printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;offset = %d, key = %s, value= %s%n&quot;</span><span style="color:#E1E4E8;">, record.</span><span style="color:#B392F0;">offset</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">key</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//&lt;---------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 同步提交，当前线程会阻塞直到 offset 提交成功</span></span>
<span class="line"><span style="color:#E1E4E8;">  consumer.</span><span style="color:#B392F0;">commitSync</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">//关闭自动提交 offset</span></span>
<span class="line"><span style="color:#24292E;">props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;enable.auto.commit&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;false&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">KafkaConsumer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; consumer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#24292E;">consumer.</span><span style="color:#6F42C1;">subscribe</span><span style="color:#24292E;">(Arrays.</span><span style="color:#6F42C1;">asList</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;first&quot;</span><span style="color:#24292E;">)); </span><span style="color:#6A737D;">//消费者订阅主题</span></span>
<span class="line"><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#24292E;">  ConsumerRecords&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; records </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    consumer.</span><span style="color:#6F42C1;">poll</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (ConsumerRecord&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; record </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> records) {</span></span>
<span class="line"><span style="color:#24292E;">    System.out.</span><span style="color:#6F42C1;">printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;offset = %d, key = %s, value= %s%n&quot;</span><span style="color:#24292E;">, record.</span><span style="color:#6F42C1;">offset</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">key</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//&lt;---------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 同步提交，当前线程会阻塞直到 offset 提交成功</span></span>
<span class="line"><span style="color:#24292E;">  consumer.</span><span style="color:#6F42C1;">commitSync</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>异步提交 Offset</strong></p><blockquote><p>虽然同步提交 Offset 更可靠，但是会阻塞当前线程，吞吐量会受到很大的影响。更多情况下，会选用异步提交 Offset 的方式</p></blockquote><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 关闭自动提交 offset</span></span>
<span class="line"><span style="color:#E1E4E8;">props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;enable.auto.commit&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;false&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">KafkaConsumer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; consumer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#E1E4E8;">consumer.</span><span style="color:#B392F0;">subscribe</span><span style="color:#E1E4E8;">(Arrays.</span><span style="color:#B392F0;">asList</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;first&quot;</span><span style="color:#E1E4E8;">)); </span><span style="color:#6A737D;">// 消费者订阅主题</span></span>
<span class="line"><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ConsumerRecords&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; records </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> consumer.</span><span style="color:#B392F0;">poll</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (ConsumerRecord&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; record </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> records) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    System.out.</span><span style="color:#B392F0;">printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span style="color:#E1E4E8;">, record.</span><span style="color:#B392F0;">offset</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">key</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//&lt;----------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 异步提交</span></span>
<span class="line"><span style="color:#E1E4E8;">  consumer.</span><span style="color:#B392F0;">commitAsync</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">OffsetCommitCallback</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onComplete</span><span style="color:#E1E4E8;">(Map&lt;</span><span style="color:#F97583;">TopicPartition</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">OffsetAndMetadata</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">offsets</span><span style="color:#E1E4E8;">, Exception </span><span style="color:#FFAB70;">exception</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (exception </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.err.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Commit failed for&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> offsets);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 关闭自动提交 offset</span></span>
<span class="line"><span style="color:#24292E;">props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;enable.auto.commit&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;false&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">KafkaConsumer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; consumer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#24292E;">consumer.</span><span style="color:#6F42C1;">subscribe</span><span style="color:#24292E;">(Arrays.</span><span style="color:#6F42C1;">asList</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;first&quot;</span><span style="color:#24292E;">)); </span><span style="color:#6A737D;">// 消费者订阅主题</span></span>
<span class="line"><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  ConsumerRecords&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; records </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> consumer.</span><span style="color:#6F42C1;">poll</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (ConsumerRecord&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; record </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> records) {</span></span>
<span class="line"><span style="color:#24292E;">    System.out.</span><span style="color:#6F42C1;">printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span style="color:#24292E;">, record.</span><span style="color:#6F42C1;">offset</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">key</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//&lt;----------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 异步提交</span></span>
<span class="line"><span style="color:#24292E;">  consumer.</span><span style="color:#6F42C1;">commitAsync</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">OffsetCommitCallback</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onComplete</span><span style="color:#24292E;">(Map&lt;</span><span style="color:#D73A49;">TopicPartition</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">OffsetAndMetadata</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">offsets</span><span style="color:#24292E;">, Exception </span><span style="color:#E36209;">exception</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (exception </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        System.err.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Commit failed for&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> offsets);</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  });</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><br><h4 id="遗漏消费和重复消费" tabindex="-1">遗漏消费和重复消费 <a class="header-anchor" href="#遗漏消费和重复消费" aria-label="Permalink to &quot;遗漏消费和重复消费&quot;">​</a></h4><p>无论是同步提交还是异步提交 offset，都有可能会造成数据的漏消费或者重复消费</p><ul><li>先提交 offset 后消费，有可能造成数据的漏消费</li><li>先消费后提交 offset，有可能会造成数据的重复消费</li></ul><br><h4 id="offset-存储" tabindex="-1">Offset 存储 <a class="header-anchor" href="#offset-存储" aria-label="Permalink to &quot;Offset 存储&quot;">​</a></h4><p>Kafka 默认将 Offset 存储在 Kafka 的一个内置的 Topic 中。Kafka 还可以选择自定义存储 Offset。Offset 的维护是相当繁琐的， 因为需要考虑到消费者的 Rebalace。</p><p>当有新的消费者加入消费者组、已有的消费者退出消费者组或订阅主题的分区发生变化，就会触发分区的重新分配，重新分配的过程叫做 Rebalance。</p><p>消费者发生 Rebalance 之后，每个消费者消费的分区就会发生变化。因此消费者首先要获取到自己被重新分配到的分区，并且定位到每个分区最近提交的 Offset 位置继续消费。要实现自定义存储 Offset，需要借助 <code>ConsumerRebalanceListener</code>。</p><p>以下为示例代码，其中提交和获取 Offset 的方法，需要根据所选的 Offset 存储系统自行实现(可存入数据库)。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CustomSaveOffset</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">TopicPartition</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Long</span><span style="color:#E1E4E8;">&gt; currentOffset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 创建配置信息</span></span>
<span class="line"><span style="color:#E1E4E8;">		Properties props </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Properties</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">		...</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">//&lt;--------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 关闭自动提交 offset</span></span>
<span class="line"><span style="color:#E1E4E8;">		props.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;enable.auto.commit&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;false&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">		...</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 创建一个消费者</span></span>
<span class="line"><span style="color:#E1E4E8;">		KafkaConsumer&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; consumer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 消费者订阅主题</span></span>
<span class="line"><span style="color:#E1E4E8;">		consumer.</span><span style="color:#B392F0;">subscribe</span><span style="color:#E1E4E8;">(Arrays.</span><span style="color:#B392F0;">asList</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;first&quot;</span><span style="color:#E1E4E8;">), </span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">//&lt;-------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConsumerRebalanceListener</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">// 该方法会在 Rebalance 之前调用</span></span>
<span class="line"><span style="color:#E1E4E8;">			@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onPartitionsRevoked</span><span style="color:#E1E4E8;">(Collection&lt;</span><span style="color:#F97583;">TopicPartition</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">partitions</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">commitOffset</span><span style="color:#E1E4E8;">(currentOffset);</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">// 该方法会在 Rebalance 之后调用</span></span>
<span class="line"><span style="color:#E1E4E8;">			@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onPartitionsAssigned</span><span style="color:#E1E4E8;">(Collection&lt;</span><span style="color:#F97583;">TopicPartition</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">partitions</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">				currentOffset.</span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (TopicPartition partition </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> partitions) {</span></span>
<span class="line"><span style="color:#E1E4E8;">					consumer.</span><span style="color:#B392F0;">seek</span><span style="color:#E1E4E8;">(partition, </span><span style="color:#B392F0;">getOffset</span><span style="color:#E1E4E8;">(partition));</span><span style="color:#6A737D;">// 定位到最近提交的 offset 位置继续消费</span></span>
<span class="line"><span style="color:#E1E4E8;">				}</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">		});</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			ConsumerRecords&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; records </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> consumer.</span><span style="color:#B392F0;">poll</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (ConsumerRecord&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; record </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> records) {</span></span>
<span class="line"><span style="color:#E1E4E8;">				System.out.</span><span style="color:#B392F0;">printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span style="color:#E1E4E8;">, record.</span><span style="color:#B392F0;">offset</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">key</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">				currentOffset.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TopicPartition</span><span style="color:#E1E4E8;">(record.</span><span style="color:#B392F0;">topic</span><span style="color:#E1E4E8;">(), record.</span><span style="color:#B392F0;">partition</span><span style="color:#E1E4E8;">()), record.</span><span style="color:#B392F0;">offset</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#B392F0;">commitOffset</span><span style="color:#E1E4E8;">(currentOffset);</span><span style="color:#6A737D;">// 异步提交</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 获取某分区的最新 offset</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getOffset</span><span style="color:#E1E4E8;">(TopicPartition </span><span style="color:#FFAB70;">partition</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 提交该消费者所有分区的 offset</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">commitOffset</span><span style="color:#E1E4E8;">(Map&lt;</span><span style="color:#F97583;">TopicPartition</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Long</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">currentOffset</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CustomSaveOffset</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">TopicPartition</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Long</span><span style="color:#24292E;">&gt; currentOffset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 创建配置信息</span></span>
<span class="line"><span style="color:#24292E;">		Properties props </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Properties</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">		...</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">//&lt;--------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 关闭自动提交 offset</span></span>
<span class="line"><span style="color:#24292E;">		props.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;enable.auto.commit&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;false&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">		...</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 创建一个消费者</span></span>
<span class="line"><span style="color:#24292E;">		KafkaConsumer&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; consumer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> KafkaConsumer&lt;&gt;(props);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 消费者订阅主题</span></span>
<span class="line"><span style="color:#24292E;">		consumer.</span><span style="color:#6F42C1;">subscribe</span><span style="color:#24292E;">(Arrays.</span><span style="color:#6F42C1;">asList</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;first&quot;</span><span style="color:#24292E;">), </span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">//&lt;-------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConsumerRebalanceListener</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">// 该方法会在 Rebalance 之前调用</span></span>
<span class="line"><span style="color:#24292E;">			@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onPartitionsRevoked</span><span style="color:#24292E;">(Collection&lt;</span><span style="color:#D73A49;">TopicPartition</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">partitions</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">commitOffset</span><span style="color:#24292E;">(currentOffset);</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">// 该方法会在 Rebalance 之后调用</span></span>
<span class="line"><span style="color:#24292E;">			@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onPartitionsAssigned</span><span style="color:#24292E;">(Collection&lt;</span><span style="color:#D73A49;">TopicPartition</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">partitions</span><span style="color:#24292E;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">				currentOffset.</span><span style="color:#6F42C1;">clear</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (TopicPartition partition </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> partitions) {</span></span>
<span class="line"><span style="color:#24292E;">					consumer.</span><span style="color:#6F42C1;">seek</span><span style="color:#24292E;">(partition, </span><span style="color:#6F42C1;">getOffset</span><span style="color:#24292E;">(partition));</span><span style="color:#6A737D;">// 定位到最近提交的 offset 位置继续消费</span></span>
<span class="line"><span style="color:#24292E;">				}</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">		});</span></span>
<span class="line"><span style="color:#24292E;">		</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">			ConsumerRecords&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; records </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> consumer.</span><span style="color:#6F42C1;">poll</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">);</span><span style="color:#6A737D;">// 消费者拉取数据</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (ConsumerRecord&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; record </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> records) {</span></span>
<span class="line"><span style="color:#24292E;">				System.out.</span><span style="color:#6F42C1;">printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span style="color:#24292E;">, record.</span><span style="color:#6F42C1;">offset</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">key</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">				currentOffset.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TopicPartition</span><span style="color:#24292E;">(record.</span><span style="color:#6F42C1;">topic</span><span style="color:#24292E;">(), record.</span><span style="color:#6F42C1;">partition</span><span style="color:#24292E;">()), record.</span><span style="color:#6F42C1;">offset</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6F42C1;">commitOffset</span><span style="color:#24292E;">(currentOffset);</span><span style="color:#6A737D;">// 异步提交</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 获取某分区的最新 offset</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getOffset</span><span style="color:#24292E;">(TopicPartition </span><span style="color:#E36209;">partition</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 提交该消费者所有分区的 offset</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">commitOffset</span><span style="color:#24292E;">(Map&lt;</span><span style="color:#D73A49;">TopicPartition</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Long</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">currentOffset</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><br><h2 id="springboot-集成" tabindex="-1">SpringBoot 集成 <a class="header-anchor" href="#springboot-集成" aria-label="Permalink to &quot;SpringBoot 集成&quot;">​</a></h2><p><strong>依赖</strong></p><div class="language-xml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;org.springframework.kafka&lt;/</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;spring-kafka&lt;/</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;org.springframework.kafka&lt;/</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;spring-kafka&lt;/</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>生产者配置</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">spring</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kafka</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">producer</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">client-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">boot-kafka-producer</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bootstrap-servers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># key-serializer: 默认使用 StringSerializer.class</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># value-serializer: 默认使用 StringSerializer.class</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">acks</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">-1</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">retries</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">spring</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kafka</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">producer</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">client-id</span><span style="color:#24292E;">: </span><span style="color:#032F62;">boot-kafka-producer</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bootstrap-servers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># key-serializer: 默认使用 StringSerializer.class</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># value-serializer: 默认使用 StringSerializer.class</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">acks</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">-1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">retries</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>消费者配置</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">spring</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kafka</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consumer</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">group-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;group-test&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bootstrap-servers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localhost:9092</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">client-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">boot-kafka-consumer</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">auto-offset-reset</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">earliest</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">auto-commit-interval</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">enable-auto-commit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># key-deserializer: 默认 StringDeserializer.class;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># value-deserializer:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">spring</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kafka</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consumer</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">group-id</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;group-test&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bootstrap-servers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localhost:9092</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">client-id</span><span style="color:#24292E;">: </span><span style="color:#032F62;">boot-kafka-consumer</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">auto-offset-reset</span><span style="color:#24292E;">: </span><span style="color:#032F62;">earliest</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">auto-commit-interval</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">enable-auto-commit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># key-deserializer: 默认 StringDeserializer.class;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># value-deserializer:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>生产者实现</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">RestController</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">KafkaProducerMain</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        SpringApplication.</span><span style="color:#B392F0;">run</span><span style="color:#E1E4E8;">(KafkaProducerMain.class, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Autowired</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> KafkaTemplate&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; kafka;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">GetMapping</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/send/{data}&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">PathVariable</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;data&quot;</span><span style="color:#E1E4E8;">) String </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        kafka.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;topic-test&quot;</span><span style="color:#E1E4E8;">, data);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;send &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; success&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">SpringBootApplication</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RestController</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">KafkaProducerMain</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        SpringApplication.</span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">(KafkaProducerMain.class, args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> KafkaTemplate&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; kafka;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">GetMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/send/{data}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">PathVariable</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;data&quot;</span><span style="color:#24292E;">) String </span><span style="color:#E36209;">data</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        kafka.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;topic-test&quot;</span><span style="color:#24292E;">, data);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;send &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> data </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; success&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>消费者实现</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">KafkaConsumerMain</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        SpringApplication.</span><span style="color:#B392F0;">run</span><span style="color:#E1E4E8;">(KafkaConsumerMain.class, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">KafkaListener</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">topics</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span><span style="color:#9ECBFF;">&quot;topic-test&quot;</span><span style="color:#E1E4E8;">}, </span><span style="color:#79B8FF;">groupId</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;group-test&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">receive</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;[received] &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> message);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">SpringBootApplication</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">KafkaConsumerMain</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        SpringApplication.</span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">(KafkaConsumerMain.class, args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">KafkaListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">topics</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&quot;topic-test&quot;</span><span style="color:#24292E;">}, </span><span style="color:#005CC5;">groupId</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;group-test&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receive</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">message</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;[received] &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><br><h2 id="图形界面" tabindex="-1">图形界面 <a class="header-anchor" href="#图形界面" aria-label="Permalink to &quot;图形界面&quot;">​</a></h2><blockquote><p>Kafka Eagle 略</p></blockquote><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">docker pull nickzurich/kafka-eagle:latest</span></span>
<span class="line"><span style="color:#e1e4e8;">docker run --name eagle -p 8048:8048 -e EFAK_CLUSTER_ZK_LIST=localhost:2181 -d nickzurich/kafka-eagle:latest</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">docker pull nickzurich/kafka-eagle:latest</span></span>
<span class="line"><span style="color:#24292e;">docker run --name eagle -p 8048:8048 -e EFAK_CLUSTER_ZK_LIST=localhost:2181 -d nickzurich/kafka-eagle:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><p><a href="https://my.oschina.net/jallenkwong/blog/4449224" target="_blank" rel="noreferrer">Kafka学习笔记</a></p><p><a href="https://mp.weixin.qq.com/s/QIK1N-ePm6DQE4tMQ9N3Gw" target="_blank" rel="noreferrer">Kafka为什么吞吐量大、速度快？</a></p><p><a href="https://cloud.tencent.com/developer/article/1804041" target="_blank" rel="noreferrer">Kafka 提供哪些日志清理策略？</a></p></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><!----><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/posts/mw/elasticsearch/Elasticsearch" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Previous</span><span class="title" data-v-ef5dee53>Elasticsearch</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/posts/mw/nginx/Nginx" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next</span><span class="title" data-v-ef5dee53>Nginx</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5a346dfe data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Power by Vitepress & Github Page</p><p class="copyright" data-v-e03eb2e1>Copyright © 2021-present GnL</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"posts_be_java_java-advance_java-进阶.md\":\"42abd51d\",\"posts_al_常见算法.md\":\"9bc8df87\",\"about.md\":\"a162070c\",\"posts_al_位运算.md\":\"5ecf9586\",\"posts_dp_index_index.md\":\"86e10ddd\",\"posts_dpl_index_index.md\":\"564bcd34\",\"posts_al_index_index.md\":\"5ef2f242\",\"posts_db_redis_redis.md\":\"83ebd6d8\",\"posts_be_java_jvm_jvm.md\":\"2ba04d00\",\"posts_be_java_java-collection_java-集合.md\":\"c313d7a9\",\"posts_fe_typescript_typescript.md\":\"cf218c1e\",\"index.md\":\"5976cc20\",\"posts_be_springmvc_springmvc.md\":\"129d7912\",\"posts_mw_index_index.md\":\"a194d817\",\"posts_db_mysql_mysql.md\":\"db6ed566\",\"posts_be_springsecurity_springsecurity.md\":\"78670d02\",\"posts_mw_elasticsearch_elasticsearch.md\":\"b66d3004\",\"recently.md\":\"4b0fcd1d\",\"posts_be_springcloud_springcloud.md\":\"95bfcc3d\",\"posts_be_java_io_java-io.md\":\"eb84996f\",\"posts_db_index_index.md\":\"2a58eedb\",\"posts_be_index_index.md\":\"2848fce1\",\"posts_be_dubbo_dubbo.md\":\"c4c4060c\",\"posts_be_java_java-basic_java-基础.md\":\"ea4ad302\",\"posts_be_java_index_java.md\":\"56198839\",\"posts_renew_spring_spring.md\":\"95e99988\",\"posts_be_spring_spring5.md\":\"c6b3eb7f\",\"posts_be_mybatis_mybatis.md\":\"d32e69e5\",\"posts_be_java_java-threadpool_java-线程池.md\":\"f6d25920\",\"posts_fe_vuejs_vuejs.md\":\"dff77e28\",\"posts_be_java_java-thread_java-多线程.md\":\"95811c4b\",\"posts_mw_kafka_kafka.md\":\"f4f60b5d\",\"posts_dp_设计模式.md\":\"e515ad08\",\"posts_mw_rocketmq_rocketmq.md\":\"b62cd2a5\",\"posts_renew_mysql_mysql.md\":\"8d44b32f\",\"posts_renew_redis_redis-数据类型.md\":\"16cbe99d\",\"posts_renew_redis_redis-配置详解.md\":\"9e22e5f6\",\"posts_dpl_nginx_nginx.md\":\"e5a33acd\",\"posts_fe_index_index.md\":\"9b5e1b9e\",\"posts_be_java_java-juc_java-juc.md\":\"13e136cd\",\"posts_fe_react_react.md\":\"47e06a33\",\"posts_be_springboot_springboot.md\":\"fdd2c0dc\",\"posts_fe_javascript_javascript.md\":\"db17f093\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Gnl\",\"description\":\"A VitePress site\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"./logo.jpeg\",\"nav\":[{\"text\":\"Recently\",\"link\":\"/recently\"},{\"text\":\"算法\",\"link\":\"posts/al/index/\"},{\"text\":\"前端\",\"items\":[{\"text\":\"JavaScript\",\"link\":\"/posts/fe/javascript/JavaScript\"},{\"text\":\"Vue.js\",\"link\":\"/posts/fe/vuejs/Vuejs\"},{\"text\":\"React\",\"link\":\"/posts/fe/react/React\"},{\"text\":\"TypeScript\",\"link\":\"/posts/fe/typescript/TypeScript\"}]},{\"text\":\"后端\",\"items\":[{\"text\":\"Java\",\"link\":\"/posts/be/java/index/Java\"},{\"text\":\"Spring5\",\"link\":\"/posts/be/spring/Spring5\"},{\"text\":\"Spring MVC\",\"link\":\"/posts/be/springmvc/SpringMVC\"},{\"text\":\"Spring Boot\",\"link\":\"/posts/be/springboot/SpringBoot\"},{\"text\":\"Spring Security\",\"link\":\"/posts/be/springsecurity/SpringSecurity\"},{\"text\":\"Spring Cloud\",\"link\":\"/posts/be/springcloud/SpringCloud\"},{\"text\":\"MyBatis\",\"link\":\"/posts/be/mybatis/MyBatis\"}]},{\"text\":\"数据库\",\"items\":[{\"text\":\"MySQL\",\"link\":\"/posts/db/mysql/MySQL\"},{\"text\":\"Redis\",\"link\":\"/posts/db/redis/Redis\"}]},{\"text\":\"中间件\",\"items\":[{\"text\":\"RocketMQ\",\"link\":\"/posts/mw/rocketmq/RocketMQ\"},{\"text\":\"Elasticsearch\",\"link\":\"/posts/mw/elasticsearch/Elasticsearch\"},{\"text\":\"Kafka\",\"link\":\"/posts/mw/kafka/Kafka\"},{\"text\":\"Nginx\",\"link\":\"/posts/mw/nginx/Nginx\"}]}],\"sidebar\":[{\"text\":\"算法\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/al/index/\"},{\"text\":\"位运算\",\"link\":\"/posts/al/位运算\"},{\"text\":\"常见算法\",\"link\":\"/posts/al/常见算法\"}]},{\"text\":\"设计模式\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/dp/index/\"},{\"text\":\"设计模式\",\"link\":\"/posts/dp/设计模式\"}]},{\"text\":\"前端\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/fe/index/\"},{\"text\":\"JavaScript\",\"link\":\"/posts/fe/javascript/JavaScript\"},{\"text\":\"Vue.js\",\"link\":\"/posts/fe/vuejs/Vuejs\"},{\"text\":\"React\",\"link\":\"/posts/fe/react/React\"},{\"text\":\"TypeScript\",\"link\":\"/posts/fe/typescript/TypeScript\"}]},{\"text\":\"后端\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/be/index/\"},{\"text\":\"Java\",\"link\":\"/posts/be/java/index/Java\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Java 基础\",\"link\":\"/posts/be/java/java-basic/Java-基础\"},{\"text\":\"Java 集合\",\"link\":\"/posts/be/java/java-collection/Java-集合\"},{\"text\":\"Java 多线程\",\"link\":\"/posts/be/java/java-thread/Java-多线程\"},{\"text\":\"Java 线程池\",\"link\":\"/posts/be/java/java-threadpool/Java-线程池\"},{\"text\":\"Java JUC\",\"link\":\"/posts/be/java/java-juc/Java-JUC\"},{\"text\":\"Java IO\",\"link\":\"/posts/be/java/io/Java-IO\"},{\"text\":\"Java 进阶\",\"link\":\"/posts/be/java/java-advance/Java-进阶\"}]},{\"text\":\"JVM\",\"link\":\"/posts/be/java/jvm/JVM\"},{\"text\":\"Spring5\",\"link\":\"/posts/be/spring/Spring5\"},{\"text\":\"Spring MVC\",\"link\":\"/posts/be/springmvc/SpringMVC\"},{\"text\":\"Spring Boot\",\"link\":\"/posts/be/springboot/SpringBoot\"},{\"text\":\"Spring Security\",\"link\":\"/posts/be/springsecurity/SpringSecurity\"},{\"text\":\"Spring Cloud\",\"link\":\"/posts/be/springcloud/SpringCloud\"},{\"text\":\"MyBatis\",\"link\":\"/posts/be/mybatis/MyBatis\"}]},{\"text\":\"数据库\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/db/index/\"},{\"text\":\"MySQL\",\"link\":\"/posts/db/mysql/MySQL\"},{\"text\":\"Redis\",\"link\":\"/posts/db/redis/Redis\"}]},{\"text\":\"中间件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"Guide\",\"link\":\"/posts/mw/index/\"},{\"text\":\"RocketMQ\",\"link\":\"/posts/mw/rocketmq/RocketMQ\"},{\"text\":\"Elasticsearch\",\"link\":\"/posts/mw/elasticsearch/Elasticsearch\"},{\"text\":\"Kafka\",\"link\":\"/posts/mw/kafka/Kafka\"},{\"text\":\"Nginx\",\"link\":\"/posts/mw/nginx/Nginx\"}]}],\"docFooter\":{\"prev\":\"Previous\",\"next\":\"Next\"},\"footer\":{\"message\":\"Power by Vitepress & Github Page\",\"copyright\":\"Copyright © 2021-present GnL\"}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":true}");</script>
    
  </body>
</html>